(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?module.exports=e():typeof define==="function"&&define.amd?define(e):t.ASS=e()})(this,function(){"use strict";function t(t){var e=t.toLowerCase().trim().split(/\s*;\s*/);if(e[0]==="banner"){return{name:e[0],delay:e[1]*1||0,leftToRight:e[2]*1||0,fadeAwayWidth:e[3]*1||0}}if(/^scroll\s/.test(e[0])){return{name:e[0],y1:Math.min(e[1]*1,e[2]*1),y2:Math.max(e[1]*1,e[2]*1),delay:e[3]*1||0,fadeAwayHeight:e[4]*1||0}}return null}function e(t){return t.toLowerCase().replace(/([mnlbspc])/g," $1 ").trim().replace(/\s+/g," ").split(/\s(?=[mnlbspc])/).map(function(t){return t.split(" ")})}var a=["b","i","u","s","fsp","k","K","kf","ko","kt","fe","q","p","pbo","a","an","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];var r=a.map(function(t){return{name:t,regex:new RegExp("^"+t+"-?\\d")}});function i(t){var a={};for(var n=0;n<r.length;n++){var s=r[n];var o=s.name;var l=s.regex;if(l.test(t)){a[o]=t.slice(o.length)*1;return a}}if(/^fn/.test(t)){a.fn=t.slice(2)}else if(/^r/.test(t)){a.r=t.slice(1)}else if(/^fs[\d+-]/.test(t)){a.fs=t.slice(2)}else if(/^\d?c&?H?[0-9a-f]+|^\d?c$/i.test(t)){var f=t.match(/^(\d?)c&?H?(\w*)/);var v=f[1];var h=f[2];a["c"+(v||1)]=h&&("000000"+h).slice(-6)}else if(/^\da&?H?[0-9a-f]+/i.test(t)){var c=t.match(/^(\d)a&?H?(\w\w)/);var d=c[1];var p=c[2];a["a"+d]=p}else if(/^alpha&?H?[0-9a-f]+/i.test(t)){var u;u=t.match(/^alpha&?H?([0-9a-f]+)/i),a.alpha=u[1];a.alpha=("00"+a.alpha).slice(-2)}else if(/^(?:pos|org|move|fad|fade)\(/.test(t)){var g=t.match(/^(\w+)\((.*?)\)?$/);var m=g[1];var y=g[2];a[m]=y.trim().split(/\s*,\s*/).map(Number)}else if(/^i?clip/.test(t)){var x=t.match(/^i?clip\((.*?)\)?$/)[1].trim().split(/\s*,\s*/);a.clip={inverse:/iclip/.test(t),scale:1,drawing:null,dots:null};if(x.length===1){a.clip.drawing=e(x[0])}if(x.length===2){a.clip.scale=x[0]*1;a.clip.drawing=e(x[1])}if(x.length===4){a.clip.dots=x.map(Number)}}else if(/^t\(/.test(t)){var w=t.match(/^t\((.*?)\)?$/)[1].trim().replace(/\\.*/,function(t){return t.replace(/,/g,"\n")}).split(/\s*,\s*/);if(!w[0]){return a}a.t={t1:0,t2:0,accel:1,tags:w[w.length-1].replace(/\n/g,",").split("\\").slice(1).map(i)};if(w.length===2){a.t.accel=w[0]*1}if(w.length===3){a.t.t1=w[0]*1;a.t.t2=w[1]*1}if(w.length===4){a.t.t1=w[0]*1;a.t.t2=w[1]*1;a.t.accel=w[2]*1}}return a}function n(t){var e=[];var a=0;var r="";for(var n=0;n<t.length;n++){var s=t[n];if(s==="("){a++}if(s===")"){a--}if(a<0){a=0}if(!a&&s==="\\"){if(r){e.push(r)}r=""}else{r+=s}}e.push(r);return e.map(i)}function s(t){var a=t.split(/{([^{}]*?)}/);var r=[];if(a[0].length){r.push({tags:[],text:a[0],drawing:[]})}for(var i=1;i<a.length;i+=2){var s=n(a[i]);var o=s.reduce(function(t,e){return e.p===undefined?t:!!e.p},false);r.push({tags:s,text:o?"":a[i+1],drawing:o?e(a[i+1]):[]})}return{raw:t,combined:r.map(function(t){return t.text}).join(""),parsed:r}}function o(t){var e=t.split(":");return e[0]*3600+e[1]*60+e[2]*1}function l(e,a){var r=e.split(",");if(r.length>a.length){var i=r.slice(a.length-1).join();r=r.slice(0,a.length-1);r.push(i)}var n={};for(var l=0;l<r.length;l++){var f=a[l];var v=r[l].trim();switch(f){case"Layer":case"MarginL":case"MarginR":case"MarginV":n[f]=v*1;break;case"Start":case"End":n[f]=o(v);break;case"Effect":n[f]=t(v);break;case"Text":n[f]=s(v);break;default:n[f]=v}}return n}function f(t){return t.match(/Format\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function v(t){return t.match(/Style\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function h(t){var e={info:{},styles:{format:[],style:[]},events:{format:[],comment:[],dialogue:[]}};var a=t.split(/\r?\n/);var r=0;for(var i=0;i<a.length;i++){var n=a[i].trim();if(/^;/.test(n)){continue}if(/^\[Script Info\]/i.test(n)){r=1}else if(/^\[V4\+? Styles\]/i.test(n)){r=2}else if(/^\[Events\]/i.test(n)){r=3}else if(/^\[.*\]/.test(n)){r=0}if(r===0){continue}if(r===1){if(/:/.test(n)){var s=n.match(/(.*?)\s*:\s*(.*)/);var o=s[1];var h=s[2];e.info[o]=h}}if(r===2){if(/^Format\s*:/i.test(n)){e.styles.format=f(n)}if(/^Style\s*:/i.test(n)){e.styles.style.push(v(n))}}if(r===3){if(/^Format\s*:/i.test(n)){e.events.format=f(n)}if(/^(?:Comment|Dialogue)\s*:/i.test(n)){var c=n.match(/^(\w+?)\s*:\s*(.*)/i);var d=c[1];var p=c[2];e.events[d.toLowerCase()].push(l(p,e.events.format))}}}return e}var c=Object.assign||function t(e){var a=[],r=arguments.length-1;while(r-- >0)a[r]=arguments[r+1];for(var i=0;i<a.length;i++){if(!a[i]){continue}var n=Object.keys(a[i]);for(var s=0;s<n.length;s++){e[n[s]]=a[i][n[s]]}}return e};function d(t){var e={type:null,prev:null,next:null,points:[]};if(/[mnlbs]/.test(t[0])){e.type=t[0].toUpperCase().replace("N","L").replace("B","C")}for(var a=t.length-!(t.length&1),r=1;r<a;r+=2){e.points.push({x:t[r]*1,y:t[r+1]*1})}return e}function p(t){if(!t.points.length||!t.type){return false}if(/C|S/.test(t.type)&&t.points.length<3){return false}return true}function u(t){var e=Infinity;var a=Infinity;var r=-Infinity;var i=-Infinity;(n=[]).concat.apply(n,t.map(function(t){var e=t.points;return e})).forEach(function(t){var n=t.x;var s=t.y;e=Math.min(e,n);a=Math.min(a,s);r=Math.max(r,n);i=Math.max(i,s)});return{minX:e,minY:a,width:r-e,height:i-a};var n}function g(t,e,a){var r=[];var i=[0,2/3,1/3,0];var n=[0,1/3,2/3,0];var s=[0,1/6,2/3,1/6];var o=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]};var l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x];var f=[t[t.length-1].y,t[0].y,t[1].y,t[2].y];r.push({type:e==="M"?"M":"L",points:[{x:o(s,l),y:o(s,f)}]});for(var v=3;v<t.length;v++){l=[t[v-3].x,t[v-2].x,t[v-1].x,t[v].x];f=[t[v-3].y,t[v-2].y,t[v-1].y,t[v].y];r.push({type:"C",points:[{x:o(i,l),y:o(i,f)},{x:o(n,l),y:o(n,f)},{x:o(s,l),y:o(s,f)}]})}if(a==="L"||a==="C"){var h=t[t.length-1];r.push({type:"L",points:[{x:h.x,y:h.y}]})}return r}function m(t){return t.map(function(t){var e=t.type;var a=t.points;return e+a.map(function(t){var e=t.x;var a=t.y;return e+","+a}).join(",")}).join("")}function y(t){var e=[];var a=0;while(a<t.length){var r=t[a];var i=d(r);if(i.type){if(i.type==="S"){var n=e[a-1].points.slice(-1)[0];var s=n.x;var o=n.y;i.points.unshift({x:s,y:o})}if(p(i)){if(a){i.prev=e[a-1].type;e[a-1].next=i.type}e.push(i)}a++}else{if(e[a-1].type==="S"){var l={p:i.points,c:e[a-1].points.slice(0,3)};e[a-1].points=e[a-1].points.concat((l[r[0]]||[]).map(function(t){var e=t.x;var a=t.y;return{x:e,y:a}}))}t.splice(a,1)}}var f=(v=[]).concat.apply(v,e.map(function(t){var e=t.type;var a=t.points;var r=t.prev;var i=t.next;return e==="S"?g(a,r,i):{type:e,points:a}}));return c({instructions:f,d:m(f)},u(e));var v}var x=["fs","clip","c1","c2","c3","c4","a1","a2","a3","a4","alpha","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function w(t,e,a){var r,i,n;if(a===void 0)a={};var s=t[e];if(s===undefined){return null}if(e==="pos"||e==="org"){return s.length===2?(r={},r[e]={x:s[0],y:s[1]},r):null}if(e==="move"){var o=s[0];var l=s[1];var f=s[2];var v=s[3];var h=s[4];if(h===void 0)h=0;var d=s[5];if(d===void 0)d=0;return s.length===4||s.length===6?{move:{x1:o,y1:l,x2:f,y2:v,t1:h,t2:d}}:null}if(e==="fad"||e==="fade"){if(s.length===2){var p=s[0];var u=s[1];return{fade:{type:"fad",t1:p,t2:u}}}if(s.length===7){var g=s[0];var m=s[1];var b=s[2];var S=s[3];var _=s[4];var C=s[5];var $=s[6];return{fade:{type:"fade",a1:g,a2:m,a3:b,t1:S,t2:_,t3:C,t4:$}}}return null}if(e==="clip"){var A=s.inverse;var M=s.scale;var k=s.drawing;var N=s.dots;if(k){return{clip:{inverse:A,scale:M,drawing:y(k),dots:N}}}if(N){var T=N[0];var E=N[1];var F=N[2];var j=N[3];return{clip:{inverse:A,scale:M,drawing:k,dots:{x1:T,y1:E,x2:F,y2:j}}}}return null}if(/^[xy]?(bord|shad)$/.test(e)){s=Math.max(s,0)}if(e==="bord"){return{xbord:s,ybord:s}}if(e==="shad"){return{xshad:s,yshad:s}}if(/^c\d$/.test(e)){return i={},i[e]=s||a[e],i}if(e==="alpha"){return{a1:s,a2:s,a3:s,a4:s}}if(e==="fr"){return{frz:s}}if(e==="fs"){return{fs:/^\+|-/.test(s)?(s*1>-10?1+s/10:1)*a.fs:s*1}}if(e==="t"){var L=s.t1;var B=s.accel;var O=s.tags;var z=s.t2||(a.end-a.start)*1e3;var R={};O.forEach(function(t){var e=Object.keys(t)[0];if(~x.indexOf(e)&&!(e==="clip"&&!t[e].dots)){c(R,w(t,e,a))}});return{t:{t1:L,t2:z,accel:B,tag:R}}}return n={},n[e]=s,n}var b=[null,1,2,3,null,7,8,9,null,4,5,6];var S=["r","a","an","pos","org","move","fade","fad","clip"];function _(t,e){return{name:t,borderStyle:e[t].style.BorderStyle,tag:e[t].tag,fragments:[]}}function C(t){var e=t.styles;var a=t.name;var r=t.parsed;var i=t.start;var n=t.end;var s;var o;var l;var f;var v;var h;var d=[];var p=_(a,e);var u={};for(var g=0;g<r.length;g++){var m=r[g];var x=m.tags;var C=m.text;var $=m.drawing;var A=void 0;for(var M=0;M<x.length;M++){var k=x[M];A=k.r===undefined?A:k.r}var N={tag:A===undefined?JSON.parse(JSON.stringify(u)):{},text:C,drawing:$.length?y($):null};for(var T=0;T<x.length;T++){var E=x[T];s=s||b[E.a||0]||E.an;o=o||w(E,"pos");l=l||w(E,"org");f=f||w(E,"move");v=v||w(E,"fade")||w(E,"fad");h=w(E,"clip")||h;var F=Object.keys(E)[0];if(F&&!~S.indexOf(F)){var j=p.tag;var L=j.c1;var B=j.c2;var O=j.c3;var z=j.c4;var R=u.fs||p.tag.fs;var H=w(E,F,{start:i,end:n,c1:L,c2:B,c3:O,c4:z,fs:R});if(F==="t"){N.tag.t=N.tag.t||[];N.tag.t.push(H.t)}else{c(N.tag,H)}}}u=N.tag;if(A!==undefined){d.push(p);p=_(e[A]?A:a,e)}if(N.text||N.drawing){var I=p.fragments[p.fragments.length-1]||{};if(I.text&&N.text&&!Object.keys(N.tag).length){I.text+=N.text}else{p.fragments.push(N)}}}d.push(p);return c({alignment:s,slices:d},o,l,f,v,h)}function $(t){var e=t.info;var a=t.styles;var r=t.dialogues;var i=Infinity;var n=[];for(var s=0;s<r.length;s++){var o=r[s];if(o.Start>=o.End){continue}if(!a[o.Style]){o.Style="Default"}var l=a[o.Style].style;var f=e.Timer/100||1;var v=C({styles:a,name:o.Style,parsed:o.Text.parsed,start:o.Start,end:o.End});var h=v.alignment||l.Alignment;i=Math.min(i,o.Layer);n.push(c({layer:o.Layer,start:o.Start/f,end:o.End/f,margin:{left:o.MarginL||l.MarginL,right:o.MarginR||l.MarginR,vertical:o.MarginV||l.MarginV},effect:o.Effect},v,{alignment:h}))}for(var d=0;d<n.length;d++){n[d].layer-=i}return n.sort(function(t,e){return t.start-e.start||t.end-e.end})}var A={Name:"Default",Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF&",SecondaryColour:"&H000000FF&",OutlineColour:"&H00000000&",BackColour:"&H00000000&",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2",Alignment:"2",MarginL:"10",MarginR:"10",MarginV:"10",Encoding:"1"};function M(t){var e=t.match(/&H(\w\w)?(\w{6})&?/);var a=e[1];var r=e[2];return[a||"00",r]}function k(t){var e=t.info;var a=t.style;var r=t.format;var i=t.defaultStyle;var n={};var s=[c({},A,i,{Name:"Default"})].concat(a.map(function(t){var e={};for(var a=0;a<r.length;a++){e[r[a]]=t[a]}return e}));var o=function(t){var a=s[t];if(/^(\*+)Default$/.test(a.Name)){a.Name="Default"}Object.keys(a).forEach(function(t){if(t!=="Name"&&t!=="Fontname"&&!/Colour/.test(t)){a[t]*=1}});var r=M(a.PrimaryColour);var i=r[0];var o=r[1];var l=M(a.SecondaryColour);var f=l[0];var v=l[1];var h=M(a.OutlineColour);var c=h[0];var d=h[1];var p=M(a.BackColour);var u=p[0];var g=p[1];var m={fn:a.Fontname,fs:a.Fontsize,c1:o,a1:i,c2:v,a2:f,c3:d,a3:c,c4:g,a4:u,b:Math.abs(a.Bold),i:Math.abs(a.Italic),u:Math.abs(a.Underline),s:Math.abs(a.StrikeOut),fscx:a.ScaleX,fscy:a.ScaleY,fsp:a.Spacing,frz:a.Angle,xbord:a.Outline,ybord:a.Outline,xshad:a.Shadow,yshad:a.Shadow,q:/^[0-3]$/.test(e.WrapStyle)?e.WrapStyle*1:2};n[a.Name]={style:a,tag:m}};for(var l=0;l<s.length;l++)o(l);return n}function N(t,e){if(e===void 0)e={};var a=h(t);var r=k({info:a.info,style:a.styles.style,format:a.styles.format,defaultStyle:e.defaultStyle||{}});return{info:a.info,width:a.info.PlayResX*1||null,height:a.info.PlayResY*1||null,collisions:a.info.Collisions||"Normal",styles:r,dialogues:$({info:a.info,styles:r,dialogues:a.events.dialogue})}}var T=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)};var E=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function F(t){var e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/);var a=1-("0x"+e[1])/255;var r=+("0x"+e[2]);var i=+("0x"+e[3]);var n=+("0x"+e[4]);return"rgba("+n+","+i+","+r+","+a+")"}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0;var a=t==="x"?e:e&3|8;return a.toString(16)})}function L(t,e){if(e===void 0)e=[];var a=document.createElementNS("http://www.w3.org/2000/svg",t);for(var r=0;r<e.length;r++){var i=e[r];a.setAttributeNS(i[0]==="xlink:href"?"http://www.w3.org/1999/xlink":null,i[0],i[1])}return a}function B(t){var e=document.body;var a=e.style;var r=t.replace(/^\w/,function(t){return t.toUpperCase()});if(t in a){return""}if("webkit"+r in a){return"-webkit-"}if("moz"+r in a){return"-moz-"}return""}var O={transform:B("transform"),animation:B("animation"),clipPath:B("clipPath")};var z=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur","be"];var R=["fscx","fscy","frx","fry","frz","fax","fay"];function H(t){var e=this._.scriptRes.width;var a=this._.scriptRes.height;var r="";if(t.dots!==null){var i=t.dots;var n=i.x1;var s=i.y1;var o=i.x2;var l=i.y2;n/=e;s/=a;o/=e;l/=a;r="M"+n+","+s+"L"+n+","+l+","+o+","+l+","+o+","+s+"Z"}if(t.drawing!==null){r=t.drawing.instructions.map(function(t){var r=t.type;var i=t.points;return r+i.map(function(t){var r=t.x;var i=t.y;return r/e+","+i/a}).join(",")}).join("")}var f=1/(1<<t.scale-1);if(t.inverse){r+="M0,0L0,"+f+","+f+","+f+","+f+",0,0,0Z"}var v="ASS-"+j();var h=L("clipPath",[["id",v],["clipPathUnits","objectBoundingBox"]]);h.appendChild(L("path",[["d",r],["transform","scale("+f+")"],["clip-rule","evenodd"]]));this._.$defs.appendChild(h);return{$clipPath:h,cssText:O.clipPath+"clip-path:url(#"+v+");"}}function I(t){if(!t.clip){return}var e=document.createElement("div");this._.$stage.insertBefore(e,t.$div);e.appendChild(t.$div);e.className="ASS-fix-objectBoundingBox";var a=H.call(this,t.clip);var r=a.cssText;var i=a.$clipPath;this._.$defs.appendChild(i);e.style.cssText=r;c(t,{$div:e,$clipPath:i})}var P=document.createElement("div");P.className="ASS-fix-font-size";P.textContent="M";var q=Object.create(null);function U(t,e){var a=t+"-"+e;if(!q[a]){P.style.cssText="font-size:"+e+'px;font-family:"'+t+'",Arial;';q[a]=e*e/P.clientHeight}return q[a]}function Y(t,e,a){var r=t.xbord||t.ybord;var i=t.xshad||t.yshad;var n=t.a1!=="FF";var s=t.blur||t.be||0;var o=L("filter",[["id",e]]);o.appendChild(L("feGaussianBlur",[["stdDeviation",r?0:s],["in","SourceGraphic"],["result","sg_b"]]));o.appendChild(L("feFlood",[["flood-color",F(t.a1+t.c1)],["result","c1"]]));o.appendChild(L("feComposite",[["operator","in"],["in","c1"],["in2","sg_b"],["result","main"]]));if(r){o.appendChild(L("feMorphology",[["radius",t.xbord*a+" "+t.ybord*a],["operator","dilate"],["in","SourceGraphic"],["result","dil"]]));o.appendChild(L("feGaussianBlur",[["stdDeviation",s],["in","dil"],["result","dil_b"]]));o.appendChild(L("feComposite",[["operator","out"],["in","dil_b"],["in2","SourceGraphic"],["result","dil_b_o"]]));o.appendChild(L("feFlood",[["flood-color",F(t.a3+t.c3)],["result","c3"]]));o.appendChild(L("feComposite",[["operator","in"],["in","c3"],["in2","dil_b_o"],["result","border"]]))}if(i&&(r||n)){o.appendChild(L("feOffset",[["dx",t.xshad*a],["dy",t.yshad*a],["in",r?"dil":"SourceGraphic"],["result","off"]]));o.appendChild(L("feGaussianBlur",[["stdDeviation",s],["in","off"],["result","off_b"]]));if(!n){o.appendChild(L("feOffset",[["dx",t.xshad*a],["dy",t.yshad*a],["in","SourceGraphic"],["result","sg_off"]]));o.appendChild(L("feComposite",[["operator","out"],["in","off_b"],["in2","sg_off"],["result","off_b_o"]]))}o.appendChild(L("feFlood",[["flood-color",F(t.a4+t.c4)],["result","c4"]]));o.appendChild(L("feComposite",[["operator","in"],["in","c4"],["in2",n?"off_b":"off_b_o"],["result","shadow"]]))}var l=L("feMerge",[]);if(i&&(r||n)){l.appendChild(L("feMergeNode",[["in","shadow"]]))}if(r){l.appendChild(L("feMergeNode",[["in","border"]]))}l.appendChild(L("feMergeNode",[["in","main"]]));o.appendChild(l);return o}function D(t,e){var a=[];var r=F(t.a3+t.c3);var i=t.xbord*e;var n=t.ybord*e;var s=F(t.a4+t.c4);var o=t.xshad*e;var l=t.yshad*e;var f=t.blur||t.be||0;if(!(i+n+o+l)){return"none"}if(i||n){for(var v=-1;v<=1;v++){for(var h=-1;h<=1;h++){for(var c=1;c<i;c++){for(var d=1;d<n;d++){if(v||h){a.push(r+" "+v*c+"px "+h*d+"px "+f+"px")}}}a.push(r+" "+v*i+"px "+h*n+"px "+f+"px")}}}if(o||l){var p=o>0?1:-1;var u=l>0?1:-1;o=Math.abs(o);l=Math.abs(l);for(var g=Math.max(i,o-i);g<o+i;g++){for(var m=Math.max(n,l-n);m<l+n;m++){a.push(s+" "+g*p+"px "+m*u+"px "+f+"px")}}a.push(s+" "+(o+i)*p+"px "+(l+n)*u+"px "+f+"px")}return a.join()}function G(t){return["perspective(314px)","rotateY("+(t.fry||0)+"deg)","rotateX("+(t.frx||0)+"deg)","rotateZ("+(-t.frz||0)+"deg)","scale("+(t.p?1:(t.fscx||100)/100)+","+(t.p?1:(t.fscy||100)/100)+")","skew("+(t.fax||0)+"rad,"+(t.fay||0)+"rad)"].join(" ")}function X(t){var e=t.alignment;var a=t.width;var r=t.height;var i=t.x;var n=t.y;var s=t.$div;var o=t.org;if(!o){o={x:0,y:0};if(e%3===1){o.x=i}if(e%3===2){o.x=i+a/2}if(e%3===0){o.x=i+a}if(e<=3){o.y=n+r}if(e>=4&&e<=6){o.y=n+r/2}if(e>=7){o.y=n}}for(var l=s.childNodes.length-1;l>=0;l--){var f=s.childNodes[l];if(f.dataset.hasRotate==="true"){var v=o.x-i-f.offsetLeft;var h=o.y-n-f.offsetTop;f.style.cssText+=O.transform+"transform-origin:"+v+"px "+h+"px;"}}}function V(t,e){return"@"+O.animation+"keyframes "+t+" {"+e+"}\n"}var W=function t(){this.obj={}};W.prototype.set=function t(e,a,r){if(!this.obj[e]){this.obj[e]={}}this.obj[e][a]=r};W.prototype.setT=function t(e){var a=e.t1;var r=e.t2;var i=e.duration;var n=e.prop;var s=e.from;var o=e.to;this.set("0.000%",n,s);if(a<i){this.set((a/i*100).toFixed(3)+"%",n,s)}if(r<i){this.set((r/i*100).toFixed(3)+"%",n,o)}this.set("100.000%",n,o)};W.prototype.toString=function t(){var e=this;return Object.keys(this.obj).map(function(t){return t+"{"+Object.keys(e.obj[t]).map(function(a){return""+(O[a]||"")+a+":"+e.obj[t][a]+";"}).join("")+"}"}).join("")};function J(t){return t.reduceRight(function(t,e){var a=false;return t.map(function(t){a=e.t1===t.t1&&e.t2===t.t2&&e.accel===t.accel;return c({},t,a?{tag:c({},t.tag,e.tag)}:{})}).concat(a?[]:e)},[])}function Z(){var t=this;var e="";this.dialogues.forEach(function(a){var r=a.start;var i=a.end;var n=a.effect;var s=a.move;var o=a.fade;var l=a.slices;var f=(i-r)*1e3;var v=new W;if(n&&!s){var h=n.name;var d=n.delay;var p=n.lefttoright;var u=n.y1;var g=n.y2||t._.resampledRes.height;if(h==="banner"){var m=t.scale*(f/d)*(p?1:-1);v.set("0.000%","transform","translateX(0)");v.set("100.000%","transform","translateX("+m+"px)")}if(/^scroll/.test(h)){var y=/up/.test(h)?-1:1;var x="translateY("+t.scale*u*y+"px)";var w="translateY("+t.scale*g*y+"px)";var b=(g-u)/(f/d)*100;v.set("0.000%","transform",x);if(b<100){v.set(b.toFixed(3)+"%","transform",w)}v.set("100.000%","transform",w)}}if(s){var S=s.x1;var _=s.y1;var C=s.x2;var $=s.y2;var A=s.t1;var M=s.t2||f;var k=a.pos||{x:0,y:0};var N=[{x:S,y:_},{x:C,y:$}].map(function(e){var a=e.x;var r=e.y;return"translate("+t.scale*(a-k.x)+"px, "+t.scale*(r-k.y)+"px)"});v.setT({t1:A,t2:M,duration:f,prop:"transform",from:N[0],to:N[1]})}if(o){if(o.type==="fad"){var T=o.t1;var E=o.t2;v.set("0.000%","opacity",0);if(T<f){v.set((T/f*100).toFixed(3)+"%","opacity",1);if(T+E<f){v.set(((f-E)/f*100).toFixed(3)+"%","opacity",1)}v.set("100.000%","opacity",0)}else{v.set("100.000%","opacity",f/T)}}else{var L=o.a1;var B=o.a2;var O=o.a3;var H=o.t1;var I=o.t2;var P=o.t3;var q=o.t4;var Y=[H,I,P,q].map(function(t){return(t/f*100).toFixed(3)+"%"});var X=[L,B,O].map(function(t){return 1-t/255});v.set("0.000%","opacity",X[0]);if(H<f){v.set(Y[0],"opacity",X[0])}if(I<f){v.set(Y[1],"opacity",X[1])}if(P<f){v.set(Y[2],"opacity",X[1])}if(q<f){v.set(Y[3],"opacity",X[2])}v.set("100.000%","opacity",X[2])}}var Z=v.toString();if(Z){c(a,{animationName:"ASS-"+j()});e+=V(a.animationName,Z)}l.forEach(function(a){a.fragments.forEach(function(r){if(!r.tag.t||!r.tag.t.length){return}var i=new W;var n=c({},a.tag,r.tag);J(r.tag.t).forEach(function(e){var s=e.t1;var o=e.t2;var l=e.tag;if(l.fs){var v=t.scale*U(n.fn,n.fs)+"px";var h=t.scale*U(l.fn,n.fs)+"px";i.setT({t1:s,t2:o,duration:f,prop:"font-size",from:v,to:h})}if(l.fsp){var d=t.scale*n.fsp+"px";var p=t.scale*l.fsp+"px";i.setT({t1:s,t2:o,duration:f,prop:"letter-spacing",from:d,to:p})}var u=l.a1!==undefined&&l.a1===l.a2&&l.a2===l.a3&&l.a3===l.a4;if(l.c1||l.a1&&!u){var g=F(n.a1+n.c1);var m=F((l.a1||n.a1)+(l.c1||n.c1));i.setT({t1:s,t2:o,duration:f,prop:"color",from:g,to:m})}if(u){var y=1-parseInt(n.a1,16)/255;var x=1-parseInt(l.a1,16)/255;i.setT({t1:s,t2:o,duration:f,prop:"opacity",from:y,to:x})}var w=z.some(function(t){return l[t]!==undefined&&l[t]!==(r.tag[t]||a.tag[t])});if(w){var b=/Yes/i.test(t.info.ScaledBorderAndShadow)?t.scale:1;var S=D(n,b);var _=D(c({},n,l),b);i.setT({t1:s,t2:o,duration:f,prop:"text-shadow",from:S,to:_})}var C=R.some(function(t){return l[t]!==undefined&&l[t]!==(r.tag[t]||a.tag[t])});if(C){var $=c({},n,l);if(r.drawing){c($,{p:0,fscx:(l.fscx||n.fscx)/n.fscx*100,fscy:(l.fscy||n.fscy)/n.fscy*100});c(n,{fscx:100,fscy:100})}var A=G(n);var M=G($);i.setT({t1:s,t2:o,duration:f,prop:"transform",from:A,to:M})}});var s=i.toString();c(r,{animationName:"ASS-"+j()});e+=V(r.animationName,s)})})});return e}function K(t,e,a){var r=O.animation;return r+"animation-name:"+t+";"+r+"animation-duration:"+e+"s;"+r+"animation-delay:"+a+"s;"+r+"animation-timing-function:linear;"+r+"animation-iteration-count:1;"+r+"animation-fill-mode:forwards;"}function Q(t,e){var a=c({},e,t.tag);var r=t.drawing;var i=r.minX;var n=r.minY;var s=r.width;var o=r.height;var l=this.scale/(1<<a.p-1);var f=(a.fscx?a.fscx/100:1)*l;var v=(a.fscy?a.fscy/100:1)*l;var h=a.blur||a.be||0;var d=a.xbord+(a.xshad<0?-a.xshad:0)+h;var p=a.ybord+(a.yshad<0?-a.yshad:0)+h;var u=s*f+2*a.xbord+Math.abs(a.xshad)+2*h;var g=o*v+2*a.ybord+Math.abs(a.yshad)+2*h;var m=L("svg",[["width",u],["height",g],["viewBox",-d+" "+-p+" "+u+" "+g]]);var y=/Yes/i.test(this.info.ScaledBorderAndShadow)?this.scale:1;var x="ASS-"+j();var w=L("defs");w.appendChild(Y(a,x,y));m.appendChild(w);var b="ASS-"+j();var S=L("symbol",[["id",b],["viewBox",i+" "+n+" "+s+" "+o]]);S.appendChild(L("path",[["d",t.drawing.d]]));m.appendChild(S);m.appendChild(L("use",[["width",s*f],["height",o*v],["xlink:href","#"+b],["filter","url(#"+x+")"]]));m.style.cssText="position:absolute;"+"left:"+(i*f-d)+"px;"+"top:"+(n*v-p)+"px;";return{$svg:m,cssText:"position:relative;width:"+s*f+"px;height:"+o*v+"px;"}}function tt(t,e){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\s/g,"&nbsp;").replace(/\\h/g,"&nbsp;").replace(/\\N/g,"<br>").replace(/\\n/g,e===2?"<br>":"&nbsp;")}function et(t){var e=this;var a=document.createElement("div");a.className="ASS-dialogue";var r=document.createDocumentFragment();var i=t.slices;var n=t.start;var s=t.end;i.forEach(function(t){var a=t.borderStyle;t.fragments.forEach(function(i){var o=i.text;var l=i.drawing;var f=i.animationName;var v=c({},t.tag,i.tag);var h="display:inline-block;";var d=e.video.currentTime;if(!l){h+='font-family:"'+v.fn+'",Arial;';h+="font-size:"+e.scale*U(v.fn,v.fs)+"px;";h+="color:"+F(v.a1+v.c1)+";";var p=/Yes/i.test(e.info.ScaledBorderAndShadow)?e.scale:1;if(a===1){h+="text-shadow:"+D(v,p)+";"}if(a===3){h+="background-color:"+F(v.a3+v.c3)+";"+"box-shadow:"+D(v,p)+";"}h+=v.b?"font-weight:"+(v.b===1?"bold":v.b)+";":"";h+=v.i?"font-style:italic;":"";h+=v.u||v.s?"text-decoration:"+(v.u?"underline":"")+" "+(v.s?"line-through":"")+";":"";h+=v.fsp?"letter-spacing:"+v.fsp+"px;":"";if(v.q===1||v.q===0||v.q===3){h+="word-break:break-all;white-space:normal;"}if(v.q===2){h+="word-break:normal;white-space:nowrap;"}}var u=R.some(function(t){return/^fsc[xy]$/.test(t)?v[t]!==100:!!v[t]});if(u){h+=O.transform+"transform:"+G(v)+";";if(!l){h+="transform-style:preserve-3d;word-break:normal;white-space:nowrap;"}}if(f){h+=K(f,s-n,Math.min(0,n-d))}if(l&&v.pbo){var g=e.scale*-v.pbo*(v.fscy||100)/100;h+="vertical-align:"+g+"px;"}var m=/"fr[xyz]":[^0]/.test(JSON.stringify(v));tt(o,v.q).split("<br>").forEach(function(a,n){var s=document.createElement("span");s.dataset.hasRotate=m;if(l){var o=Q.call(e,i,t.tag);s.style.cssText=o.cssText;s.appendChild(o.$svg)}else{if(n){r.appendChild(document.createElement("br"))}if(!a){return}s.innerHTML=a}s.style.cssText+=h;r.appendChild(s)})})});a.appendChild(r);return a}function at(t){var e=t.layer;var a=t.margin;var r=t.width;var i=t.height;var n=t.alignment;var s=t.end;var o=this.width-(this.scale*(a.left+a.right)|0);var l=this.height;var f=this.scale*a.vertical|0;var v=this.video.currentTime*100;this._.space[e]=this._.space[e]||{left:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)},center:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)},right:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)}};var h=this._.space[e];var c=["right","left","center"][n%3];var d=function(t){var e=h.left.width[t];var a=h.center.width[t];var i=h.right.width[t];var n=h.left.end[t];var s=h.center.end[t];var l=h.right.end[t];return c==="left"&&(n>v&&e||s>v&&a&&2*r+a>o||l>v&&i&&r+i>o)||c==="center"&&(n>v&&e&&2*e+r>o||s>v&&a||l>v&&i&&2*i+r>o)||c==="right"&&(n>v&&e&&e+r>o||s>v&&a&&2*r+a>o||l>v&&i)};var p=0;var u=0;var g=function(t){p=d(t)?0:p+1;if(p>=i){u=t;return true}return false};if(n<=3){for(var m=l-f-1;m>f;m--){if(g(m)){break}}}else if(n>=7){for(var y=f+1;y<l-f;y++){if(g(y)){break}}}else{for(var x=l-i>>1;x<l-f;x++){if(g(x)){break}}}if(n>3){u-=i-1}for(var w=u;w<u+i;w++){h[c].width[w]=r;h[c].end[w]=s*100}return u}function rt(t){var e=t.effect;var a=t.move;var r=t.alignment;var i=t.width;var n=t.height;var s=t.margin;var o=t.slices;var l=0;var f=0;if(e){if(e.name==="banner"){if(r<=3){f=this.height-n-s.vertical}if(r>=4&&r<=6){f=(this.height-n)/2}if(r>=7){f=s.vertical}l=e.lefttoright?-i:this.width}}else if(t.pos||a){var v=t.pos||{x:0,y:0};if(r%3===1){l=this.scale*v.x}if(r%3===2){l=this.scale*v.x-i/2}if(r%3===0){l=this.scale*v.x-i}if(r<=3){f=this.scale*v.y-n}if(r>=4&&r<=6){f=this.scale*v.y-n/2}if(r>=7){f=this.scale*v.y}}else{if(r%3===1){l=0}if(r%3===2){l=(this.width-i)/2}if(r%3===0){l=this.width-i-this.scale*s.right}var h=o.some(function(t){return t.fragments.some(function(t){var e=t.animationName;return e})});if(h){if(r<=3){f=this.height-n-s.vertical}if(r>=4&&r<=6){f=(this.height-n)/2}if(r>=7){f=s.vertical}}else{f=at.call(this,t)}}return{x:l,y:f}}function it(t){var e=t.layer;var a=t.start;var r=t.end;var i=t.alignment;var n=t.effect;var s=t.pos;var o=t.margin;var l=t.animationName;var f=t.width;var v=t.height;var h=t.x;var c=t.y;var d=this.video.currentTime;var p="";if(e){p+="z-index:"+e+";"}if(l){p+=K(l,r-a,Math.min(0,a-d))}p+="text-align:"+["right","left","center"][i%3]+";";if(!n){var u=this.width-this.scale*(o.left+o.right);p+="max-width:"+u+"px;";if(!s){if(i%3===1){p+="margin-left:"+this.scale*o.left+"px;"}if(i%3===0){p+="margin-right:"+this.scale*o.right+"px;"}if(f>this.width-this.scale*(o.left+o.right)){p+="margin-left:"+this.scale*o.left+"px;";p+="margin-right:"+this.scale*o.right+"px;"}}}p+="width:"+f+"px;height:"+v+"px;left:"+h+"px;top:"+c+"px;";return p}function nt(t){var e=et.call(this,t);c(t,{$div:e});this._.$stage.appendChild(e);var a=e.getBoundingClientRect();var r=a.width;var i=a.height;c(t,{width:r,height:i});c(t,rt.call(this,t));e.style.cssText=it.call(this,t);X(t);I.call(this,t);return t}function st(){var t=this;var e=this.video.currentTime;for(var a=this._.stagings.length-1;a>=0;a--){var r=t._.stagings[a];var i=r.end;if(r.effect&&/scroll/.test(r.effect.name)){var n=r.effect;var s=n.y1;var o=n.y2;var l=n.delay;var f=((o||t._.resampledRes.height)-s)/(1e3/l);i=Math.min(i,r.start+f)}if(i<e){t._.$stage.removeChild(r.$div);if(r.$clipPath){t._.$defs.removeChild(r.$clipPath)}t._.stagings.splice(a,1)}}var v=this.dialogues;while(this._.index<v.length&&e>=v[this._.index].start){if(e<v[t._.index].end){var h=nt.call(t,v[t._.index]);t._.stagings.push(h)}++t._.index}}function ot(){var t=this;var e=function(){st.call(t);t._.requestId=T(e)};this._.requestId=T(e);this._.$stage.classList.remove("ASS-animation-paused");return this}function lt(){E(this._.requestId);this._.requestId=0;this._.$stage.classList.add("ASS-animation-paused");return this}function ft(){var t=this;while(this._.$stage.lastChild){t._.$stage.removeChild(t._.$stage.lastChild)}while(this._.$defs.lastChild){t._.$defs.removeChild(t._.$defs.lastChild)}this._.stagings=[];this._.space=[]}function vt(){var t=this.video.currentTime;var e=this.dialogues;ft.call(this);this._.index=function(){var a=0;var r=e.length-1;while(a+1<r&&t>e[r+a>>1].end){a=r+a>>1}if(!a){return 0}for(var i=a;i<r;i++){if(e[i].end>t&&t>=e[i].start||i&&e[i-1].end<t&&t<e[i].start){return i}}return r}();st.call(this)}function ht(){var t=this._.listener;t.play=ot.bind(this);t.pause=lt.bind(this);t.seeking=vt.bind(this);this.video.addEventListener("play",t.play);this.video.addEventListener("pause",t.pause);this.video.addEventListener("seeking",t.seeking)}function ct(){var t=this._.listener;this.video.removeEventListener("play",t.play);this.video.removeEventListener("pause",t.pause);this.video.removeEventListener("seeking",t.seeking);t.play=null;t.pause=null;t.seeking=null}function dt(){var t=this.video.clientWidth;var e=this.video.clientHeight;var a=this.video.videoWidth;var r=this.video.videoHeight;var i=this._.scriptRes.width;var n=this._.scriptRes.height;var s=i;var o=n;var l=Math.min(t/a,e/r);if(this.resampling==="video_width"){o=i/a*r}if(this.resampling==="video_height"){s=n/r*a}this.scale=Math.min(t/s,e/o);if(this.resampling==="script_width"){this.scale=l*(a/s)}if(this.resampling==="script_height"){this.scale=l*(r/o)}this.width=this.scale*s;this.height=this.scale*o;this._.resampledRes={width:s,height:o};this.container.style.cssText="width:"+t+"px;height:"+e+"px;";var f="width:"+this.width+"px;"+"height:"+this.height+"px;"+"top:"+(e-this.height)/2+"px;"+"left:"+(t-this.width)/2+"px;";this._.$stage.style.cssText=f;this._.$svg.style.cssText=f;this._.$svg.setAttributeNS(null,"viewBox","0 0 "+i+" "+n);this._.$animation.innerHTML=Z.call(this);vt.call(this);return this}var pt=".ASS-container,.ASS-stage{position:relative;overflow:hidden}.ASS-container video{position:absolute;top:0;left:0}.ASS-stage{pointer-events:none;position:absolute}.ASS-dialogue{font-size:0;position:absolute}.ASS-fix-font-size{position:absolute;visibility:hidden}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}";function ut(t,e,a){if(a===void 0)a={};this.scale=1;this._={index:0,stagings:[],space:[],listener:{},$svg:L("svg"),$defs:L("defs"),$stage:document.createElement("div"),$animation:document.createElement("style")};this._.$svg.appendChild(this._.$defs);this._.$stage.className="ASS-stage ASS-animation-paused";this._.$animation.type="text/css";this._.$animation.className="ASS-animation";document.head.appendChild(this._.$animation);this._.resampling=a.resampling||"video_height";this.container=a.container||document.createElement("div");this.container.classList.add("ASS-container");this.container.appendChild(P);this.container.appendChild(this._.$svg);this._.hasInitContainer=!!a.container;this.video=e;ht.call(this);if(!this._.hasInitContainer){var r=!e.paused;e.parentNode.insertBefore(this.container,e);this.container.appendChild(e);if(r&&e.paused){e.play()}}this.container.appendChild(this._.$stage);var i=N(t);var n=i.info;var s=i.width;var o=i.height;var l=i.dialogues;this.info=n;this._.scriptRes={width:s||e.videoWidth,height:o||e.videoHeight};this.dialogues=l;var f=document.getElementById("ASS-global-style");if(!f){f=document.createElement("style");f.type="text/css";f.id="ASS-global-style";f.appendChild(document.createTextNode(pt));document.head.appendChild(f)}dt.call(this);if(!this.video.paused){vt.call(this);ot.call(this)}return this}function gt(){this._.$stage.style.visibility="visible";return this}function mt(){this._.$stage.style.visibility="hidden";return this}function yt(){var t=this;lt.call(this);ft.call(this);ct.call(this,this._.listener);if(!this._.hasInitContainer){var e=!this.video.paused;this.container.parentNode.insertBefore(this.video,this.container);this.container.parentNode.removeChild(this.container);if(e&&this.video.paused){this.video.play()}}document.head.removeChild(this._.$animation);for(var a in t){if(Object.prototype.hasOwnProperty.call(t,a)){t[a]=null}}return this}var xt=/^(video|script)_(width|height)$/;function wt(){return xt.test(this._.resampling)?this._.resampling:"video_height"}function bt(t){if(t===this._.resampling){return t}if(xt.test(t)){this._.resampling=t;this.resize()}return this._.resampling}var St=function t(e,a,r){if(typeof e!=="string"||!(a instanceof HTMLVideoElement)){return this}return ut.call(this,e,a,r)};var _t={resampling:{configurable:true}};St.prototype.resize=function t(){return dt.call(this)};St.prototype.show=function t(){return gt.call(this)};St.prototype.hide=function t(){return mt.call(this)};St.prototype.destroy=function t(){return yt.call(this)};_t.resampling.get=function(){return wt.call(this)};_t.resampling.set=function(t){return bt.call(this,t)};Object.defineProperties(St.prototype,_t);return St});