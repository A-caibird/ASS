!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.ASS=e()}(this,function(){"use strict";function t(){this.tree={},this.position=0,this.runline=[],this.scale=1,this.container=document.createElement("div"),this.container.className="ASS-container",this.container.appendChild(R),this.container.appendChild(C),this.stage=document.createElement("div"),this.stage.className="ASS-stage ASS-animation-paused"}t.prototype.init=function(t,e){if(t&&"VIDEO"===e.nodeName){var i=this;if(!this.video){var n=!e.paused;this.video=e,this.video.parentNode.insertBefore(this.container,this.video),this.container.appendChild(this.video),this.container.appendChild(this.stage),this.video.addEventListener("seeking",function(){i._seek()}),this.video.addEventListener("play",function(){i._play()}),this.video.addEventListener("pause",function(){i._pause()}),n&&this.video.paused&&this.video.play()}this.tree=l(t),this.tree.ScriptInfo.PlayResX&&this.tree.ScriptInfo.PlayResY||(this.tree.ScriptInfo.PlayResX=this.video.videoWidth,this.tree.ScriptInfo.PlayResY=this.video.videoHeight);var s=[0,0,this.tree.ScriptInfo.PlayResX,this.tree.ScriptInfo.PlayResY];C.setAttributeNS(null,"viewBox",s.join(" "));var a=document.getElementById("ASS-style");return a||(a=document.createElement("style"),a.type="text/css",a.id="ASS-style",a.appendChild(document.createTextNode(r)),document.head.appendChild(a)),this.resize(),this}},t.prototype.resize=function(){if(this.video){var t=this.video.clientWidth,e=this.video.clientHeight,i=t/e,n=this.video.videoWidth,s=this.video.videoHeight,a=n/s,r=i>a?a*e:t,o=i>a?e:t/a,l=i>a?0:(e-o)/2,h=i>a?(t-r)/2:0;this.width=r,this.height=o;var c=["width:",r,"px;height:",o,"px;"];return this.container.style.cssText=c.join(""),c.push("top:",l,"px;left:",h,"px;"),this.stage.style.cssText=c.join(""),C.style.cssText=c.join(""),this.scale=Math.min(r/this.tree.ScriptInfo.PlayResX,o/this.tree.ScriptInfo.PlayResY),N.call(this),this._seek(),this}},t.prototype.show=function(){return this.stage.style.visibility="visible",this},t.prototype.hide=function(){return this.stage.style.visibility="hidden",this},t.prototype._play=function(){var t=this,i=function(){t._launch(),n=e(i)};n=e(i),this.stage.classList.remove("ASS-animation-paused")},t.prototype._pause=function(){i(n),n=0,this.stage.classList.add("ASS-animation-paused")},t.prototype._seek=function(){for(var t=this.video.currentTime,e=this.tree.Events.Dialogue;this.stage.lastChild;)this.stage.removeChild(this.stage.lastChild);for(;_.lastChild;)_.removeChild(_.lastChild);this.runline=[],s=[],this.position=function(){for(var i=0,n=e.length-1;n>i+1&&t>e[n+i>>1].End;)i=n+i>>1;if(!i)return 0;for(var s=i;n>s;++s)if(e[s].End>t&&t>=e[s].Start||s&&e[s-1].End<t&&t<e[s].Start)return s;return n}(),this._launch()},t.prototype._launch=function(){for(var t=this.video.currentTime,e=this.tree.Events.Dialogue,i=this.runline.length-1;i>=0;--i){var n=this.runline[i],s=n.End;if(n.Effect&&/scroll/.test(n.Effect.name)){var a=(n.Effect.y2-n.Effect.y1)/(1e3/n.Effect.delay);s=Math.min(s,n.Start+a)}t>s&&(this.stage.removeChild(n.node),n.clipPath&&_.removeChild(n.clipPath),this.runline.splice(i,1))}for(;this.position<e.length&&t>=e[this.position].Start;){if(t<e[this.position].End){var n=x.call(this,e[this.position]);this.runline.push(n)}++this.position}};var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)},i=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||function(t){clearTimeout(t)},n=0,s=[],a="http://www.w3.org/2000/svg",r=".ASS-container{position:relative}.ASS-container video,.ASS-dialogue,.ASS-fix-font-size,.ASS-stage{position:absolute}.ASS-fix-font-size{visibility:hidden}.ASS-container video{top:0;left:0}.ASS-stage{overflow:hidden;z-index:2147483647;pointer-events:none}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}",o=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"===t?e:3&e|8;return i.toString(16)})},l=function(t){t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");for(var e={ScriptInfo:{Title:"&lt;untitled&gt;","Original Script":"&lt;unknown&gt;"},V4Styles:{Format:{},Style:{}},Events:{Format:{},Dialogue:[]}},i=t.split(/\r?\n/),n=0,s=i.length,a=0;s>a;++a){var r=i[a].replace(/^\s+|\s+$/g,"");if(!/^;/.test(r)&&(/^\[Script Info\]/i.test(r)?n=1:/^\[V4\+ Styles\]/i.test(r)?n=2:/^\[Events\]/i.test(r)?n=3:/^\[.*\]/.test(r)&&(n=0),0!==n)){if(1===n&&/:/.test(r)){var o=r.match(/(.*?)\s*:\s*(.*)/);isNaN(1*o[2])||(o[2]*=1),e.ScriptInfo[o[1]]=o[2]}if(2===n&&(/^Format:/.test(r)&&(e.V4Styles.Format=u(r)),/^Style:/.test(r))){var l=p(r,e);e.V4Styles.Style[l.Name]=l}if(3===n&&(/^Format:/.test(r)&&(e.Events.Format=u(r)),/^Dialogue:/.test(r))){var c=h(r,e);c.Start<c.End&&(c._index=e.Events.Dialogue.length,e.Events.Dialogue.push(c))}}}return e.Events.Dialogue.sort(function(t,e){return t.Start-e.Start||t.End-e.End||t._index-e._index}),e},h=function(t,e){var i=t.match(/Dialogue:(.*)/)[1].split(","),n=e.Events.Format.length;if(i.length>n){var s=i.slice(n-1).join();i=i.slice(0,n-1),i.push(s)}for(var a=e.ScriptInfo.Timer/100||1,r={},o=0;n>o;++o)r[e.Events.Format[o]]=i[o].replace(/^\s+/,"");return r.Layer*=1,r.Start=g(r.Start)/a,r.End=g(r.End)/a,r.Style=e.V4Styles.Style[r.Style]?r.Style:"Default",r.MarginL*=1,r.MarginR*=1,r.MarginV*=1,r.Effect=d(r.Effect,e.ScriptInfo.PlayResY),r._parsedText=f(r,e.V4Styles.Style),r},c=function(t){function e(t,e){this.x=t,this.y=e,this.toString=function(){return this.x+","+this.y}}function i(t){this.points=[],this.type=null,this.prevType=null,this.nextType=null,/m/.test(t)&&(this.type="M"),/n|l/.test(t)&&(this.type="L"),/b/.test(t)&&(this.type="C"),/s/.test(t)&&(this.type="_S"),this.isValid=function(){return this.points.length&&this.type?/C|S/.test(this.type)&&this.points.length<3?!1:!0:!1},this.toString=function(){return"_S"===this.type?a(this.points,this.prevType,this.nextType):this.type+this.points.join()}}t=t.replace(/([mnlbspc])/gi," $1 ").replace(/^\s*|\s*$/g,"").replace(/\s+/g," ").toLowerCase();for(var n=t.split(/\s(?=[mnlbspc])/),s=[],a=function(t,i,n){var s=[0,2/3,1/3,0],a=[0,1/3,2/3,0],r=[0,1/6,2/3,1/6],o=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x],h=[t[t.length-1].y,t[0].y,t[1].y,t[2].y],c=["L",new e(o(r,l),o(r,h))];"M"===i&&(c[0]="M");for(var d=3;d<t.length;d++)l=[t[d-3].x,t[d-2].x,t[d-1].x,t[d].x],h=[t[d-3].y,t[d-2].y,t[d-1].y,t[d].y],c.push("C"+new e(o(s,l),o(s,h)),","+new e(o(a,l),o(a,h)),","+new e(o(r,l),o(r,h)));return("L"===n||"C"===n)&&c.push("L",t[t.length-1]),c.join("")},r=0;r<n.length;){for(var o=n[r].split(" "),l=new i(o[0]),h=o.length-!(1&o.length),c=1;h>c;c+=2)l.points.push(new e(o[c],o[c+1]));if(/p|c/.test(o[0])){if("_S"===s[r-1].type){if("p"===o[0]){var d=s[r-1].points.concat(l.points);s[r-1].points=d}if("c"===o[0]){var u=s[r-1].points;s[r-1].points.push(new e(u[0].x,u[0].y),new e(u[1].x,u[1].y),new e(u[2].x,u[2].y))}}n.splice(r,1)}else{if("s"===o[0]){var d=s[r-1].points[s[r-1].points.length-1];l.points.unshift(new e(d.x,d.y))}l.isValid()&&(r&&(l.prevType=s[r-1].type,s[r-1].nextType=l.type),s.push(l)),r++}}return s},d=function(t,e){var i=t.toLowerCase().split(";");return"banner"===i[0]?{name:i[0],delay:1*i[1]||1,lefttoright:1*i[2]||0,fadeawaywidth:1*i[3]||0}:/^scroll\s/.test(i[0])?{name:i[0],y1:Math.min(i[1],i[2]),y2:Math.max(i[1],i[2])||e,delay:1*i[3]||1,fadeawayheight:1*i[4]||0}:null},u=function(t){return t.match(/Format:(.*)/)[1].replace(/\s/g,"").split(",")},p=function(t,e){for(var i=t.match(/Style:(.*)/)[1].split(","),n={},s=i.length-1;s>=0;--s){var a=e.V4Styles.Format[s];n[a]=i[s].replace(/^\s*/,""),isNaN(1*n[a])||(n[a]*=1)}return n._tags={fn:n.Fontname,fs:n.Fontsize,c1:n.PrimaryColour.match(/&H(\w\w)?(\w{6})&?/)[2],a1:n.PrimaryColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c2:n.SecondaryColour.match(/&H(\w\w)?(\w{6})&?/)[2],a2:n.SecondaryColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c3:n.OutlineColour.match(/&H(\w\w)?(\w{6})&?/)[2],a3:n.OutlineColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c4:n.BackColour.match(/&H(\w\w)?(\w{6})&?/)[2],a4:n.BackColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",b:Math.abs(n.Bold),i:Math.abs(n.Italic),u:Math.abs(n.Underline),s:Math.abs(n.StrikeOut),q:e.ScriptInfo.WrapStyle||1,fscx:n.ScaleX,fscy:n.ScaleY,fsp:n.Spacing,frz:n.Angle,xbord:n.Outline,ybord:n.Outline,xshad:n.Shadow,yshad:n.Shadow},n},f=function(t,e){var i=t.Text.replace(/\\N/g,"<br>").replace(/\\h/g,"&nbsp;"),n=JSON.parse(JSON.stringify(e[t.Style]._tags)),s=i.split(/{([^{}]*?)}/),a={content:[]};s[0].length&&a.content.push({text:s[0],tags:n});for(var r=1;r<s.length;r+=2){for(var o={text:s[r+1],tags:JSON.parse(JSON.stringify(n))},l=s[r].split("\\"),h=0;h<l.length;++h)if(/^t\(/.test(l[h])&&!/\)$/.test(l[h])){for(;!/\)$/.test(l[h+1]);)l[h]+="\\"+l[h+1],l.splice(h+1,1);l[h]+="\\"+l[h+1],l.splice(h+1,1)}for(var h=0;h<l.length;++h){var d=l[h];if(m.call(o,d),o.tags.clip&&(a.clip=o.tags.clip),/^b\d/.test(d)&&(o.tags.b=1*d.match(/^b(\d+)/)[1]),/^i\d/.test(d)&&(o.tags.i=1*d[1]),/^u\d/.test(d)&&(o.tags.u=1*d[1]),/^s\d/.test(d)&&(o.tags.s=1*d[1]),/^fn/.test(d)&&(o.tags.fn=d.match(/^fn(.*)/)[1]),/^fe/.test(d)&&(o.tags.fe=1*d.match(/^fe(.*)/)[1]),/^k\d/.test(d)&&(o.tags.k=1*d.match(/^k(\d+)/)[1]),/^K\d/.test(d)&&(o.tags.kf=1*d.match(/^K(\d+)/)[1]),/^kf\d/.test(d)&&(o.tags.kf=1*d.match(/^kf(\d+)/)[1]),/^ko\d/.test(d)&&(o.tags.ko=1*d.match(/^ko(\d+)/)[1]),/^kt\d/.test(d)&&(o.tags.kt=1*d.match(/^kt(\d+)/)[1]),/^q\d/.test(d)&&(o.tags.q=1*d[1]),/^p\d/.test(d)&&(o.tags.p=1*d.match(/^p(\d+)/)[1]),/^pbo/.test(d)&&(o.tags.pbo=1*d.match(/^pbo(.*)/)[1]),/^an\d/.test(d)&&!a.alignment&&(a.alignment=1*d[2]),/^a\d/.test(d)&&!a.alignment){var u=1*d.match(/^a(\d+)/)[1];4>u?a.alignment=u:u>8?a.alignment=u-5:a.alignment=u+2}if(/^pos/.test(d)&&!a.pos&&!a.move){var p=d.replace(/\s/g,"").match(/^pos\((.*?)\)?$/)[1].split(",");a.pos={x:1*p[0],y:1*p[1]}}if(/^org/.test(d)&&!a.org){var p=d.replace(/\s/g,"").match(/^org\((.*?)\)?$/)[1].split(",");a.org={x:1*p[0],y:1*p[1]}}if(/^move/.test(d)&&!a.move&&!a.pos){var p=d.replace(/\s/g,"").match(/^move\((.*?)\)?$/)[1].split(",").map(function(t){return 1*t});a.pos={x:1*p[0],y:1*p[1]},4===p.length&&(p.push(0),p.push(1e3*(t.End-t.Start))),a.move=p}if(/^fad\s*\(/.test(d)&&!a.fad&&(a.fad=d.replace(/\s/g,"").match(/^fad\((.*?)\)?$/)[1].split(",").map(function(t){return 1*t})),/^fade/.test(d)&&!a.fade&&(a.fade=d.replace(/\s/g,"").match(/^fade\((.*?)\)?$/)[1].split(",").map(function(t){return 1*t})),/^r/.test(d)){var f=d.match(/^r(.*)/)[1],g=e[f]||e[t.Style];o.tags=JSON.parse(JSON.stringify(g._tags))}if(/^t\(/.test(d)){var x=d.replace(/\s/g,"").match(/^t\((.*)\)/)[1].split(",");if(!x[0])continue;for(var v=x[x.length-1].split("\\"),S={t1:0,t2:1e3*(t.End-t.Start),accel:1,tags:{}},y=v.length-1;y>=0;y--)m.call(S,v[y]);2===x.length&&(S.accel=1*x[0]),3===x.length&&(S.t1=1*x[0],S.t2=1*x[1]),4===x.length&&(S.t1=1*x[0],S.t2=1*x[1],S.accel=1*x[2]),o.tags.t||(o.tags.t=[]),o.tags.t.push(S)}}if(o.tags.t)for(var h=0;h<o.tags.t.length-1;++h)for(var y=h+1;y<o.tags.t.length;++y)if(o.tags.t[h].t1===o.tags.t[y].t1&&o.tags.t[h].t2===o.tags.t[y].t2){for(var b in o.tags.t[y].tags)o.tags.t[h].tags[b]=o.tags.t[y].tags[b];o.tags.t.splice(y,1)}t.Effect&&"banner"===t.Effect.name&&(o.tags.q=2),o.tags.p?o.commands=c(o.text):o.text=o.text.replace(/\s/g,"&nbsp;"),o.text=o.text.replace(/\\n/g,2===o.tags.q?"<br>":"&nbsp;"),n=o.tags,a.content.push(o)}return a},m=function(t){if(/^fs[\d\+\-]/.test(t)){var e=t.match(/^fs(.*)/)[1];/^\d/.test(e)&&(this.tags.fs=1*e),/^\+|-/.test(e)&&(this.tags.fs*=1*e>-10?1+e/10:1)}if(/^fsp/.test(t)&&(this.tags.fsp=1*t.match(/^fsp(.*)/)[1]),/^fscx/.test(t)&&(this.tags.fscx=1*t.match(/^fscx(.*)/)[1]),/^fscy/.test(t)&&(this.tags.fscy=1*t.match(/^fscy(.*)/)[1]),/^fsp/.test(t)&&(this.tags.fsp=1*t.match(/^fsp(.*)/)[1]),/^frx/.test(t)&&(this.tags.frx=1*t.match(/^frx(.*)/)[1]),/^fry/.test(t)&&(this.tags.fry=1*t.match(/^fry(.*)/)[1]),/^fr[z\d\-]/.test(t)&&(this.tags.frz=1*t.match(/^frz?(.*)/)[1]),/^blur\d/.test(t)&&(this.tags.blur=1*t.match(/^blur(.*)/)[1]),/^be\d/.test(t)&&(this.tags.blur=1*t.match(/^be(.*)/)[1]),this.tags.blur<0&&(this.tags.blur=0),/^fax/.test(t)&&(this.tags.fax=1*t.match(/^fax(.*)/)[1]),/^fay/.test(t)&&(this.tags.fay=1*t.match(/^fay(.*)/)[1]),/^x*bord/.test(t)&&(this.tags.xbord=1*t.match(/^x*bord(.*)/)[1]),/^y*bord/.test(t)&&(this.tags.ybord=1*t.match(/^y*bord(.*)/)[1]),this.tags.xbord<0&&(this.tags.xbord=0),this.tags.ybord<0&&(this.tags.ybord=0),/^x*shad/.test(t)&&(this.tags.xshad=1*t.match(/^x*shad(.*)/)[1]),/^y*shad/.test(t)&&(this.tags.yshad=1*t.match(/^y*shad(.*)/)[1]),/^\d?c&?H?[0-9a-f]+/i.test(t)){var i=t.match(/^(\d?)c&?H?(\w+)/);for(i[1]||(i[1]="1");i[2].length<6;)i[2]="0"+i[2];this.tags["c"+i[1]]=i[2]}if(/^\da&?H?[0-9a-f]+/i.test(t)){var i=t.match(/^(\d)a&?H?(\w\w)/);this.tags["a"+i[1]]=i[2]}if(/^alpha&?H?[0-9a-f]+/i.test(t))for(var n=1;4>=n;n++)this.tags["a"+n]=t.match(/^alpha&?H?(\w\w)/)[1];if(/^i?clip/.test(t)){var s=t.match(/^i?clip\s*\((.*)\)/)[1].split(/\s*,\s*/);this.tags.clip={inverse:/iclip/.test(t),scale:1,commands:null,dots:null},1===s.length&&(this.tags.clip.commands=c(s[0])),2===s.length&&(this.tags.clip.scale=1*s[0],this.tags.clip.commands=c(s[1])),4===s.length&&(this.tags.clip.dots=[1*s[0],1*s[1],1*s[2],1*s[3]])}},g=function(t){var e=t.split(":");return 3600*e[0]+60*e[1]+1*e[2]},x=function(t){var e=t._parsedText,i=this.tree.V4Styles.Style[t.Style],n={node:document.createElement("div"),Alignment:e.alignment||i.Alignment,Layer:t.Layer,Start:t.Start,End:t.End,BorderStyle:i.BorderStyle,MarginL:t.MarginL||i.MarginL,MarginR:t.MarginR||i.MarginR,MarginV:t.MarginV||i.MarginV,Effect:t.Effect,parsedText:e,animationName:e.animationName,move:e.move,fad:e.fad,fade:e.fade,pos:e.pos||(e.move?{x:0,y:0}:null),org:e.org,clip:e.clip,channel:0,t:!1};n.node.className="ASS-dialogue",v.call(this,n),this.stage.appendChild(n.node);var s=n.node.getBoundingClientRect();return n.width=s.width,n.height=s.height,S.call(this,n),y.call(this,n),b(n),A.call(this,n),n},v=function(t){for(var e=document.createDocumentFragment(),i=t.parsedText.content.length,n=0;i>n;++n){var s=t.parsedText.content[n];if(s.text){var a=s.tags,r=["display:inline-block"],o=this.video.currentTime;if(!a.p){r.push("font-family:'"+a.fn+"',Arial");var l=this.scale*B(a.fs,a.fn);r.push("font-size:"+l+"px"),r.push("color:"+I(a.a1+a.c1));var h=this.tree.ScriptInfo.ScaledBorderAndShadow,c=/Yes/i.test(h)?this.scale:1;1===t.BorderStyle&&r.push("text-shadow:"+M(a,c)),3===t.BorderStyle&&(r.push("background-color:"+I(a.a3+a.c3)),r.push("box-shadow:"+M(a,c))),0===a.b?r.push("font-weight:normal"):1===a.b?r.push("font-weight:bold"):r.push("font-weight:"+a.b),r.push("font-style:"+(a.i?"italic":"normal")),a.u&&a.s?r.push("text-decoration:underline line-through"):a.u?r.push("text-decoration:underline"):a.s&&r.push("text-decoration:line-through"),r.push("letter-spacing:"+this.scale*a.fsp+"px"),0===a.q,1===a.q&&(r.push("word-break:break-all"),r.push("white-space:normal")),2===a.q&&(r.push("word-break:normal"),r.push("white-space:nowrap")),3===a.q}if(a.fax||a.fay||a.frx||a.fry||a.frz||100!==a.fscx||100!==a.fscy){var d=z(a);["","-webkit-"].forEach(function(t){r.push(t+"transform:"+d)}),a.p||(r.push("transform-style:preserve-3d"),r.push("word-break:normal"),r.push("white-space:nowrap"))}a.t&&(["","-webkit-"].forEach(function(e){var i=Math.min(0,t.Start-o);r.push(e+"animation-name:"+s.animationName),r.push(e+"animation-duration:"+(t.End-t.Start)+"s"),r.push(e+"animation-delay:"+i+"s"),r.push(e+"animation-timing-function:linear"),r.push(e+"animation-iteration-count:1"),r.push(e+"animation-fill-mode:forwards")}),t.t=!0),t.hasRotate=/"fr[xyz]":[^0]/.test(JSON.stringify(a));for(var u=s.text.split("<br>"),p=u.length,f=0;p>f;f++)if(f&&e.appendChild(document.createElement("br")),u[f]){var m=document.createElement("span");m.dataset.hasRotate=t.hasRotate,a.p?(m.appendChild(L.call(this,m,s,t)),a.pbo&&r.push("vertical-align:"+-a.pbo+"px")):m.innerHTML=u[f],m.style.cssText+=r.join(";"),e.appendChild(m)}}}t.node.appendChild(e)},S=function(t){t.Effect?("banner"===t.Effect.name&&(t.Alignment<=3&&(t.y=this.height-t.height-t.MarginV),t.Alignment>=4&&t.Alignment<=6&&(t.y=(this.height-t.height)/2),t.Alignment>=7&&(t.y=t.MarginV),t.Effect.lefttoright?t.x=-t.width:t.x=this.width),/^scroll/.test(t.Effect.name)&&(t.y=/up/.test(t.Effect.name)?this.height:-t.height,t.Alignment%3===1&&(t.x=0),t.Alignment%3===2&&(t.x=(this.width-t.width)/2),t.Alignment%3===0&&(t.x=this.width-t.width))):t.pos?(t.Alignment%3===1&&(t.x=this.scale*t.pos.x),t.Alignment%3===2&&(t.x=this.scale*t.pos.x-t.width/2),t.Alignment%3===0&&(t.x=this.scale*t.pos.x-t.width),t.Alignment<=3&&(t.y=this.scale*t.pos.y-t.height),t.Alignment>=4&&t.Alignment<=6&&(t.y=this.scale*t.pos.y-t.height/2),t.Alignment>=7&&(t.y=this.scale*t.pos.y)):(t.Alignment%3===1&&(t.x=0),t.Alignment%3===2&&(t.x=(this.width-t.width)/2),t.Alignment%3===0&&(t.x=this.width-t.width-this.scale*t.MarginR),t.t?(t.Alignment<=3&&(t.y=this.height-t.height-t.MarginV),t.Alignment>=4&&t.Alignment<=6&&(t.y=(this.height-t.height)/2),t.Alignment>=7&&(t.y=t.MarginV)):t.y=T.call(this,t))},y=function(t){var e=[],i=this.video.currentTime;if(t.Layer&&e.push("z-index:"+t.Layer),(t.move||t.fad||t.fade||t.Effect)&&["","-webkit-"].forEach(function(n){e.push(n+"animation-name:"+t.animationName),e.push(n+"animation-duration:"+(t.End-t.Start)+"s"),e.push(n+"animation-delay:"+Math.min(0,t.Start-i)+"s"),e.push(n+"animation-timing-function:linear"),e.push(n+"animation-iteration-count:1"),e.push(n+"animation-fill-mode:forwards")}),t.Alignment%3===1&&e.push("text-align:left"),t.Alignment%3===2&&e.push("text-align:center"),t.Alignment%3===0&&e.push("text-align:right"),!t.Effect){var n=this.width-this.scale*(t.MarginL+t.MarginR);e.push("max-width:"+n+"px"),t.pos||(t.Alignment%3===1&&e.push("margin-left:"+this.scale*t.MarginL+"px"),t.Alignment%3===0&&e.push("margin-right:"+this.scale*t.MarginR+"px"),t.width>this.width-this.scale*(t.MarginL+t.MarginR)&&(e.push("margin-left:"+this.scale*t.MarginL+"px"),e.push("margin-right:"+this.scale*t.MarginR+"px")))}e.push("width:"+t.width+"px"),e.push("height:"+t.height+"px"),e.push("left:"+t.x+"px"),e.push("top:"+t.y+"px"),t.node.style.cssText=e.join(";")},b=function(t){if(t.hasRotate){t.org||(t.org={x:0,y:0},t.Alignment%3===1&&(t.org.x=t.x),t.Alignment%3===2&&(t.org.x=t.x+t.width/2),t.Alignment%3===0&&(t.org.x=t.x+t.width),t.Alignment<=3&&(t.org.y=t.y+t.height),t.Alignment>=4&&t.Alignment<=6&&(t.org.y=t.y+t.height/2),t.Alignment>=7&&(t.org.y=t.y));for(var e=t.node.childNodes,i=e.length-1;i>=0;i--)if(e[i].dataset.hasRotate){var n=t.org.x-t.x-e[i].offsetLeft,s=t.org.y-t.y-e[i].offsetTop,a="transform-origin:"+n+"px "+s+"px;";e[i].style.cssText+="-webkit-"+a+a}}},A=function(t){if(t.clip){var e=document.createElement("div");this.stage.insertBefore(e,t.node),e.appendChild(t.node),t.node=e,e.className="ASS-fix-objectBoundingBox",e.style.cssText+=k.call(this,t)}},w=document.createElement("style");w.type="text/css",w.className="ASS-animation",document.head.appendChild(w);var N=function(){function t(){this.obj={},this.set=function(t,e,i){this.obj[t]||(this.obj[t]={}),this.obj[t][e]=i},this.toString=function(){var t=["{"];for(var e in this.obj){t.push(e+"{");for(var i in this.obj[e]){var n=i+":"+this.obj[e][i]+";";"transform"===i&&t.push("-webkit-"+n),t.push(n)}t.push("}")}return t.push("}\n"),t.join("")}}for(var e={},i=function(t){for(var i in e)if(e[i]===t)return i;return null},n=this.tree.Events.Dialogue.length-1;n>=0;n--){var s=this.tree.Events.Dialogue[n],a=s._parsedText,r=1e3*(s.End-s.Start),l=new t,h="",c=[];if(s.Effect&&!a.move){var d=s.Effect;if("banner"===d.name){var u=this.scale*(r/d.delay)*(d.lefttoright?1:-1);l.set("0.000%","transform","translateX(0)"),l.set("100.000%","transform","translateX("+u+"px)")}if(/^scroll/.test(d.name)){var p=/up/.test(d.name)?-1:1,f="translateY("+this.scale*d.y1*p+"px)",m="translateY("+this.scale*d.y2*p+"px)",g=(d.y2-d.y1)/(r/d.delay)*100;c[1]=Math.min(100,g).toFixed(3)+"%",l.set("0.000%","transform",f),l.set(c[1],"transform",m),l.set("100.000%","transform",m)}}if(!a.fad&&a.fade&&2===a.fade.length&&(a.fad=a.fade),a.fad&&2===a.fad.length&&(c[0]="0.000%",c[1]=Math.min(100,a.fad[0]/r*100).toFixed(3)+"%",c[2]=Math.max(0,(r-a.fad[1])/r*100).toFixed(3)+"%",c[3]="100.000%",l.set(c[0],"opacity",0),l.set(c[1],"opacity",1),l.set(c[2],"opacity",1),l.set(c[3],"opacity",0)),a.fade&&7===a.fade.length){c[0]="0.000%",c[5]="100.000%";for(var x=1;4>=x;x++)c[x]=Math.min(100,a.fade[x+2]/r*100).toFixed(3)+"%";for(var x=0;5>=x;x++)l.set(c[x],"opacity",1-a.fade[x>>1]/255)}if(a.move&&6===a.move.length&&(a.pos||(a.pos={x:0,y:0}),6===a.move.length)){c[0]="0.000%",c[1]=Math.min(100,a.move[4]/r*100).toFixed(3)+"%",c[2]=Math.min(100,a.move[5]/r*100).toFixed(3)+"%",c[3]="100.000%";for(var x=0;3>=x;x++){var u=this.scale*(a.move[2>x?0:2]-a.pos.x),v=this.scale*(a.move[2>x?1:3]-a.pos.y);l.set(c[x],"transform","translate("+u+"px, "+v+"px)")}}h=l.toString();var S=i(h);null===S&&(S="ASS-"+o(),e[S]=h),a.animationName=S;for(var x=a.content.length-1;x>=0;x--){l=new t;var y=JSON.parse(JSON.stringify(a.content[x].tags));if(y.t)for(var b=y.t.length-1;b>=0;b--){var A=JSON.parse(JSON.stringify(y.t[b].tags));if(c[0]="0.000%",c[1]=Math.min(100,y.t[b].t1/r*100).toFixed(3)+"%",c[2]=Math.min(100,y.t[b].t2/r*100).toFixed(3)+"%",c[3]="100.000%",A.fs){var N=this.scale*B(y.fs,y.fn)+"px",E=this.scale*B(A.fs,y.fn)+"px";l.set(c[0],"font-size",N),l.set(c[1],"font-size",N),l.set(c[2],"font-size",E),l.set(c[3],"font-size",E)}if(A.fsp){var C=this.scale*y.fsp+"px",_=this.scale*A.fsp+"px";l.set(c[0],"letter-spacing",C),l.set(c[1],"letter-spacing",C),l.set(c[2],"letter-spacing",_),l.set(c[3],"letter-spacing",_)}if(A.c1||A.a1){A.c1=A.c1||y.c1,A.a1=A.a1||y.a1;var k=I(y.a1+y.c1),T=I(A.a1+A.c1);l.set(c[0],"color",k),l.set(c[1],"color",k),l.set(c[2],"color",T),l.set(c[3],"color",T)}if(A.a1&&A.a1===A.a2&&A.a2===A.a3&&A.a3===A.a4){var L=1-parseInt(y.a1,16)/255,F=1-parseInt(A.a1,16)/255;l.set(c[0],"opacity",L),l.set(c[1],"opacity",L),l.set(c[2],"opacity",F),l.set(c[3],"opacity",F)}var j=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur"],R=function(t){for(var e=j.length-1;e>=0;--e)if(void 0!==t[j[e]])return!0;return!1};if(R(A)){j.forEach(function(t){void 0===A[t]&&(A[t]=y[t])});var V=this.tree.ScriptInfo.ScaledBorderAndShadow,P=/Yes/i.test(V)?this.scale:1,H=M(y,P),O=M(A,P);l.set(c[0],"text-shadow",H),l.set(c[1],"text-shadow",H),l.set(c[2],"text-shadow",O),l.set(c[3],"text-shadow",O)}if(A.fscx&&100!==A.fscx||A.fscy&&100!==A.fscy||void 0!==A.frx||void 0!==A.fry||void 0!==A.frz||void 0!==A.fax||void 0!==A.fay){var D=["fscx","fscy","frx","fry","frz","fax","fay"];D.forEach(function(t){void 0===A[t]&&(A[t]=y[t])}),y.p&&(A.fscx=A.fscx/y.fscx*100,A.fscy=A.fscy/y.fscy*100,y.fscx=y.fscy=100);var f=z(y),m=z(A);l.set(c[0],"transform",f),l.set(c[1],"transform",f),l.set(c[2],"transform",m),l.set(c[3],"transform",m)}}h=l.toString();var S=i(h);null===S&&(S="ASS-"+o(),e[S]=h),a.content[x].animationName=S}}var Y=[];for(var S in e)Y.push("@keyframes "+S+e[S]),Y.push("@-webkit-keyframes "+S+e[S]);w.innerHTML=Y.join("")},E=function(t,e,i){var n=t.xbord||t.ybord,s=t.xshad||t.yshad,r="FF"===t.a1,o=t.blur||0,l=document.createElementNS(a,"filter");l.setAttributeNS(null,"id",e);var h=document.createElementNS(a,"feGaussianBlur");h.setAttributeNS(null,"stdDeviation",n?0:o),h.setAttributeNS(null,"in","SourceGraphic"),h.setAttributeNS(null,"result","sg_b"),l.appendChild(h);var c=document.createElementNS(a,"feFlood");c.setAttributeNS(null,"flood-color",I(t.a1+t.c1)),c.setAttributeNS(null,"result","c1"),l.appendChild(c);var d=document.createElementNS(a,"feComposite");if(d.setAttributeNS(null,"operator","in"),d.setAttributeNS(null,"in","c1"),d.setAttributeNS(null,"in2","sg_b"),d.setAttributeNS(null,"result","main"),l.appendChild(d),n){var u=document.createElementNS(a,"feMorphology");u.setAttributeNS(null,"radius",t.xbord*i+" "+t.ybord*i),u.setAttributeNS(null,"operator","dilate"),u.setAttributeNS(null,"in","SourceGraphic"),u.setAttributeNS(null,"result","dil"),l.appendChild(u);var p=document.createElementNS(a,"feGaussianBlur");p.setAttributeNS(null,"stdDeviation",o),p.setAttributeNS(null,"in","dil"),p.setAttributeNS(null,"result","dil_b"),l.appendChild(p);var f=document.createElementNS(a,"feComposite");f.setAttributeNS(null,"operator","out"),f.setAttributeNS(null,"in","dil_b"),f.setAttributeNS(null,"in2","SourceGraphic"),f.setAttributeNS(null,"result","dil_b_o"),l.appendChild(f);var m=document.createElementNS(a,"feFlood");m.setAttributeNS(null,"flood-color",I(t.a3+t.c3)),m.setAttributeNS(null,"result","c3"),l.appendChild(m);var g=document.createElementNS(a,"feComposite");g.setAttributeNS(null,"operator","in"),g.setAttributeNS(null,"in","c3"),g.setAttributeNS(null,"in2","dil_b_o"),g.setAttributeNS(null,"result","border"),l.appendChild(g)}if(s&&(n||!r)){var x=document.createElementNS(a,"feOffset");x.setAttributeNS(null,"dx",t.xshad*i),x.setAttributeNS(null,"dy",t.yshad*i),x.setAttributeNS(null,"in",n?"dil":"SourceGraphic"),x.setAttributeNS(null,"result","off"),l.appendChild(x);var v=document.createElementNS(a,"feGaussianBlur");if(v.setAttributeNS(null,"stdDeviation",o),v.setAttributeNS(null,"in","off"),v.setAttributeNS(null,"result","off_b"),l.appendChild(v),r){var S=document.createElementNS(a,"feOffset");S.setAttributeNS(null,"dx",t.xshad*i),S.setAttributeNS(null,"dy",t.yshad*i),S.setAttributeNS(null,"in","SourceGraphic"),S.setAttributeNS(null,"result","sg_off"),l.appendChild(S);var y=document.createElementNS(a,"feComposite");y.setAttributeNS(null,"operator","out"),y.setAttributeNS(null,"in","off_b"),y.setAttributeNS(null,"in2","sg_off"),y.setAttributeNS(null,"result","off_b_o"),l.appendChild(y)}var b=document.createElementNS(a,"feFlood");b.setAttributeNS(null,"flood-color",I(t.a4+t.c4)),b.setAttributeNS(null,"result","c4"),l.appendChild(b);var A=document.createElementNS(a,"feComposite");A.setAttributeNS(null,"operator","in"),A.setAttributeNS(null,"in","c4"),A.setAttributeNS(null,"in2",r?"off_b_o":"off_b"),A.setAttributeNS(null,"result","shadow"),l.appendChild(A)}var w=document.createElementNS(a,"feMerge");if(s&&(n||!r)){var N=document.createElementNS(a,"feMergeNode");N.setAttributeNS(null,"in","shadow"),w.appendChild(N)}if(n){var E=document.createElementNS(a,"feMergeNode");E.setAttributeNS(null,"in","border"),w.appendChild(E)}var M=document.createElementNS(a,"feMergeNode");return M.setAttributeNS(null,"in","main"),w.appendChild(M),l.appendChild(w),l},M=function(t,e){var i=[],n=I(t.a3+t.c3),s=t.xbord*e,a=t.ybord*e,r=I(t.a4+t.c4),o=t.xshad*e,l=t.yshad*e,h=t.blur||0;if(!(s+a+o+l))return"none";if(s||a)for(var c=-1;1>=c;c++)for(var d=-1;1>=d;d++){for(var u=1;s>u;u++)for(var p=1;a>p;p++)(c||d)&&i.push(n+" "+c*u+"px "+d*p+"px "+h+"px");i.push(n+" "+c*s+"px "+d*a+"px "+h+"px")}if(o||l){var f=o>0?1:-1,m=l>0?1:-1;o=Math.abs(o),l=Math.abs(l);for(var u=Math.max(s,o-s);o+s>u;u++)for(var p=Math.max(a,l-a);l+a>p;p++)i.push(r+" "+u*f+"px "+p*m+"px "+h+"px");i.push(r+" "+(o+s)*f+"px "+(l+a)*m+"px "+h+"px")}return i.join()},C=document.createElementNS(a,"svg");C.setAttributeNS(null,"class","ASS-clip-path");var _=document.createElementNS(a,"defs");C.appendChild(_);var k=function(t){if(t.clip){var e="",i="ASS-"+o(),n=1/(1<<t.clip.scale-1),s=this.tree.ScriptInfo.PlayResX,r=this.tree.ScriptInfo.PlayResY;if(null!==t.clip.dots){var l=t.clip.dots.map(function(t,e){return 1&e?t/r:t/s});e+="M"+[l[0],l[1]].join(),e+="L"+[l[0],l[3],l[2],l[3],l[2],l[1]].join()+"Z"}null!==t.clip.commands&&(e=F(t.clip.commands,s,r).d),t.clip.inverse&&(e+="M0,0L"+[0,n,n,n,n,0,0,0].join()+"Z"),t.clipPath=document.createElementNS(a,"clipPath"),t.clipPath.setAttributeNS(null,"id",i),t.clipPath.setAttributeNS(null,"clipPathUnits","objectBoundingBox");var h=document.createElementNS(a,"path");h.setAttributeNS(null,"d",e),h.setAttributeNS(null,"transform","scale("+n+")"),h.setAttributeNS(null,"clip-rule","evenodd"),t.clipPath.appendChild(h),_.appendChild(t.clipPath);var c="clip-path:url(#"+i+");";return"-webkit-"+c+c}return""},T=function(t){var e=t.Layer,i=this.width-Math.floor(this.scale*(t.MarginL+t.MarginR)),n=this.height,a=t.width,r=t.height,o=Math.floor(this.scale*t.MarginV),l=this.video.currentTime,h=0;s[e]=s[e]||{left:new Uint16Array(n+1),center:new Uint16Array(n+1),right:new Uint16Array(n+1),leftEnd:new Uint32Array(n+1),centerEnd:new Uint32Array(n+1),rightEnd:new Uint32Array(n+1)};var c=["right","left","center"][t.Alignment%3],d=function(t){var n=s[e].left[t],r=s[e].center[t],o=s[e].right[t],h=s[e].leftEnd[t]/100,d=s[e].centerEnd[t]/100,u=s[e].rightEnd[t]/100;return"left"===c&&(h>l&&n||d>l&&r&&2*a+r>i||u>l&&o&&a+o>i)?!0:"center"===c&&(h>l&&n&&2*n+a>i||d>l&&r||u>l&&o&&2*o+a>i)?!0:"right"===c&&(h>l&&n&&n+a>i||d>l&&r&&2*a+r>i||u>l&&o)?!0:!1},u=function(e){return d(e)?h=0:h++,h>=r?(t.channel=e,!0):!1};if(t.Alignment<=3)for(var p=n-o-1;p>o&&!u(p);p--);else if(t.Alignment>=7)for(var p=o+1;n-o>p&&!u(p);p++);else for(var p=n-r>>1;n-o>p&&!u(p);p++);t.Alignment>3&&(t.channel-=r-1);for(var p=t.channel;p<t.channel+r;p++)s[e][c][p]=a,s[e][c+"End"][p]=100*t.End;return t.channel},L=function(t,e,i){var n=e.tags,s=this.scale/(1<<n.p-1),r=(n.fscx?n.fscx/100:1)*s,l=(n.fscy?n.fscy/100:1)*s,h=F(e.commands),c=[h.minX,h.minY,h.width,h.height].join(" "),d="ASS-"+o(),u="ASS-"+o(),p=this.tree.ScriptInfo.ScaledBorderAndShadow,f=/Yes/i.test(p)?this.scale:1,m="http://www.w3.org/1999/xlink",g=n.blur||0,x=n.xbord+(n.xshad<0?-n.xshad:0)+g,v=n.ybord+(n.yshad<0?-n.yshad:0)+g,S=h.width*r+2*n.xbord+Math.abs(n.xshad)+2*g,y=h.height*r+2*n.ybord+Math.abs(n.yshad)+2*g,b=document.createElementNS(a,"svg");b.setAttributeNS(null,"width",S),b.setAttributeNS(null,"height",y),b.setAttributeNS(null,"viewBox",[-x,-v,S,y].join(" "));var A=document.createElementNS(a,"defs");A.appendChild(E(n,d,f)),b.appendChild(A);var w=document.createElementNS(a,"symbol");w.setAttributeNS(null,"id",u),w.setAttributeNS(null,"viewBox",c),b.appendChild(w);var N=document.createElementNS(a,"path");N.setAttributeNS(null,"d",h.d),w.appendChild(N);var M=document.createElementNS(a,"use");return M.setAttributeNS(null,"width",h.width*r),M.setAttributeNS(null,"height",h.height*l),M.setAttributeNS(m,"xlink:href","#"+u),M.setAttributeNS(null,"filter","url(#"+d+")"),b.appendChild(M),t.style.cssText+="position:relative;width:"+h.width*r+"px;height:"+h.height*l+"px;",b.style.cssText="position:absolute;left:"+(h.minX*r-x)+"px;top:"+(h.minY*l-v)+"px;",b},F=function(t,e,i){e=e||1,i=i||1;for(var n=Number.MAX_VALUE,s=Number.MAX_VALUE,a=Number.MIN_VALUE,r=Number.MIN_VALUE,o=[],l=t.length,h=0;l>h;h++)t[h].points.forEach(function(t){n=Math.min(n,t.x),s=Math.min(s,t.y),a=Math.max(a,t.x),r=Math.max(r,t.y),t.x/=e,t.y/=i}),o.push(t[h].toString()),t[h].points.forEach(function(t){t.x*=e,t.y*=i});return{d:o.join("")+"Z",minX:n,minY:s,width:a-n,height:r-s}},j={},R=document.createElement("div");R.className="ASS-fix-font-size",R.textContent="M";var B=function(t,e){var i=e+"-"+t;if(!j[i]){var n="font-size:"+t+"px;font-family:'"+e+"',Arial;";R.style.cssText=n,j[i]=t*t/R.clientHeight}return j[i]},I=function(t){var e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/),i=1-("0x"+e[1])/255,n=+("0x"+e[2]),s=+("0x"+e[3]),a=+("0x"+e[4]);return"rgba("+[a,s,n,i].join()+")"},z=function(t){var e=[];return e.push("perspective(314px)"),e.push("rotateY("+(t.fry||0)+"deg)"),e.push("rotateX("+(t.frx||0)+"deg)"),e.push("rotateZ("+(-t.frz||0)+"deg)"),e.push("scale("+(t.p?1:(t.fscx||100)/100)+","+(t.p?1:(t.fscy||100)/100)+")"),e.push("skew("+(t.fax||0)+"rad,"+(t.fay||0)+"rad)"),e.join(" ")};return t});