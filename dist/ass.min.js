function t(t){const e=t.toLowerCase().trim().split(/\s*;\s*/);return"banner"===e[0]?{name:e[0],delay:1*e[1]||0,leftToRight:1*e[2]||0,fadeAwayWidth:1*e[3]||0}:/^scroll\s/.test(e[0])?{name:e[0],y1:Math.min(1*e[1],1*e[2]),y2:Math.max(1*e[1],1*e[2]),delay:1*e[3]||0,fadeAwayHeight:1*e[4]||0}:""!==t?{name:t}:null}function e(t){return t?t.toLowerCase().replace(/([+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?)/g," $1 ").replace(/([mnlbspc])/g," $1 ").trim().replace(/\s+/g," ").split(/\s(?=[mnlbspc])/).map((t=>t.split(" ").filter(((t,e)=>!(e&&Number.isNaN(1*t)))))):[]}const s=["b","i","u","s","fsp","k","K","kf","ko","kt","fe","q","p","pbo","a","an","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"].map((t=>({name:t,regex:new RegExp(`^${t}-?\\d`)})));function n(t){const a={};for(let e=0;e<s.length;e++){const{name:n,regex:i}=s[e];if(i.test(t))return a[n]=1*t.slice(n.length),a}if(/^fn/.test(t))a.fn=t.slice(2);else if(/^r/.test(t))a.r=t.slice(1);else if(/^fs[\d+-]/.test(t))a.fs=t.slice(2);else if(/^\d?c&?H?[0-9a-fA-F]+|^\d?c$/.test(t)){const[,e,s]=t.match(/^(\d?)c&?H?(\w*)/);a[`c${e||1}`]=s&&`000000${s}`.slice(-6)}else if(/^\da&?H?[0-9a-fA-F]+/.test(t)){const[,e,s]=t.match(/^(\d)a&?H?([0-9a-f]+)/i);a[`a${e}`]=`00${s}`.slice(-2)}else if(/^alpha&?H?[0-9a-fA-F]+/.test(t))[,a.alpha]=t.match(/^alpha&?H?([0-9a-f]+)/i),a.alpha=`00${a.alpha}`.slice(-2);else if(/^(?:pos|org|move|fad|fade)\([^)]+/.test(t)){const[,e,s]=t.match(/^(\w+)\((.*?)\)?$/);a[e]=s.trim().split(/\s*,\s*/).map(Number)}else if(/^i?clip\([^)]+/.test(t)){const s=t.match(/^i?clip\((.*?)\)?$/)[1].trim().split(/\s*,\s*/);a.clip={inverse:/iclip/.test(t),scale:1,drawing:null,dots:null},1===s.length&&(a.clip.drawing=e(s[0])),2===s.length&&(a.clip.scale=1*s[0],a.clip.drawing=e(s[1])),4===s.length&&(a.clip.dots=s.map(Number))}else if(/^t\(/.test(t)){const e=t.match(/^t\((.*?)\)?$/)[1].trim().replace(/\\.*/,(t=>t.replace(/,/g,"\n"))).split(/\s*,\s*/);if(!e[0])return a;a.t={t1:0,t2:0,accel:1,tags:e[e.length-1].replace(/\n/g,",").split("\\").slice(1).map(n)},2===e.length&&(a.t.accel=1*e[0]),3===e.length&&(a.t.t1=1*e[0],a.t.t2=1*e[1]),4===e.length&&(a.t.t1=1*e[0],a.t.t2=1*e[1],a.t.accel=1*e[2])}return a}function a(t){const e=[];let s=0,a="";const i=t.split("\\").slice(1).concat("").join("\\");for(let t=0;t<i.length;t++){const n=i[t];"("===n&&s++,")"===n&&s--,s<0&&(s=0),s||"\\"!==n?a+=n:(a&&e.push(a),a="")}return e.map(n)}function i(t){const s=t.split(/{([^{}]*?)}/),n=[];s[0].length&&n.push({tags:[],text:s[0],drawing:[]});for(let t=1;t<s.length;t+=2){const i=a(s[t]),r=i.reduce(((t,e)=>void 0===e.p?t:!!e.p),!1);n.push({tags:i,text:r?"":s[t+1],drawing:r?e(s[t+1]):[]})}return{raw:t,combined:n.map((t=>t.text)).join(""),parsed:n}}function r(t){const e=t.split(":");return 3600*e[0]+60*e[1]+1*e[2]}function o(e,s){let n=e.split(",");if(n.length>s.length){const t=n.slice(s.length-1).join();n=n.slice(0,s.length-1),n.push(t)}const a={};for(let e=0;e<n.length;e++){const o=s[e],l=n[e].trim();switch(o){case"Layer":case"MarginL":case"MarginR":case"MarginV":a[o]=1*l;break;case"Start":case"End":a[o]=r(l);break;case"Effect":a[o]=t(l);break;case"Text":a[o]=i(l);break;default:a[o]=l}}return a}const l=Object.assign||function(t,...e){for(let s=0;s<e.length;s++){if(!e[s])continue;const n=Object.keys(e[s]);for(let a=0;a<n.length;a++)t[n[a]]=e[s][n[a]]}return t},c=["Name","Fontname","Fontsize","PrimaryColour","SecondaryColour","OutlineColour","BackColour","Bold","Italic","Underline","StrikeOut","ScaleX","ScaleY","Spacing","Angle","BorderStyle","Outline","Shadow","Alignment","MarginL","MarginR","MarginV","Encoding"],d=["Layer","Start","End","Style","Name","MarginL","MarginR","MarginV","Effect","Text"];function f(t){const e=c.concat(d);return t.match(/Format\s*:\s*(.*)/i)[1].split(/\s*,\s*/).map((t=>e.find((e=>e.toLowerCase()===t.toLowerCase()))||t))}function p(t,e){const s=t.match(/Style\s*:\s*(.*)/i)[1].split(/\s*,\s*/);return l({},...e.map(((t,e)=>({[t]:s[e]}))))}function h(t){const e={type:null,prev:null,next:null,points:[]};/[mnlbs]/.test(t[0])&&(e.type=t[0].toUpperCase().replace("N","L").replace("B","C"));for(let s=t.length-!(1&t.length),n=1;n<s;n+=2)e.points.push({x:1*t[n],y:1*t[n+1]});return e}function u(t){return!(!t.points.length||!t.type)&&!(/C|S/.test(t.type)&&t.points.length<3)}function g(t){return t.map((({type:t,points:e})=>t+e.map((({x:t,y:e})=>`${t},${e}`)).join(","))).join("")}function y(t){const e=[];let s=0;for(;s<t.length;){const n=t[s],a=h(n);if(u(a)){if("S"===a.type){const{x:t,y:n}=(e[s-1]||{points:[{x:0,y:0}]}).points.slice(-1)[0];a.points.unshift({x:t,y:n})}s&&(a.prev=e[s-1].type,e[s-1].next=a.type),e.push(a),s++}else{if(s&&"S"===e[s-1].type){const t={p:a.points,c:e[s-1].points.slice(0,3)};e[s-1].points=e[s-1].points.concat((t[n[0]]||[]).map((({x:t,y:e})=>({x:t,y:e}))))}t.splice(s,1)}}const n=[].concat(...e.map((({type:t,points:e,prev:s,next:n})=>"S"===t?function(t,e,s){const n=[],a=[0,2/3,1/3,0],i=[0,1/3,2/3,0],r=[0,1/6,2/3,1/6],o=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3];let l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x],c=[t[t.length-1].y,t[0].y,t[1].y,t[2].y];n.push({type:"M"===e?"M":"L",points:[{x:o(r,l),y:o(r,c)}]});for(let e=3;e<t.length;e++)l=[t[e-3].x,t[e-2].x,t[e-1].x,t[e].x],c=[t[e-3].y,t[e-2].y,t[e-1].y,t[e].y],n.push({type:"C",points:[{x:o(a,l),y:o(a,c)},{x:o(i,l),y:o(i,c)},{x:o(r,l),y:o(r,c)}]});if("L"===s||"C"===s){const e=t[t.length-1];n.push({type:"L",points:[{x:e.x,y:e.y}]})}return n}(e,s,n):{type:t,points:e})));return l({instructions:n,d:g(n)},function(t){let e=1/0,s=1/0,n=-1/0,a=-1/0;return[].concat(...t.map((({points:t})=>t))).forEach((({x:t,y:i})=>{e=Math.min(e,t),s=Math.min(s,i),n=Math.max(n,t),a=Math.max(a,i)})),{minX:e,minY:s,width:n-e,height:a-s}}(e))}const m=["fs","clip","c1","c2","c3","c4","a1","a2","a3","a4","alpha","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function x(t,e,s={}){let n=t[e];if(void 0===n)return null;if("pos"===e||"org"===e)return 2===n.length?{[e]:{x:n[0],y:n[1]}}:null;if("move"===e){const[t,e,s,a,i=0,r=0]=n;return 4===n.length||6===n.length?{move:{x1:t,y1:e,x2:s,y2:a,t1:i,t2:r}}:null}if("fad"===e||"fade"===e){if(2===n.length){const[t,e]=n;return{fade:{type:"fad",t1:t,t2:e}}}if(7===n.length){const[t,e,s,a,i,r,o]=n;return{fade:{type:"fade",a1:t,a2:e,a3:s,t1:a,t2:i,t3:r,t4:o}}}return null}if("clip"===e){const{inverse:t,scale:e,drawing:s,dots:a}=n;if(s)return{clip:{inverse:t,scale:e,drawing:y(s),dots:a}};if(a){const[n,i,r,o]=a;return{clip:{inverse:t,scale:e,drawing:s,dots:{x1:n,y1:i,x2:r,y2:o}}}}return null}if(/^[xy]?(bord|shad)$/.test(e)&&(n=Math.max(n,0)),"bord"===e)return{xbord:n,ybord:n};if("shad"===e)return{xshad:n,yshad:n};if(/^c\d$/.test(e))return{[e]:n||s[e]};if("alpha"===e)return{a1:n,a2:n,a3:n,a4:n};if("fr"===e)return{frz:n};if("fs"===e)return{fs:/^\+|-/.test(n)?(1*n>-10?1+n/10:1)*s.fs:1*n};if("K"===e)return{kf:n};if("t"===e){const{t1:t,accel:e,tags:a}=n,i=n.t2||1e3*(s.end-s.start),r={};return a.forEach((t=>{const e=Object.keys(t)[0];~m.indexOf(e)&&("clip"!==e||t[e].dots)&&l(r,x(t,e,s))})),{t:{t1:t,t2:i,accel:e,tag:r}}}return{[e]:n}}const b=[null,1,2,3,null,7,8,9,null,4,5,6],v=["r","a","an","pos","org","move","fade","fad","clip"];function $({styles:t,style:e,parsed:s,start:n,end:a}){let i,r,o,c,d,f;const p=[];let h={style:e,fragments:[]},u={};for(let m=0;m<s.length;m++){const{tags:$,text:w,drawing:S}=s[m];let k;for(let t=0;t<$.length;t++){const e=$[t];k=void 0===e.r?k:e.r}const M={tag:void 0===k?(g=u,JSON.parse(JSON.stringify(l({},g,{k:void 0,kf:void 0,ko:void 0,kt:void 0})))):{},text:w,drawing:S.length?y(S):null};for(let s=0;s<$.length;s++){const p=$[s];i=i||b[p.a||0]||p.an,r=r||x(p,"pos"),o=o||x(p,"org"),c=c||x(p,"move"),d=d||x(p,"fade")||x(p,"fad"),f=x(p,"clip")||f;const h=Object.keys(p)[0];if(h&&!~v.indexOf(h)){const s=t[e].tag,{c1:i,c2:r,c3:o,c4:c}=s,d=x(p,h,{start:n,end:a,c1:i,c2:r,c3:o,c4:c,fs:u.fs||s.fs});"t"===h?(M.tag.t=M.tag.t||[],M.tag.t.push(d.t)):l(M.tag,d)}}if(u=M.tag,void 0!==k&&(p.push(h),h={style:t[k]?k:e,fragments:[]}),M.text||M.drawing){const t=h.fragments[h.fragments.length-1]||{};t.text&&M.text&&!Object.keys(M.tag).length?t.text+=M.text:h.fragments.push(M)}}var g;return p.push(h),l({alignment:i,slices:p},r,o,c,d,f)}function w({styles:t,dialogues:e}){let s=1/0;const n=[];for(let a=0;a<e.length;a++){const i=e[a];if(i.Start>=i.End)continue;t[i.Style]||(i.Style="Default");const r=t[i.Style].style,o=$({styles:t,style:i.Style,parsed:i.Text.parsed,start:i.Start,end:i.End}),c=o.alignment||r.Alignment;s=Math.min(s,i.Layer),n.push(l({layer:i.Layer,start:i.Start,end:i.End,style:i.Style,name:i.Name,margin:{left:i.MarginL||r.MarginL,right:i.MarginR||r.MarginR,vertical:i.MarginV||r.MarginV},effect:i.Effect},o,{alignment:c}))}for(let t=0;t<n.length;t++)n[t].layer-=s;return n.sort(((t,e)=>t.start-e.start||t.end-e.end))}const S={Name:"Default",Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF&",SecondaryColour:"&H000000FF&",OutlineColour:"&H00000000&",BackColour:"&H00000000&",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2",Alignment:"2",MarginL:"10",MarginR:"10",MarginV:"10",Encoding:"1"};function k(t){if(/^(&|H|&H)[0-9a-f]{6,}/i.test(t)){const[,e,s]=t.match(/&?H?([0-9a-f]{2})?([0-9a-f]{6})/i);return[e||"00",s]}const e=parseInt(t,10);if(!Number.isNaN(e)){const t=-2147483648;if(e<t)return["00","000000"];const s=t<=e&&e<=2147483647?`00000000${(e<0?e+4294967296:e).toString(16)}`.slice(-8):String(e).slice(0,8);return[s.slice(0,2),s.slice(2)]}return["00","000000"]}function M(t,e={}){const s=function(t){const e={info:{},styles:{format:[],style:[]},events:{format:[],comment:[],dialogue:[]}},s=t.split(/\r?\n/);let n=0;for(let t=0;t<s.length;t++){const a=s[t].trim();if(!/^;/.test(a)&&(/^\[Script Info\]/i.test(a)?n=1:/^\[V4\+? Styles\]/i.test(a)?n=2:/^\[Events\]/i.test(a)?n=3:/^\[.*\]/.test(a)&&(n=0),0!==n)){if(1===n&&/:/.test(a)){const[,t,s]=a.match(/(.*?)\s*:\s*(.*)/);e.info[t]=s}if(2===n&&(/^Format\s*:/i.test(a)&&(e.styles.format=f(a)),/^Style\s*:/i.test(a)&&e.styles.style.push(p(a,e.styles.format))),3===n&&(/^Format\s*:/i.test(a)&&(e.events.format=f(a)),/^(?:Comment|Dialogue)\s*:/i.test(a))){const[,t,s]=a.match(/^(\w+?)\s*:\s*(.*)/i);e.events[t.toLowerCase()].push(o(s,e.events.format))}}}return e}(t),n=function({info:t,style:e,defaultStyle:s}){const n={},a=[l({},s,{Name:"Default"})].concat(e);for(let e=0;e<a.length;e++){const s=l({},S,a[e]);/^(\*+)Default$/.test(s.Name)&&(s.Name="Default"),Object.keys(s).forEach((t=>{"Name"===t||"Fontname"===t||/Colour/.test(t)||(s[t]*=1)}));const[i,r]=k(s.PrimaryColour),[o,c]=k(s.SecondaryColour),[d,f]=k(s.OutlineColour),[p,h]=k(s.BackColour),u={fn:s.Fontname,fs:s.Fontsize,c1:r,a1:i,c2:c,a2:o,c3:f,a3:d,c4:h,a4:p,b:Math.abs(s.Bold),i:Math.abs(s.Italic),u:Math.abs(s.Underline),s:Math.abs(s.StrikeOut),fscx:s.ScaleX,fscy:s.ScaleY,fsp:s.Spacing,frz:s.Angle,xbord:s.Outline,ybord:s.Outline,xshad:s.Shadow,yshad:s.Shadow,fe:s.Encoding,q:/^[0-3]$/.test(t.WrapStyle)?1*t.WrapStyle:2};n[s.Name]={style:s,tag:u}}return n}({info:s.info,style:s.styles.style,defaultStyle:e.defaultStyle||{}});return{info:s.info,width:1*s.info.PlayResX||null,height:1*s.info.PlayResY||null,collisions:s.info.Collisions||"Normal",styles:n,dialogues:w({styles:n,dialogues:s.events.dialogue})}}const A=document.createElement("div");A.className="ASS-fix-font-size",A.textContent="M";const E=Object.create(null);function N(t,e){const s=`${t}-${e}`;return E[s]||(A.style.cssText=`line-height:normal;font-size:${e}px;font-family:"${t}",Arial;`,E[s]=e*e/A.clientHeight),E[s]}function C(t){return 1-`0x${t}`/255}function O(t){const e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/),s=C(e[1]),n=+`0x${e[2]}`,a=+`0x${e[3]}`;return`rgba(${+`0x${e[4]}`},${a},${n},${s})`}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=Math.trunc(16*Math.random());return("x"===t?e:3&e|8).toString(16)}))}function L(t,e=[]){const s=document.createElementNS("http://www.w3.org/2000/svg",t);for(let t=0;t<e.length;t+=1){const n=e[t];s.setAttributeNS("xlink:href"===n[0]?"http://www.w3.org/1999/xlink":null,n[0],n[1])}return s}const F={clipPath:function(t){const{style:e}=document.body,s=t.replace(/^\w/,(t=>t.toUpperCase()));return t in e?"":`webkit${s}`in e?"-webkit-":`moz${s}`in e?"-moz-":""}("clipPath")};const z=["fscx","fscy","frx","fry","frz","fax","fay"];function B(t,e,s){const n=t.animate(e,s);return n.pause(),n}function R(t,e){(t.animations||[]).forEach((t=>{t[e]()}))}function T(t,e){if(!t.clip)return{};const s=document.createElement("div");e.box.insertBefore(s,t.$div),s.append(t.$div),s.className="ASS-fix-objectBoundingBox";const{cssText:n,$clipPath:a}=function(t,e){const s=e.scriptRes.width,n=e.scriptRes.height;let a="";if(null!==t.dots){let{x1:e,y1:i,x2:r,y2:o}=t.dots;e/=s,i/=n,r/=s,o/=n,a=`M${e},${i}L${e},${o},${r},${o},${r},${i}Z`}null!==t.drawing&&(a=t.drawing.instructions.map((({type:t,points:e})=>t+e.map((({x:t,y:e})=>`${t/s},${e/n}`)).join(","))).join(""));const i=1/(1<<t.scale-1);t.inverse&&(a+=`M0,0L0,${i},${i},${i},${i},0,0,0Z`);const r=`ASS-${j()}`,o=L("clipPath",[["id",r],["clipPathUnits","objectBoundingBox"]]);return o.append(L("path",[["d",a],["transform",`scale(${i})`],["clip-rule","evenodd"]])),e.defs.append(o),{$clipPath:o,cssText:`${F.clipPath}clip-path:url(#${r});`}}(t.clip,e);return e.defs.append(a),s.style.cssText=n,{$div:s,$clipPath:a}}function _([t,e]){return[[0,0],[0,1],[1,0],[1,1]].filter((([s,n])=>(s||t)&&(n||e))).map((([s,n])=>[(s||-1)*t,(n||-1)*e]))}function H(t,e){const s=O(`00${t.c3}`),n=t.xbord*e,a=t.ybord*e,i=O(`00${t.c4}`),r=t.xshad*e,o=t.yshad*e,l=t.blur||t.be||0,c=function(t,e){if(t===e)return[];const s=Math.min(t,e),n=Math.max(t,e);return Array.from({length:Math.ceil(n)-1},((t,e)=>e+1)).concat(n).map((t=>[(n-t)/n*s,t])).map((([s,n])=>t>e?[n,s]:[s,n])).flatMap(_)}(n,a);return[{key:"border-width",value:2*Math.min(n,a)+"px"},{key:"border-color",value:s},{key:"border-opacity",value:C(t.a3)},{key:"border-delta",value:c.map((([t,e])=>`${t}px ${e}px ${s}`)).join(",")},{key:"shadow-offset",value:`${r}px, ${o}px`},{key:"shadow-color",value:i},{key:"shadow-opacity",value:C(t.a4)},{key:"shadow-delta",value:c.map((([t,e])=>`${t}px ${e}px ${i}`)).join(",")},{key:"blur",value:`blur(${l}px)`}].map((t=>Object.assign(t,{key:`--ass-${t.key}`})))}function q(t,e,s){if(!t.drawing.d)return null;const{scale:n,info:a}=s,i={...e,...t.tag},{minX:r,minY:o,width:l,height:c}=t.drawing,d=n/(1<<i.p-1),f=(i.fscx?i.fscx/100:1)*d,p=(i.fscy?i.fscy/100:1)*d,h=i.blur||i.be||0,u=i.xbord+(i.xshad<0?-i.xshad:0)+h,g=i.ybord+(i.yshad<0?-i.yshad:0)+h,y=l*f+2*i.xbord+Math.abs(i.xshad)+2*h,m=c*p+2*i.ybord+Math.abs(i.yshad)+2*h,x=L("svg",[["width",y],["height",m],["viewBox",`${-u} ${-g} ${y} ${m}`]]),b=/yes/i.test(a.ScaledBorderAndShadow)?n:1,v=`ASS-${j()}`,$=L("defs");$.append(function(t,e,s){const n=t.xbord||t.ybord,a=t.xshad||t.yshad,i="FF"!==t.a1,r=t.blur||t.be||0,o=L("filter",[["id",e]]);o.append(L("feGaussianBlur",[["stdDeviation",n?0:r],["in","SourceGraphic"],["result","sg_b"]])),o.append(L("feFlood",[["flood-color",O(t.a1+t.c1)],["result","c1"]])),o.append(L("feComposite",[["operator","in"],["in","c1"],["in2","sg_b"],["result","main"]])),n&&(o.append(L("feMorphology",[["radius",`${t.xbord*s} ${t.ybord*s}`],["operator","dilate"],["in","SourceGraphic"],["result","dil"]])),o.append(L("feGaussianBlur",[["stdDeviation",r],["in","dil"],["result","dil_b"]])),o.append(L("feComposite",[["operator","out"],["in","dil_b"],["in2","SourceGraphic"],["result","dil_b_o"]])),o.append(L("feFlood",[["flood-color",O(t.a3+t.c3)],["result","c3"]])),o.append(L("feComposite",[["operator","in"],["in","c3"],["in2","dil_b_o"],["result","border"]]))),a&&(n||i)&&(o.append(L("feOffset",[["dx",t.xshad*s],["dy",t.yshad*s],["in",n?"dil":"SourceGraphic"],["result","off"]])),o.append(L("feGaussianBlur",[["stdDeviation",r],["in","off"],["result","off_b"]])),i||(o.append(L("feOffset",[["dx",t.xshad*s],["dy",t.yshad*s],["in","SourceGraphic"],["result","sg_off"]])),o.append(L("feComposite",[["operator","out"],["in","off_b"],["in2","sg_off"],["result","off_b_o"]]))),o.append(L("feFlood",[["flood-color",O(t.a4+t.c4)],["result","c4"]])),o.append(L("feComposite",[["operator","in"],["in","c4"],["in2",i?"off_b":"off_b_o"],["result","shadow"]])));const l=L("feMerge",[]);return a&&(n||i)&&l.append(L("feMergeNode",[["in","shadow"]])),n&&l.append(L("feMergeNode",[["in","border"]])),l.append(L("feMergeNode",[["in","main"]])),o.append(l),o}(i,v,b)),x.append($);const w=`ASS-${j()}`,S=L("symbol",[["id",w],["viewBox",`${r} ${o} ${l} ${c}`]]);return S.append(L("path",[["d",t.drawing.d]])),x.append(S),x.append(L("use",[["width",l*f],["height",c*p],["xlink:href",`#${w}`],["filter",`url(#${v})`]])),x.style.cssText=`position:absolute;left:${r*f-u}px;top:${o*p-g}px;`,{$svg:x,cssText:`position:relative;width:${l*f}px;height:${c*p}px;`}}function P(t){return["perspective(314px)",`rotateY(${t.fry||0}deg)`,`rotateX(${t.frx||0}deg)`,`rotateZ(${-t.frz||0}deg)`,`scale(${t.p?1:(t.fscx||100)/100},${t.p?1:(t.fscy||100)/100})`,`skew(${t.fax||0}rad,${t.fay||0}rad)`].join(" ")}function I(t,e){const{video:s,space:n,scale:a}=e,{layer:i,margin:r,width:o,height:l,alignment:c,end:d}=t,f=e.width-Math.trunc(a*(r.left+r.right)),p=e.height,h=Math.trunc(a*r.vertical),u=100*s.currentTime;n[i]=n[i]||{left:{width:new Uint16Array(p+1),end:new Uint32Array(p+1)},center:{width:new Uint16Array(p+1),end:new Uint32Array(p+1)},right:{width:new Uint16Array(p+1),end:new Uint32Array(p+1)}};const g=n[i],y=["right","left","center"][c%3];let m=0,x=0;const b=t=>(m=(t=>{const e=g.left.width[t],s=g.center.width[t],n=g.right.width[t],a=g.left.end[t],i=g.center.end[t],r=g.right.end[t];return"left"===y&&(a>u&&e||i>u&&s&&2*o+s>f||r>u&&n&&o+n>f)||"center"===y&&(a>u&&e&&2*e+o>f||i>u&&s||r>u&&n&&2*n+o>f)||"right"===y&&(a>u&&e&&e+o>f||i>u&&s&&2*o+s>f||r>u&&n)})(t)?0:m+1,m>=l&&(x=t,!0));if(c<=3){x=p-h-1;for(let t=x;t>h&&!b(t);t-=1);}else if(c>=7){x=h+1;for(let t=x;t<p-h&&!b(t);t+=1);}else{x=p-l>>1;for(let t=x;t<p-h&&!b(t);t+=1);}c>3&&(x-=l-1);for(let t=x;t<x+l;t+=1)g[y].width[t]=o,g[y].end[t]=100*d;return x}function U(t,e){const s=function(t,e){const{video:s,styles:n,info:a}=e,i=document.createElement("div");i.className="ASS-dialogue";const r=document.createDocumentFragment(),{slices:o,start:l,end:c}=t,d={duration:1e3*(c-l),delay:1e3*Math.min(0,l-(s.currentTime-e.delay)),fill:"forwards"};return i.animations=[],o.forEach((t=>{const s=n[t.style].tag,o=n[t.style].style.BorderStyle;t.fragments.forEach((t=>{const{text:n,drawing:l}=t,c={...s,...t.tag};let f="display:inline-block;";const p=[];if(!l){f+=`line-height:normal;font-family:"${c.fn}",Arial;`,f+=`font-size:${e.scale*N(c.fn,c.fs)}px;`,f+=`color:${O(c.a1+c.c1)};`;const t=/yes/i.test(a.ScaledBorderAndShadow)?e.scale:1;if(1===o&&p.push(...H(c,t)),3===o){const e=O(c.a3+c.c3),s=c.xbord*t,n=c.ybord*t,a=O(c.a4+c.c4),i=c.xshad*t,r=c.yshad*t;f+=(s||n?`background-color:${e};`:"")+`border:0 solid ${e};`+`border-width:${s}px ${n}px;`+`margin:${-s}px ${-n}px;`+`box-shadow:${i}px ${r}px ${a};`}f+=c.b?`font-weight:${1===c.b?"bold":c.b};`:"",f+=c.i?"font-style:italic;":"",f+=c.u||c.s?`text-decoration:${c.u?"underline":""} ${c.s?"line-through":""};`:"",f+=c.fsp?`letter-spacing:${e.scale*c.fsp}px;`:"",0!==c.q&&3!==c.q||(f+="text-wrap:balance;"),1===c.q&&(f+="word-break:break-all;white-space:normal;"),2===c.q&&(f+="word-break:normal;white-space:nowrap;")}if(z.some((t=>/^fsc[xy]$/.test(t)?100!==c[t]:!!c[t]))&&(f+=`transform:${P(c)};`,l||(f+="transform-style:preserve-3d;word-break:normal;white-space:nowrap;")),l&&c.pbo){const t=e.scale*-c.pbo*(c.fscy||100)/100;f+=`vertical-align:${t}px;`}const h=/"fr[x-z]":[^0]/.test(JSON.stringify(c));(function(t,e){return t.replace(/\\h/g," ").replace(/\\N/g,"\n").replace(/\\n/g,2===e?"\n":" ")})(n,c.q).split("\n").forEach(((n,a)=>{const o=document.createElement("span");if(h&&(o.dataset.hasRotate=""),l){const n=q(t,s,e);if(!n)return;o.style.cssText=n.cssText,o.append(n.$svg)}else{if(a&&r.append(document.createElement("br")),!n)return;o.textContent=n,(c.xbord||c.ybord||c.xshad||c.yshad)&&(o.dataset.stroke=n)}if(o.style.cssText+=f,p.forEach((({key:t,value:e})=>{o.style.setProperty(t,e)})),t.keyframes){const e=B(o,t.keyframes,{...d,duration:t.duration});i.animations.push(e)}r.append(o)}))}))})),t.keyframes&&i.animations.push(B(i,t.keyframes,d)),i.append(r),i}(t,e);Object.assign(t,{$div:s}),e.box.append(s);const{width:n}=s.getBoundingClientRect();Object.assign(t,{width:n}),s.style.cssText+=function(t,e){const{layer:s,align:n,effect:a,pos:i,margin:r,width:o}=t;let l="";s&&(l+=`z-index:${s};`),l+=`text-align:${["left","center","right"][n.h]};`,a||(l+=`max-width:${e.width-e.scale*(r.left+r.right)}px;`,i||(0===n.h&&(l+=`margin-left:${e.scale*r.left}px;`),2===n.h&&(l+=`margin-right:${e.scale*r.right}px;`),o>e.width-e.scale*(r.left+r.right)&&(l+=`margin-left:${e.scale*r.left}px;`,l+=`margin-right:${e.scale*r.right}px;`)));return l}(t,e);const{height:a}=s.getBoundingClientRect();Object.assign(t,{height:a});const{x:i,y:r}=function(t,e){const{scale:s}=e,{effect:n,move:a,align:i,width:r,height:o,margin:l,slices:c}=t;let d=0,f=0;if(n)"banner"===n.name&&(d=n.lefttoright?-r:e.width,f=[e.height-o-l.vertical,(e.height-o)/2,l.vertical][i.v]);else if(t.pos||a){const e=t.pos||{x:0,y:0},n=s*e.x,a=s*e.y;d=[n,n-r/2,n-r][i.h],f=[a-o,a-o/2,a][i.v]}else d=[0,(e.width-r)/2,e.width-r-s*l.right][i.h],f=c.some((t=>t.fragments.some((({animationName:t})=>t))))?[e.height-o-l.vertical,(e.height-o)/2,l.vertical][i.v]:I(t,e);return{x:d,y:f}}(t,e);return Object.assign(t,{x:i,y:r}),s.style.cssText+=`width:${n}px;height:${a}px;left:${i}px;top:${r}px;`,function(t,e){const{align:s,width:n,height:a,x:i,y:r,$div:o}=t,l={};t.org?(l.x=t.org.x*e,l.y=t.org.y*e):(l.x=[i,i+n/2,i+n][s.h],l.y=[r+a,r+a/2,r][s.v]);for(let t=o.childNodes.length-1;t>=0;t-=1){const e=o.childNodes[t];if(""===e.dataset.hasRotate){const t=l.x-i-e.offsetLeft,s=l.y-r-e.offsetTop;e.style.cssText+=`transform-origin:${t}px ${s}px;`}}}(t,e.scale),Object.assign(t,T(t,e)),t}function D({effect:t,duration:e},s){const{name:n,delay:a,lefttoright:i,y1:r}=t,o=t.y2||s.resampledRes.height;if("banner"===n){return[0,`${s.scale*(e/a)*(i?1:-1)}px`].map(((t,e)=>({offset:e,transform:`translateX(${t})`})))}if(n.startsWith("scroll")){const t=/up/.test(n)?-1:1,i=(o-r)/(e/a);return[r,o].map((e=>s.scale*e*t)).map(((t,e)=>({offset:Math.min(e,i),transform:`translateY${t}`})))}return[]}function G({move:t,duration:e,dialogue:s},n){const{x1:a,y1:i,x2:r,y2:o,t1:l,t2:c}=t,d=[l,c||e],f=s.pos||{x:0,y:0};return[[a,i],[r,o]].map((([t,e])=>[n.scale*(t-f.x),n.scale*(e-f.y)])).map((([t,s],n)=>({offset:Math.min(d[n]/e,1),transform:`translate(${t}px, ${s}px)`})))}function W(t,e){if("fad"===t.type){const{t1:s,t2:n}=t,a=[];return s&&a.push([0,0]),s<e?(n<=e&&a.push([s/e,1]),s+n<e&&a.push([(e-n)/e,1]),n>e?a.push([0,(n-e)/n]):s+n>e&&a.push([(s+.5)/e,1-(s+n-e)/n]),n&&a.push([1,0])):a.push([1,e/s]),a.map((([t,e])=>({offset:t,opacity:e})))}const{a1:s,a2:n,a3:a,t1:i,t2:r,t3:o,t4:l}=t,c=[s,n,a].map((t=>1-t/255));return[0,i,r,o,l,e].map((t=>t/e)).map(((t,e)=>({offset:t,opacity:c[e>>1]}))).filter((({offset:t})=>t<=1))}function X({fromTag:t,tag:e,fragment:s}){const n={...t,...e};return s.drawing&&(Object.assign(n,{p:0,fscx:(e.fscx||t.fscx)/t.fscx*100,fscy:(e.fscy||t.fscy)/t.fscy*100}),Object.assign(t,{fscx:100,fscy:100})),{transform:P(n)}}function Y(t){const{box:e,defs:s}=t;for(;e.lastChild;)e.lastChild.remove();for(;s.lastChild;)s.lastChild.remove();t.actives=[],t.space=[]}function V(t){const{video:e,dialogues:s,actives:n,resampledRes:a}=t,i=e.currentTime-t.delay;for(let t=n.length-1;t>=0;t-=1){const e=n[t];let{end:s}=e;if(e.effect&&/scroll/.test(e.effect.name)){const{y1:t,y2:n,delay:i}=e.effect,r=((n||a.height)-t)/(1e3/i);s=Math.min(s,e.start+r)}s<i&&(e.$div.remove(),e.$clipPath?.remove(),n.splice(t,1))}for(;t.index<s.length&&i>=s[t.index].start;){if(i<s[t.index].end){const a=U(s[t.index],t);e.paused||R(a.$div,"play"),n.push(a)}t.index+=1}}function J(t){return function(){Y(t);const{video:e,dialogues:s}=t,n=e.currentTime-t.delay;t.index=(()=>{let t=0;const e=s.length-1;for(;t+1<e&&n>s[e+t>>1].end;)t=e+t>>1;if(!t)return 0;for(let a=t;a<e;a+=1)if(s[a].end>n&&n>=s[a].start||a&&s[a-1].end<n&&n<s[a].start)return a;return e})(),V(t)}}function Z(t,e){const{video:s,box:n,svg:a,dialogues:i}=e;return function(){const r=s.clientWidth,o=s.clientHeight,l=s.videoWidth||r,c=s.videoHeight||o,d=e.scriptRes.width,f=e.scriptRes.height;let p=d,h=f;const u=Math.min(r/l,o/c);"video_width"===t.resampling&&(h=d/l*c),"video_height"===t.resampling&&(p=f/c*l),e.scale=Math.min(r/p,o/h),"script_width"===t.resampling&&(e.scale=u*(l/p)),"script_height"===t.resampling&&(e.scale=u*(c/h));const g=e.scale*p,y=e.scale*h;e.width=g,e.height=y,e.resampledRes={width:p,height:h};const m=`width:${g}px;height:${y}px;top:${(o-y)/2}px;left:${(r-g)/2}px;`;n.style.cssText=m,a.style.cssText=m,a.setAttributeNS(null,"viewBox",`0 0 ${d} ${f}`),i.forEach((t=>{!function(t,e){const{start:s,end:n,effect:a,move:i,fade:r,slices:o}=t,l=1e3*(n-s),c=[...a&&!i?D({effect:a,duration:l},e):[],...i?G({move:i,duration:l,dialogue:t},e):[],...r?W(r,l):[]].sort(((t,e)=>t.offset-e.offset));c.length>0&&Object.assign(t,{keyframes:c}),o.forEach((t=>{const s=e.styles[t.style].tag;t.fragments.forEach((t=>{if(!t.tag.t||0===t.tag.t.length)return;const n={...s,...t.tag},a=(i=t.tag.t,i.reduceRight(((t,e)=>{let s=!1;return t.map((t=>(s=e.t1===t.t1&&e.t2===t.t2&&e.accel===t.accel,{...t,...s?{tag:{...t.tag,...e.tag}}:{}}))).concat(s?[]:e)}),[])).sort(((t,e)=>t.t2-e.t2||t.t1-e.t1));var i;a[0].t1>0&&a.unshift({t1:0,t2:a[0].t1,tag:n}),a.reduce(((t,e)=>{const s={...t,...e.tag};return Object.assign(e.tag,s),s}),{});const r=Math.max(l,...a.map((({t2:t})=>t))),o=a.map((({t2:s,tag:a})=>{const i=void 0!==a.a1&&a.a1===a.a2&&a.a2===a.a3&&a.a3===a.a4;return{offset:s/r,...a.fs&&{"font-size":e.scale*N(a.fn,a.fs)+"px"},...a.fsp&&{"letter-spacing":e.scale*a.fsp+"px"},...(a.c1||a.a1&&!i)&&{color:O((a.a1||n.a1)+(a.c1||n.c1))},...i&&{opacity:1-Number.parseInt(a.a1,16)/255},...X({fromTag:n,tag:a,fragment:t})}})).sort(((t,e)=>t.offset-e.offset));o.length>0&&Object.assign(t,{keyframes:o,duration:r})}))}))}(t,e)})),J(e)()}}class K{#t={video:null,box:document.createElement("div"),svg:L("svg"),defs:L("defs"),observer:null,scale:1,width:0,height:0,scriptRes:{},resampledRes:{},index:0,info:{},styles:{},dialogues:[],actives:[],space:[],requestId:0,delay:0};#e;#s;#n;#a;constructor(t,e,{container:s=e.parentNode,resampling:n}={}){if(this.#t.video=e,!s)throw new Error("Missing container.");const{info:a,width:i,height:r,styles:o,dialogues:l}=M(t);this.#t.info=a,this.#t.scriptRes={width:i||e.videoWidth||e.clientWidth,height:r||e.videoHeight||e.clientHeight},this.#t.styles=o,this.#t.dialogues=l.map((t=>Object.assign(t,{align:{h:(t.alignment+2)%3,v:Math.trunc((t.alignment-1)/3)}}))),s.append(A);const{svg:c,defs:d,box:f}=this.#t;var p;c.append(d),s.append(c),f.className="ASS-box",s.append(f),function(t){const e=t.getRootNode()||document,s=e===document?document.head:e;let n=s.querySelector("#ASS-global-style");n||(n=document.createElement("style"),n.type="text/css",n.id="ASS-global-style",n.append(document.createTextNode(".ASS-box{overflow:hidden;pointer-events:none;position:absolute}.ASS-dialogue{font-size:0;position:absolute;z-index:0}.ASS-dialogue [data-stroke]{position:relative}.ASS-dialogue [data-stroke]::after,.ASS-dialogue [data-stroke]::before{content:attr(data-stroke);position:absolute;top:0;left:0;z-index:-1;filter:var(--ass-blur)}.ASS-dialogue [data-stroke]::before{color:var(--ass-shadow-color);transform:translate(var(--ass-shadow-offset));-webkit-text-stroke:var(--ass-border-width) var(--ass-shadow-color);text-shadow:var(--ass-shadow-delta);opacity:var(--ass-shadow-opacity)}.ASS-dialogue [data-stroke]::after{color:transparent;-webkit-text-stroke:var(--ass-border-width) var(--ass-border-color);text-shadow:var(--ass-border-delta);opacity:var(--ass-border-opacity)}.ASS-fix-font-size{position:absolute;visibility:hidden}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}")),s.append(n))}(s),this.#e=(p=this.#t,function(){const t=()=>{V(p),p.requestId=requestAnimationFrame(t)};cancelAnimationFrame(p.requestId),p.requestId=requestAnimationFrame(t),p.actives.forEach((({$div:t})=>{R(t,"play")}))}),this.#s=function(t){return function(){cancelAnimationFrame(t.requestId),t.requestId=0,t.actives.forEach((({$div:t})=>{R(t,"pause")}))}}(this.#t),this.#n=J(this.#t),e.addEventListener("play",this.#e),e.addEventListener("pause",this.#s),e.addEventListener("playing",this.#e),e.addEventListener("waiting",this.#s),e.addEventListener("seeking",this.#n),this.#a=Z(this,this.#t),this.#a(),this.resampling=n;const h=new ResizeObserver(this.#a);return h.observe(e),this.#t.observer=h,this}destroy(){const{video:t,box:e,svg:s,observer:n}=this.#t;return this.#s(),Y(this.#t),t.removeEventListener("play",this.#e),t.removeEventListener("pause",this.#s),t.removeEventListener("playing",this.#e),t.removeEventListener("waiting",this.#s),t.removeEventListener("seeking",this.#n),A.remove(),s.remove(),e.remove(),n.unobserve(this.#t.video),this.#t.styles={},this.#t.dialogues=[],this}show(){return this.#t.box.style.visibility="visible",this}hide(){return this.#t.box.style.visibility="hidden",this}#i="video_height";get resampling(){return this.#i}set resampling(t){t!==this.#i&&/^(video|script)_(width|height)$/.test(t)&&(this.#i=t,this.#a())}get delay(){return this.#t.delay}set delay(t){"number"==typeof t&&(this.#t.delay=t,this.#n())}}export{K as default};
