!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.ASS=e()}(this,function(){"use strict";function t(){this.tree={},this.position=0,this.runline=[],this.scale=1,this.container=document.createElement("div"),this.container.className="ASS-container",this.container.appendChild(L),this.container.appendChild(E),this.stage=document.createElement("div"),this.stage.className="ASS-stage ASS-animation-paused"}t.prototype.init=function(t,e){if(t&&"VIDEO"===e.nodeName){var i=this;if(!this.video){var n=!e.paused;this.video=e,this.video.parentNode.insertBefore(this.container,this.video),this.container.appendChild(this.video),this.container.appendChild(this.stage),this.video.addEventListener("seeking",function(){i._seek()}),this.video.addEventListener("play",function(){i._play()}),this.video.addEventListener("pause",function(){i._pause()}),n&&this.video.paused&&this.video.play()}this.tree=h(t),this.tree.ScriptInfo.PlayResX&&this.tree.ScriptInfo.PlayResY||(this.tree.ScriptInfo.PlayResX=this.video.videoWidth,this.tree.ScriptInfo.PlayResY=this.video.videoHeight);var s=[0,0,this.tree.ScriptInfo.PlayResX,this.tree.ScriptInfo.PlayResY];E.setAttributeNS(null,"viewBox",s.join(" "));var a=document.getElementById("ASS-style");return a||(a=document.createElement("style"),a.type="text/css",a.id="ASS-style",a.appendChild(document.createTextNode(o)),document.head.appendChild(a)),this.resize(),this}},t.prototype.resize=function(){if(this.video){var t=this.video.clientWidth,e=this.video.clientHeight,i=t/e,n=this.video.videoWidth,s=this.video.videoHeight,a=n/s,r=i>a?a*e:t,o=i>a?e:t/a,l=i>a?0:(e-o)/2,h=i>a?(t-r)/2:0;this.width=r,this.height=o;var c=["width:",r,"px;height:",o,"px;"];return this.container.style.cssText=c.join(""),c.push("top:",l,"px;left:",h,"px;"),this.stage.style.cssText=c.join(""),E.style.cssText=c.join(""),this.scale=Math.min(r/this.tree.ScriptInfo.PlayResX,o/this.tree.ScriptInfo.PlayResY),b.call(this),this._seek(),this}},t.prototype.show=function(){return this.stage.style.visibility="visible",this},t.prototype.hide=function(){return this.stage.style.visibility="hidden",this},t.prototype._play=function(){var t=this,i=function(){t._launch(),n=e(i)};n=e(i),this.stage.classList.remove("ASS-animation-paused")},t.prototype._pause=function(){i(n),n=0,this.stage.classList.add("ASS-animation-paused")},t.prototype._seek=function(){for(var t=this.video.currentTime,e=this.tree.Events.Dialogue;this.stage.lastChild;)this.stage.removeChild(this.stage.lastChild);for(;M.lastChild;)M.removeChild(M.lastChild);this.runline=[],a=[],this.position=function(){for(var i=0,n=e.length-1;n>i+1&&t>e[n+i>>1].End;)i=n+i>>1;if(!i)return 0;for(var s=i;n>s;++s)if(e[s].End>t&&t>=e[s].Start||s&&e[s-1].End<t&&t<e[s].Start)return s;return n}(),this._launch()},t.prototype._launch=function(){for(var t=this.video.currentTime,e=this.tree.Events.Dialogue,i=this.runline.length-1;i>=0;--i){var n=this.runline[i],s=n.End;if(n.Effect&&/scroll/.test(n.Effect.name)){var a=(n.Effect.y2-n.Effect.y1)/(1e3/n.Effect.delay);s=Math.min(s,n.Start+a)}t>s&&(this.stage.removeChild(n.node),n.clipPath&&M.removeChild(n.clipPath),this.runline.splice(i,1))}for(;this.position<e.length&&t>=e[this.position].Start;){if(t<e[this.position].End){var n=m.call(this,e[this.position]);this.runline.push(n)}++this.position}};var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)},i=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||function(t){clearTimeout(t)},n=0,s={},a=[],r="http://www.w3.org/2000/svg",o=".ASS-container{position:relative}.ASS-container video,.ASS-dialogue,.ASS-fix-font-size,.ASS-stage{position:absolute}.ASS-fix-font-size{visibility:hidden}.ASS-container video{top:0;left:0}.ASS-stage{overflow:hidden;z-index:2147483647;pointer-events:none}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}",l=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"===t?e:3&e|8;return i.toString(16)})},h=function(t){t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");for(var e={ScriptInfo:{Title:"&lt;untitled&gt;","Original Script":"&lt;unknown&gt;"},V4Styles:{Format:{},Style:{}},Events:{Format:{},Dialogue:[]}},i=t.split("\n"),n=0,a=0,r=i.length,o=0;r>o;++o)if(i[o]=i[o].replace(/^\s+|\s+$/g,""),!/^;/.test(i[o])&&(/^\[Script Info\]/i.test(i[o])?n=1:/^\[V4\+ Styles\]/i.test(i[o])?n=2:/^\[Events\]/i.test(i[o])?n=3:/^\[.*\]/.test(i[o])&&(n=0),0!==n)){if(1===n&&/:/.test(i[o])){var l=i[o].match(/(.*?)\s*:\s*(.*)/);isNaN(1*l[2])||(l[2]*=1),e.ScriptInfo[l[1]]=l[2]}if(2===n){if(/^Format:/.test(i[o])){var l=i[o].match(/Format:(.*)/);e.V4Styles.Format=l[1].replace(/\s/g,"").split(",")}if(/^Style:/.test(i[o])){for(var h=i[o].match(/Style:(.*)/)[1].split(","),c={},p=h.length-1;p>=0;--p){var m=e.V4Styles.Format[p];c[m]=h[p].replace(/^\s*/,""),isNaN(1*c[m])||(c[m]*=1)}e.V4Styles.Style[c.Name]=c,s[c.Name]=A(c),s[c.Name].q=e.ScriptInfo.WrapStyle||1}}if(3===n){if(/^Format:/.test(i[o])){var l=i[o].match(/Format:(.*)/);e.Events.Format=l[1].replace(/\s/g,"").split(",")}if(/^Dialogue:/.test(i[o])){var h=i[o].match(/Dialogue:(.*)/)[1].split(","),c={},g=e.Events.Format.length;if(h.length>g){var m=h.slice(g-1).join();h=h.slice(0,g-1),h.push(m)}for(var p=g-1;p>=0;--p)c[e.Events.Format[p]]=h[p].replace(/^\s+/,"");c.Layer*=1,c.Start=u(c.Start,e.ScriptInfo.Timer),c.End=u(c.End,e.ScriptInfo.Timer),c.Style=e.V4Styles.Style[c.Style]?c.Style:"Default",c.MarginL*=1,c.MarginR*=1,c.MarginV*=1,c.Effect=d(c.Effect,e.ScriptInfo.PlayResY),c._index=++a,c.parsedText=f(c),c.Start<c.End&&e.Events.Dialogue.push(c)}}}return e.Events.Dialogue.sort(function(t,e){return t.Start-e.Start||t.End-e.End||t._index-e._index}),e},c=function(t,e,i){function n(t,n){this.x=t/e,this.y=n/i,this.toString=function(){return this.x+","+this.y}}function s(t){this.points=[],this.type=null,this.prevType=null,this.nextType=null,/m/.test(t)&&(this.type="M"),/n|l/.test(t)&&(this.type="L"),/b/.test(t)&&(this.type="C"),/s/.test(t)&&(this.type="_S"),this.isValid=function(){return this.points.length&&this.type?/C|S/.test(this.type)&&this.points.length<3?!1:!0:!1},this.toString=function(){return"_S"===this.type?o(this.points,this.prevType,this.nextType):this.type+this.points.join()}}t=t.replace(/([mnlbspc])/gi," $1 ").replace(/^\s*|\s*$/g,"").replace(/\s+/g," ").toLowerCase(),e=e||1,i=i||1;for(var a=t.split(/\s(?=[mnlbspc])/),r=[],o=function(t,e,i){var s=[0,2/3,1/3,0],a=[0,1/3,2/3,0],r=[0,1/6,2/3,1/6],o=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x],h=[t[t.length-1].y,t[0].y,t[1].y,t[2].y],c=["L",new n(o(r,l),o(r,h))];"M"===e&&(c[0]="M");for(var d=3;d<t.length;d++)l=[t[d-3].x,t[d-2].x,t[d-1].x,t[d].x],h=[t[d-3].y,t[d-2].y,t[d-1].y,t[d].y],c.push("C"+new n(o(s,l),o(s,h)),","+new n(o(a,l),o(a,h)),","+new n(o(r,l),o(r,h)));return("L"===i||"C"===i)&&c.push("L",t[t.length-1]),c.join("")},l=Number.MAX_VALUE,h=Number.MAX_VALUE,c=Number.MIN_VALUE,d=Number.MIN_VALUE,f=0;f<a.length;){for(var p=a[f].split(" "),u=new s(p[0]),m=p.length-!(1&p.length),g=1;m>g;g+=2)u.points.push(new n(p[g],p[g+1])),l=Math.min(l,p[g]),h=Math.min(h,p[g+1]),c=Math.max(c,p[g]),d=Math.max(d,p[g+1]);if(/p|c/.test(p[0])){if("_S"===r[f-1].type){if("p"===p[0]){var x=r[f-1].points.concat(u.points);r[f-1].points=x}if("c"===p[0]){var S=r[f-1].points;r[f-1].points.push(new n(S[0].x,S[0].y),new n(S[1].x,S[1].y),new n(S[2].x,S[2].y))}}a.splice(f,1)}else{if("s"===p[0]){var x=r[f-1].points[r[f-1].points.length-1];u.points.unshift(new n(x.x,x.y))}u.isValid()&&r.push(u),f++}}for(var v=[],y=r.length,f=0;y>f;f++)r[f].prevType=0===f?null:r[f-1].type,r[f].nextType=f===y-1?null:r[f+1].type,v.push(r[f].toString());return{d:v.join("")+"Z",width:c-l,height:d-h,minX:l,minY:h}},d=function(t,e){var i=t.toLowerCase().split(";");return"banner"===i[0]?{name:i[0],delay:1*i[1]||1,lefttoright:1*i[2]||0,fadeawaywidth:1*i[3]||0}:/^scroll\s/.test(i[0])?{name:i[0],y1:Math.min(i[1],i[2]),y2:Math.max(i[1],i[2])||e,delay:1*i[3]||1,fadeawayheight:1*i[4]||0}:null},f=function(t){var e=t.Text.replace(/\\N/g,"<br>").replace(/\\h/g,"&nbsp;"),i=e.split(/{([^{}]*?)}/),n=JSON.parse(JSON.stringify(s[t.Style])),a={content:[]};i[0].length&&a.content.push({tags:n,text:i[0]});for(var r=1;r<i.length;r+=2){for(var o={text:i[r+1],tags:{}},l=i[r].split("\\"),h=0;h<l.length;++h)if(/^t\(/.test(l[h])){for(;!/\)$/.test(l[h+1]);)l[h]+="\\"+l[h+1],l.splice(h+1,1);l[h]+="\\"+l[h+1],l.splice(h+1,1)}for(var h in n)"t"!==h?o.tags[h]=n[h]:o.tags[h]=JSON.parse(JSON.stringify(n[h]));for(var h=0;h<l.length;++h){var c;if(p.call(o,l[h]),o.tags.clip&&(a.clip=o.tags.clip),/^b\d/.test(l[h])&&(o.tags.b=1*l[h].match(/^b(\d+)/)[1]),/^i\d/.test(l[h])&&(o.tags.i=1*l[h][1]),/^u\d/.test(l[h])&&(o.tags.u=1*l[h][1]),/^s\d/.test(l[h])&&(o.tags.s=1*l[h][1]),/^fn/.test(l[h])&&(o.tags.fn=l[h].match(/^fn(.*)/)[1]),/^fe/.test(l[h])&&(o.tags.fe=1*l[h].match(/^fe(.*)/)[1]),/^k\d/.test(l[h])&&(o.tags.k=1*l[h].match(/^k(\d+)/)[1]),/^K\d/.test(l[h])&&(o.tags.kf=1*l[h].match(/^K(\d+)/)[1]),/^kf\d/.test(l[h])&&(o.tags.kf=1*l[h].match(/^kf(\d+)/)[1]),/^ko\d/.test(l[h])&&(o.tags.ko=1*l[h].match(/^ko(\d+)/)[1]),/^kt\d/.test(l[h])&&(o.tags.kt=1*l[h].match(/^kt(\d+)/)[1]),/^q\d/.test(l[h])&&(o.tags.q=1*l[h][1]),/^p\d/.test(l[h])&&(o.tags.p=1*l[h].match(/^p(\d+)/)[1]),/^pbo/.test(l[h])&&(o.tags.pbo=1*l[h].match(/^pbo(.*)/)[1]),/^an\d/.test(l[h])&&!a.alignment&&(a.alignment=1*l[h][2]),/^a\d/.test(l[h])&&!a.alignment&&(c=1*l[h].match(/^a(\d+)/)[1],4>c?a.alignment=c:c>8?a.alignment=c-5:a.alignment=c+2),!/^pos/.test(l[h])||a.pos||a.move||(c=l[h].match(/^pos\s*\(\s*(.*?)\s*,\s*(.*?)\s*\)*$/),a.pos={x:1*c[1],y:1*c[2]}),/^org/.test(l[h])&&!a.org&&(c=l[h].match(/^org\s*\(\s*(.*?)\s*,\s*(.*?)\s*\)*$/),a.org={x:1*c[1],y:1*c[2]}),/^move/.test(l[h])&&!a.move&&!a.pos){c=l[h].match(/^move\s*\((.*)\)/)[1].split(/\s*,\s*/);for(var d=c.length-1;d>=0;d--)c[d]*=1;a.pos={x:1*c[0],y:1*c[1]},4===c.length&&(c.push(0),c.push(1e3*(t.End-t.Start))),a.move=c}if(/^fad\s*\(/.test(l[h])&&!a.fad){c=l[h].match(/^fad\s*\((.*)\)/)[1].split(/\s*,\s*/);for(var d=c.length-1;d>=0;d--)c[d]*=1;a.fad=c}if(/^fade/.test(l[h])&&!a.fade){c=l[h].match(/^fade\s*\((.*)\)/)[1].split(/\s*,\s*/);for(var d=c.length-1;d>=0;d--)c[d]*=1;a.fade=c}if(/^r/.test(l[h])){c=l[h].match(/^r(.*)/)[1];var f=s[c]||s[t.Style];o.tags=JSON.parse(JSON.stringify(f))}if(/^t\(/.test(l[h])){if(o.tags.t||(o.tags.t=[]),c=l[h].replace(/\s/g,"").match(/^t\((.*)\)/)[1].split(","),!c[0])continue;for(var u=c[c.length-1].split("\\"),m={t1:0,t2:1e3*(t.End-t.Start),accel:1,tags:{}},d=u.length-1;d>=0;d--)p.call(m,u[d]);2===c.length&&(m.accel=1*c[0]),3===c.length&&(m.t1=1*c[0],m.t2=1*c[1]),4===c.length&&(m.t1=1*c[0],m.t2=1*c[1],m.accel=1*c[2]),o.tags.t.push(m)}}if(o.tags.t)for(var h=0;h<o.tags.t.length-1;++h)for(var d=h+1;d<o.tags.t.length;++d)if(o.tags.t[h].t1===o.tags.t[d].t1&&o.tags.t[h].t2===o.tags.t[d].t2){for(var g in o.tags.t[d].tags)o.tags.t[h].tags[g]=o.tags.t[d].tags[g];o.tags.t.splice(d,1)}t.Effect&&"banner"===t.Effect.name&&(o.tags.q=2),o.tags.p||(o.text=o.text.replace(/\s/g,"&nbsp;")),o.text=o.text.replace(/\\n/g,2===o.tags.q?"<br>":"&nbsp;"),n=o.tags,a.content.push(o)}return a},p=function(t){var e;if(/^fs[\d\+\-]/.test(t)&&(e=t.match(/^fs(.*)/)[1],/^\d/.test(e)&&(this.tags.fs=1*e),/^\+|-/.test(e)&&(this.tags.fs*=1*e>-10?(10+1*e)/10:1)),/^fsp/.test(t)&&(this.tags.fsp=1*t.match(/^fsp(.*)/)[1]),/^fscx/.test(t)&&(this.tags.fscx=1*t.match(/^fscx(.*)/)[1]),/^fscy/.test(t)&&(this.tags.fscy=1*t.match(/^fscy(.*)/)[1]),/^fsp/.test(t)&&(this.tags.fsp=1*t.match(/^fsp(.*)/)[1]),/^frx/.test(t)&&(this.tags.frx=1*t.match(/^frx(.*)/)[1]),/^fry/.test(t)&&(this.tags.fry=1*t.match(/^fry(.*)/)[1]),/^fr[z\d\-]/.test(t)&&(this.tags.frz=1*t.match(/^frz?(.*)/)[1]),/^blur\d/.test(t)&&(this.tags.blur=1*t.match(/^blur(.*)/)[1]),/^be\d/.test(t)&&(this.tags.blur=1*t.match(/^be(.*)/)[1]),/^fax/.test(t)&&(this.tags.fax=1*t.match(/^fax(.*)/)[1]),/^fay/.test(t)&&(this.tags.fay=1*t.match(/^fay(.*)/)[1]),/^x*bord/.test(t)&&(this.tags.xbord=1*t.match(/^x*bord(.*)/)[1]),/^y*bord/.test(t)&&(this.tags.ybord=1*t.match(/^y*bord(.*)/)[1]),this.tags.xbord<0&&(this.tags.xbord=0),this.tags.ybord<0&&(this.tags.ybord=0),/^x*shad/.test(t)&&(this.tags.xshad=1*t.match(/^x*shad(.*)/)[1]),/^y*shad/.test(t)&&(this.tags.yshad=1*t.match(/^y*shad(.*)/)[1]),/^\d?c&?H?[0-9a-f]+/i.test(t)){for(e=t.match(/^(\d?)c&?H?(\w+)/),e[1]||(e[1]="1");e[2].length<6;)e[2]="0"+e[2];this.tags["c"+e[1]]=e[2]}if(/^\da&?H?[0-9a-f]+/i.test(t)&&(e=t.match(/^(\d)a&?H?(\w\w)/),this.tags["a"+e[1]]=e[2]),/^alpha&?H?[0-9a-f]+/i.test(t))for(var i=1;4>=i;i++)this.tags["a"+i]=t.match(/^alpha&?H?(\w\w)/)[1];/^i?clip/.test(t)&&(e=t.match(/^i?clip\s*\((.*)\)/)[1].split(/\s*,\s*/),this.tags.clip={inverse:/iclip/.test(t),scale:1,commands:null,dots:null},1===e.length&&(this.tags.clip.commands=e[0]),2===e.length&&(this.tags.clip.scale=1*e[0],this.tags.clip.commands=e[1]),4===e.length&&(this.tags.clip.dots=[1*e[0],1*e[1],1*e[2],1*e[3]]))},u=function(t,e){var i=t.match(/(.*):(.*):(.*)/),n=e?e/100:1;return(3600*i[1]+60*i[2]+1*i[3])/n},m=function(t){var e=t.parsedText,i=this.tree.V4Styles.Style[t.Style],n={node:document.createElement("div"),Alignment:e.alignment||i.Alignment,Layer:t.Layer,Start:t.Start,End:t.End,BorderStyle:i.BorderStyle,MarginL:t.MarginL||i.MarginL,MarginR:t.MarginR||i.MarginR,MarginV:t.MarginV||i.MarginV,Effect:t.Effect,parsedText:t.parsedText,_index:t._index,animationName:t.animationName,move:e.move,fad:e.fad,fade:e.fade,pos:e.pos||(e.move?{x:0,y:0}:null),org:e.org,clip:e.clip,channel:0,t:!1};n.node.className="ASS-dialogue",g.call(this,n),this.stage.appendChild(n.node);var s=n.node.getBoundingClientRect();return n.width=s.width,n.height=s.height,n.Effect?("banner"===n.Effect.name&&(n.Alignment<=3&&(n.y=this.height-n.height-n.MarginV),n.Alignment>=4&&n.Alignment<=6&&(n.y=(this.height-n.height)/2),n.Alignment>=7&&(n.y=n.MarginV),n.Effect.lefttoright?n.x=-n.width:n.x=this.width),/^scroll/.test(n.Effect.name)&&(n.y=/up/.test(n.Effect.name)?this.height:-n.height,n.Alignment%3===1&&(n.x=0),n.Alignment%3===2&&(n.x=(this.width-n.width)/2),n.Alignment%3===0&&(n.x=this.width-n.width))):n.pos?(n.Alignment%3===1&&(n.x=this.scale*n.pos.x),n.Alignment%3===2&&(n.x=this.scale*n.pos.x-n.width/2),n.Alignment%3===0&&(n.x=this.scale*n.pos.x-n.width),n.Alignment<=3&&(n.y=this.scale*n.pos.y-n.height),n.Alignment>=4&&n.Alignment<=6&&(n.y=this.scale*n.pos.y-n.height/2),n.Alignment>=7&&(n.y=this.scale*n.pos.y)):(n.Alignment%3===1&&(n.x=0),n.Alignment%3===2&&(n.x=(this.width-n.width)/2),n.Alignment%3===0&&(n.x=this.width-n.width-this.scale*n.MarginR),n.t?(n.Alignment<=3&&(n.y=this.height-n.height-n.MarginV),n.Alignment>=4&&n.Alignment<=6&&(n.y=(this.height-n.height)/2),n.Alignment>=7&&(n.y=n.MarginV)):n.y=k.call(this,n)),x.call(this,n),S(n),v.call(this,n),n},g=function(t){for(var e=document.createDocumentFragment(),i=t.parsedText.content.length,n=0;i>n;++n){var s=t.parsedText.content[n];if(s.text){var a=s.tags,r=["display:inline-block"],o=this.video.currentTime;if(!a.p){r.push("font-family:'"+a.fn+"',Arial");var l=this.scale*F(a.fs,a.fn);r.push("font-size:"+l+"px"),r.push("color:"+j(a.a1+a.c1));var h=this.tree.ScriptInfo.ScaledBorderAndShadow,c=/Yes/i.test(h)?this.scale:1;1===t.BorderStyle&&r.push("text-shadow:"+N(a,c)),3===t.BorderStyle&&(r.push("background-color:"+j(a.a3+a.c3)),r.push("box-shadow:"+N(a,c))),0===a.b?r.push("font-weight:normal"):1===a.b?r.push("font-weight:bold"):r.push("font-weight:"+a.b),r.push("font-style:"+(a.i?"italic":"normal")),a.u&&a.s?r.push("text-decoration:underline line-through"):a.u?r.push("text-decoration:underline"):a.s&&r.push("text-decoration:line-through"),r.push("letter-spacing:"+this.scale*a.fsp+"px"),0===a.q,1===a.q&&(r.push("word-break:break-all"),r.push("white-space:normal")),2===a.q&&(r.push("word-break:normal"),r.push("white-space:nowrap")),3===a.q}if(a.fax||a.fay||a.frx||a.fry||a.frz||100!==a.fscx||100!==a.fscy){var d=R(a);["","-webkit-"].forEach(function(t){r.push(t+"transform:"+d)}),a.p||(r.push("transform-style:preserve-3d"),r.push("word-break:normal"),r.push("white-space:nowrap"))}a.t&&(["","-webkit-"].forEach(function(e){var i=Math.min(0,t.Start-o);r.push(e+"animation-name:"+s.animationName),r.push(e+"animation-duration:"+(t.End-t.Start)+"s"),r.push(e+"animation-delay:"+i+"s"),r.push(e+"animation-timing-function:linear"),r.push(e+"animation-iteration-count:1"),r.push(e+"animation-fill-mode:forwards")}),t.t=!0),t.hasRotate=/"fr[xyz]":[^0]/.test(JSON.stringify(a));for(var f=s.text.split("<br>"),p=f.length,u=0;p>u;u++)if(u&&e.appendChild(document.createElement("br")),f[u]){var m=document.createElement("span");m.dataset.hasRotate=t.hasRotate,a.p?(m.appendChild(_.call(this,m,s,t)),a.pbo&&r.push("vertical-align:"+-a.pbo+"px")):m.innerHTML=f[u],m.style.cssText+=r.join(";"),e.appendChild(m)}}}t.node.appendChild(e)},x=function(t){var e=[],i=this.video.currentTime;if(t.Layer&&e.push("z-index:"+t.Layer),(t.move||t.fad||t.fade||t.Effect)&&["","-webkit-"].forEach(function(n){e.push(n+"animation-name:"+t.animationName),e.push(n+"animation-duration:"+(t.End-t.Start)+"s"),e.push(n+"animation-delay:"+Math.min(0,t.Start-i)+"s"),e.push(n+"animation-timing-function:linear"),e.push(n+"animation-iteration-count:1"),e.push(n+"animation-fill-mode:forwards")}),t.Alignment%3===1&&e.push("text-align:left"),t.Alignment%3===2&&e.push("text-align:center"),t.Alignment%3===0&&e.push("text-align:right"),!t.Effect){var n=this.width-this.scale*(t.MarginL+t.MarginR);e.push("max-width:"+n+"px"),t.pos||(t.Alignment%3===1&&e.push("margin-left:"+this.scale*t.MarginL+"px"),t.Alignment%3===0&&e.push("margin-right:"+this.scale*t.MarginR+"px"),t.width>this.width-this.scale*(t.MarginL+t.MarginR)&&(e.push("margin-left:"+this.scale*t.MarginL+"px"),e.push("margin-right:"+this.scale*t.MarginR+"px")))}e.push("width:"+t.width+"px"),e.push("height:"+t.height+"px"),e.push("left:"+t.x+"px"),e.push("top:"+t.y+"px"),t.node.style.cssText=e.join(";")},S=function(t){if(t.hasRotate){t.org||(t.org={x:0,y:0},t.Alignment%3===1&&(t.org.x=t.x),t.Alignment%3===2&&(t.org.x=t.x+t.width/2),t.Alignment%3===0&&(t.org.x=t.x+t.width),t.Alignment<=3&&(t.org.y=t.y+t.height),t.Alignment>=4&&t.Alignment<=6&&(t.org.y=t.y+t.height/2),t.Alignment>=7&&(t.org.y=t.y));for(var e=t.node.childNodes,i=e.length-1;i>=0;i--)if(e[i].dataset.hasRotate){var n=t.org.x-t.x-e[i].offsetLeft,s=t.org.y-t.y-e[i].offsetTop,a="transform-origin:"+n+"px "+s+"px;";e[i].style.cssText+="-webkit-"+a+a}}},v=function(t){if(t.clip){var e=document.createElement("div");this.stage.insertBefore(e,t.node),e.appendChild(t.node),t.node=e,e.className="ASS-fix-objectBoundingBox",e.style.cssText+=C.call(this,t)}},y=document.createElement("style");y.type="text/css",y.className="ASS-animation",document.head.appendChild(y);var b=function(){function t(){this.obj={},this.set=function(t,e,i){this.obj[t]||(this.obj[t]={}),this.obj[t][e]=i},this.toString=function(){var t=["{"];for(var e in this.obj){t.push(e+"{");for(var i in this.obj[e]){var n=i+":"+this.obj[e][i]+";";"transform"===i&&t.push("-webkit-"+n),t.push(n)}t.push("}")}return t.push("}\n"),t.join("")}}for(var e={},i=function(t){for(var i in e)if(e[i]===t)return i;return null},n=this.tree.Events.Dialogue.length-1;n>=0;n--){var s=this.tree.Events.Dialogue[n],a=s.parsedText,r=1e3*(s.End-s.Start),o=new t,h="",c=[];if(s.Effect&&!a.move){var d=s.Effect;if("banner"===d.name){var f=this.scale*(r/d.delay)*(d.lefttoright?1:-1);o.set("0.000%","transform","translateX(0)"),o.set("100.000%","transform","translateX("+f+"px)")}if(/^scroll/.test(d.name)){var p=/up/.test(d.name)?-1:1,u="translateY("+this.scale*d.y1*p+"px)",m="translateY("+this.scale*d.y2*p+"px)",g=(d.y2-d.y1)/(r/d.delay)*100;c[1]=Math.min(100,g).toFixed(3)+"%",o.set("0.000%","transform",u),o.set(c[1],"transform",m),o.set("100.000%","transform",m)}}if(!a.fad&&a.fade&&2===a.fade.length&&(a.fad=a.fade),a.fad&&2===a.fad.length&&(c[0]="0.000%",c[1]=Math.min(100,a.fad[0]/r*100).toFixed(3)+"%",c[2]=Math.max(0,(r-a.fad[1])/r*100).toFixed(3)+"%",c[3]="100.000%",o.set(c[0],"opacity",0),o.set(c[1],"opacity",1),o.set(c[2],"opacity",1),o.set(c[3],"opacity",0)),a.fade&&7===a.fade.length){c[0]="0.000%",c[5]="100.000%";for(var x=1;4>=x;x++)c[x]=Math.min(100,a.fade[x+2]/r*100).toFixed(3)+"%";for(var x=0;5>=x;x++)o.set(c[x],"opacity",1-a.fade[x>>1]/255)}if(a.move&&6===a.move.length&&(a.pos||(a.pos={x:0,y:0}),6===a.move.length)){c[0]="0.000%",c[1]=Math.min(100,a.move[4]/r*100).toFixed(3)+"%",c[2]=Math.min(100,a.move[5]/r*100).toFixed(3)+"%",c[3]="100.000%";for(var x=0;3>=x;x++){var f=this.scale*(a.move[2>x?0:2]-a.pos.x),S=this.scale*(a.move[2>x?1:3]-a.pos.y);o.set(c[x],"transform","translate("+f+"px, "+S+"px)")}}h=o.toString();var v=i(h);null===v&&(v="ASS-"+l(),e[v]=h),s.animationName=v;for(var x=a.content.length-1;x>=0;x--){o=new t;var b=JSON.parse(JSON.stringify(a.content[x].tags));if(b.t)for(var A=b.t.length-1;A>=0;A--){var w=JSON.parse(JSON.stringify(b.t[A].tags));if(c[0]="0.000%",c[1]=Math.min(100,b.t[A].t1/r*100).toFixed(3)+"%",c[2]=Math.min(100,b.t[A].t2/r*100).toFixed(3)+"%",c[3]="100.000%",w.fs){var u=this.scale*F(b.fs,b.fn)+"px",m=this.scale*F(w.fs,b.fn)+"px";o.set(c[0],"font-size",u),o.set(c[1],"font-size",u),o.set(c[2],"font-size",m),o.set(c[3],"font-size",m)}if(w.fsp){var u=this.scale*b.fsp+"px",m=this.scale*w.fsp+"px";o.set(c[0],"letter-spacing",u),o.set(c[1],"letter-spacing",u),o.set(c[2],"letter-spacing",m),o.set(c[3],"letter-spacing",m)}if(w.c1||w.a1){w.c1=w.c1||b.c1,w.a1=w.a1||b.a1;var u=j(b.a1+b.c1),m=j(w.a1+w.c1);o.set(c[0],"color",u),o.set(c[1],"color",u),o.set(c[2],"color",m),o.set(c[3],"color",m)}if(w.a1&&w.a1===w.a2&&w.a2===w.a3&&w.a3===w.a4){var u=1-parseInt(b.a1,16)/255,m=1-parseInt(w.a1,16)/255;o.set(c[0],"opacity",u),o.set(c[1],"opacity",u),o.set(c[2],"opacity",m),o.set(c[3],"opacity",m)}var E=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur"],M=function(t){for(var e=E.length-1;e>=0;--e)if(void 0!==t[E[e]])return!0;return!1};if(M(w)){E.forEach(function(t){void 0===w[t]&&(w[t]=b[t])});var C=this.tree.ScriptInfo.ScaledBorderAndShadow,k=/Yes/i.test(C)?this.scale:1,u=N(b,k),m=N(w,k);o.set(c[0],"text-shadow",u),o.set(c[1],"text-shadow",u),o.set(c[2],"text-shadow",m),o.set(c[3],"text-shadow",m)}if(w.fscx&&100!==w.fscx||w.fscy&&100!==w.fscy||void 0!==w.frx||void 0!==w.fry||void 0!==w.frz||void 0!==w.fax||void 0!==w.fay){var _=["fscx","fscy","frx","fry","frz","fax","fay"];_.forEach(function(t){void 0===w[t]&&(w[t]=b[t])}),b.p&&(w.fscx=w.fscx/b.fscx*100,w.fscy=w.fscy/b.fscy*100,b.fscx=b.fscy=100);var u=R(b),m=R(w);o.set(c[0],"transform",u),o.set(c[1],"transform",u),o.set(c[2],"transform",m),o.set(c[3],"transform",m)}}h=o.toString();var v=i(h);null===v&&(v="ASS-"+l(),e[v]=h),a.content[x].animationName=v}}var T=[];for(var v in e)T.push("@keyframes "+v+e[v]),T.push("@-webkit-keyframes "+v+e[v]);y.innerHTML=T.join("")},A=function(t){return{fn:t.Fontname,fs:t.Fontsize,c1:t.PrimaryColour.match(/&H(\w\w)?(\w{6})&?/)[2],a1:t.PrimaryColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c2:t.SecondaryColour.match(/&H(\w\w)?(\w{6})&?/)[2],a2:t.SecondaryColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c3:t.OutlineColour.match(/&H(\w\w)?(\w{6})&?/)[2],a3:t.OutlineColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",c4:t.BackColour.match(/&H(\w\w)?(\w{6})&?/)[2],a4:t.BackColour.match(/&H(\w\w)?(\w{6})&?/)[1]||"00",b:Math.abs(t.Bold),i:Math.abs(t.Italic),u:Math.abs(t.Underline),s:Math.abs(t.StrikeOut),fscx:t.ScaleX,fscy:t.ScaleY,fsp:t.Spacing,frz:t.Angle,xbord:t.Outline,ybord:t.Outline,xshad:t.Shadow,yshad:t.Shadow}},w=function(t,e,i){var n=t.xbord||t.ybord,s=t.xshad||t.yshad,a="FF"===t.a1,o=t.blur||0,l=document.createElementNS(r,"filter");l.setAttributeNS(null,"id",e);var h=document.createElementNS(r,"feGaussianBlur");h.setAttributeNS(null,"stdDeviation",n?0:o),h.setAttributeNS(null,"in","SourceGraphic"),h.setAttributeNS(null,"result","sg_b"),l.appendChild(h);var c=document.createElementNS(r,"feFlood");c.setAttributeNS(null,"flood-color",j(t.a1+t.c1)),c.setAttributeNS(null,"result","c1"),l.appendChild(c);var d=document.createElementNS(r,"feComposite");if(d.setAttributeNS(null,"operator","in"),d.setAttributeNS(null,"in","c1"),d.setAttributeNS(null,"in2","sg_b"),d.setAttributeNS(null,"result","main"),l.appendChild(d),n){var f=document.createElementNS(r,"feMorphology");f.setAttributeNS(null,"radius",t.xbord*i+" "+t.ybord*i),f.setAttributeNS(null,"operator","dilate"),f.setAttributeNS(null,"in","SourceGraphic"),f.setAttributeNS(null,"result","dil"),l.appendChild(f);var p=document.createElementNS(r,"feGaussianBlur");p.setAttributeNS(null,"stdDeviation",o),p.setAttributeNS(null,"in","dil"),p.setAttributeNS(null,"result","dil_b"),l.appendChild(p);var u=document.createElementNS(r,"feComposite");u.setAttributeNS(null,"operator","out"),u.setAttributeNS(null,"in","dil_b"),u.setAttributeNS(null,"in2","SourceGraphic"),u.setAttributeNS(null,"result","dil_b_o"),l.appendChild(u);var m=document.createElementNS(r,"feFlood");m.setAttributeNS(null,"flood-color",j(t.a3+t.c3)),m.setAttributeNS(null,"result","c3"),l.appendChild(m);var g=document.createElementNS(r,"feComposite");g.setAttributeNS(null,"operator","in"),g.setAttributeNS(null,"in","c3"),g.setAttributeNS(null,"in2","dil_b_o"),g.setAttributeNS(null,"result","border"),l.appendChild(g)}if(s&&(n||!a)){var x=document.createElementNS(r,"feOffset");x.setAttributeNS(null,"dx",t.xshad*i),x.setAttributeNS(null,"dy",t.yshad*i),x.setAttributeNS(null,"in",n?"dil":"SourceGraphic"),x.setAttributeNS(null,"result","off"),l.appendChild(x);var S=document.createElementNS(r,"feGaussianBlur");if(S.setAttributeNS(null,"stdDeviation",o),S.setAttributeNS(null,"in","off"),S.setAttributeNS(null,"result","off_b"),l.appendChild(S),a){var v=document.createElementNS(r,"feOffset");v.setAttributeNS(null,"dx",t.xshad*i),v.setAttributeNS(null,"dy",t.yshad*i),v.setAttributeNS(null,"in","SourceGraphic"),v.setAttributeNS(null,"result","sg_off"),l.appendChild(v);var y=document.createElementNS(r,"feComposite");y.setAttributeNS(null,"operator","out"),y.setAttributeNS(null,"in","off_b"),y.setAttributeNS(null,"in2","sg_off"),y.setAttributeNS(null,"result","off_b_o"),l.appendChild(y)}var b=document.createElementNS(r,"feFlood");b.setAttributeNS(null,"flood-color",j(t.a4+t.c4)),b.setAttributeNS(null,"result","c4"),l.appendChild(b);var A=document.createElementNS(r,"feComposite");A.setAttributeNS(null,"operator","in"),A.setAttributeNS(null,"in","c4"),A.setAttributeNS(null,"in2",a?"off_b_o":"off_b"),A.setAttributeNS(null,"result","shadow"),l.appendChild(A)}var w=document.createElementNS(r,"feMerge");if(s&&(n||!a)){var N=document.createElementNS(r,"feMergeNode");N.setAttributeNS(null,"in","shadow"),w.appendChild(N)}if(n){var E=document.createElementNS(r,"feMergeNode");E.setAttributeNS(null,"in","border"),w.appendChild(E)}var M=document.createElementNS(r,"feMergeNode");return M.setAttributeNS(null,"in","main"),w.appendChild(M),l.appendChild(w),l},N=function(t,e){var i=[],n=j(t.a3+t.c3),s=t.xbord*e,a=t.ybord*e,r=j(t.a4+t.c4),o=t.xshad*e,l=t.yshad*e,h=t.blur||0;if(!(s+a+o+l))return"none";if(s||a)for(var c=-1;1>=c;c++)for(var d=-1;1>=d;d++){for(var f=1;s>f;f++)for(var p=1;a>p;p++)(c||d)&&i.push(n+" "+c*f+"px "+d*p+"px "+h+"px");i.push(n+" "+c*s+"px "+d*a+"px "+h+"px")}if(o||l){var u=o>0?1:-1,m=l>0?1:-1;o=Math.abs(o),l=Math.abs(l);for(var f=Math.max(s,o-s);o+s>f;f++)for(var p=Math.max(a,l-a);l+a>p;p++)i.push(r+" "+f*u+"px "+p*m+"px "+h+"px");i.push(r+" "+(o+s)*u+"px "+(l+a)*m+"px "+h+"px")}return i.join()},E=document.createElementNS(r,"svg");E.setAttributeNS(null,"class","ASS-clip-path");var M=document.createElementNS(r,"defs");E.appendChild(M);var C=function(t){if(t.clip){var e="",i="ASS-"+l(),n=1/(1<<t.clip.scale-1),s=this.tree.ScriptInfo.PlayResX,a=this.tree.ScriptInfo.PlayResY;if(null!==t.clip.dots){var o=t.clip.dots.map(function(t,e){return 1&e?t/a:t/s});e+="M"+[o[0],o[1]].join(),e+="L"+[o[0],o[3],o[2],o[3],o[2],o[1]].join()+"Z"}null!==t.clip.commands&&(e=c(t.clip.commands,s,a).d),t.clip.inverse&&(e+="M0,0L"+[0,n,n,n,n,0,0,0].join()+"Z"),t.clipPath=document.createElementNS(r,"clipPath"),t.clipPath.setAttributeNS(null,"id",i),t.clipPath.setAttributeNS(null,"clipPathUnits","objectBoundingBox");var h=document.createElementNS(r,"path");h.setAttributeNS(null,"d",e),h.setAttributeNS(null,"transform","scale("+n+")"),h.setAttributeNS(null,"clip-rule","evenodd"),t.clipPath.appendChild(h),M.appendChild(t.clipPath);var d="clip-path:url(#"+i+");";return"-webkit-"+d+d}return""},k=function(t){var e=t.Layer,i=this.width-Math.floor(this.scale*(t.MarginL+t.MarginR)),n=this.height,s=t.width,r=t.height,o=Math.floor(this.scale*t.MarginV),l=this.video.currentTime,h=0;a[e]=a[e]||{left:new Uint16Array(n+1),center:new Uint16Array(n+1),right:new Uint16Array(n+1),leftEnd:new Uint32Array(n+1),centerEnd:new Uint32Array(n+1),rightEnd:new Uint32Array(n+1)};var c=["right","left","center"][t.Alignment%3],d=function(t){var n=a[e].left[t],r=a[e].center[t],o=a[e].right[t],h=a[e].leftEnd[t]/100,d=a[e].centerEnd[t]/100,f=a[e].rightEnd[t]/100;return"left"===c&&(h>l&&n||d>l&&r&&2*s+r>i||f>l&&o&&s+o>i)?!0:"center"===c&&(h>l&&n&&2*n+s>i||d>l&&r||f>l&&o&&2*o+s>i)?!0:"right"===c&&(h>l&&n&&n+s>i||d>l&&r&&2*s+r>i||f>l&&o)?!0:!1},f=function(e){return d(e)?h=0:h++,h>=r?(t.channel=e,!0):!1};if(t.Alignment<=3)for(var p=n-o-1;p>o&&!f(p);p--);else if(t.Alignment>=7)for(var p=o+1;n-o>p&&!f(p);p++);else for(var p=n-r>>1;n-o>p&&!f(p);p++);t.Alignment>3&&(t.channel-=r-1);for(var p=t.channel;p<t.channel+r;p++)a[e][c][p]=s,a[e][c+"End"][p]=100*t.End;return t.channel},_=function(t,e,i){var n=e.tags,s=this.scale/(1<<n.p-1),a=(n.fscx?n.fscx/100:1)*s,o=(n.fscy?n.fscy/100:1)*s,h=c(e.text),d=[h.minX,h.minY,h.width,h.height].join(" "),f="ASS-"+l(),p="ASS-"+l(),u=this.tree.ScriptInfo.ScaledBorderAndShadow,m=/Yes/i.test(u)?this.scale:1,g="http://www.w3.org/1999/xlink",x=n.blur||0,S=n.xbord+(n.xshad<0?-n.xshad:0)+x,v=n.ybord+(n.yshad<0?-n.yshad:0)+x,y=h.width*a+2*n.xbord+Math.abs(n.xshad)+2*x,b=h.height*a+2*n.ybord+Math.abs(n.yshad)+2*x,A=document.createElementNS(r,"svg");A.setAttributeNS(null,"width",y),A.setAttributeNS(null,"height",b),A.setAttributeNS(null,"viewBox",[-S,-v,y,b].join(" "));var N=document.createElementNS(r,"defs");N.appendChild(w(n,f,m)),A.appendChild(N);var E=document.createElementNS(r,"symbol");E.setAttributeNS(null,"id",p),E.setAttributeNS(null,"viewBox",d),A.appendChild(E);var M=document.createElementNS(r,"path");M.setAttributeNS(null,"d",h.d),E.appendChild(M);var C=document.createElementNS(r,"use");return C.setAttributeNS(null,"width",h.width*a),C.setAttributeNS(null,"height",h.height*o),C.setAttributeNS(g,"xlink:href","#"+p),C.setAttributeNS(null,"filter","url(#"+f+")"),A.appendChild(C),t.style.cssText+="position:relative;width:"+h.width*a+"px;height:"+h.height*o+"px;",A.style.cssText="position:absolute;left:"+(h.minX*a-S)+"px;top:"+(h.minY*o-v)+"px;",A},T={},L=document.createElement("div");L.className="ASS-fix-font-size",L.textContent="M";var F=function(t,e){var i=e+"-"+t;if(!T[i]){var n="font-size:"+t+"px;font-family:'"+e+"',Arial;";L.style.cssText=n,T[i]=t*t/L.clientHeight}return T[i]},j=function(t){var e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/),i=1-("0x"+e[1])/255,n=+("0x"+e[2]),s=+("0x"+e[3]),a=+("0x"+e[4]);return["rgba(",[a,s,n,i].join(),")"].join("")},R=function(t){var e=[];return e.push("perspective(314px)"),e.push("rotateY("+(t.fry||0)+"deg)"),e.push("rotateX("+(t.frx||0)+"deg)"),e.push("rotateZ("+(-t.frz||0)+"deg)"),e.push("scale("+(t.p?1:(t.fscx||100)/100)+","+(t.p?1:(t.fscy||100)/100)+")"),e.push("skew("+(t.fax||0)+"rad,"+(t.fay||0)+"rad)"),e.join(" ")};return t});