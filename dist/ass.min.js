(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?module.exports=e():typeof define==="function"&&define.amd?define(e):t.ASS=e()})(this,function(){"use strict";function t(t){var e=t.toLowerCase().trim().split(/\s*;\s*/);if(e[0]==="banner"){return{name:e[0],delay:e[1]*1||0,leftToRight:e[2]*1||0,fadeAwayWidth:e[3]*1||0}}if(/^scroll\s/.test(e[0])){return{name:e[0],y1:Math.min(e[1]*1,e[2]*1),y2:Math.max(e[1]*1,e[2]*1),delay:e[3]*1||0,fadeAwayHeight:e[4]*1||0}}return null}function e(t){return t.toLowerCase().replace(/([mnlbspc])/g," $1 ").trim().replace(/\s+/g," ").split(/\s(?=[mnlbspc])/).map(function(t){return t.split(" ")})}var a=["b","i","u","s","fsp","k","K","kf","ko","kt","fe","q","p","pbo","a","an","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function r(t){var i={};for(var n=0;n<a.length;n++){var s=a[n];var o=new RegExp("^"+s+"-?\\d");if(o.test(t)){i[s]=t.slice(s.length)*1}}if(/^fn/.test(t)){i.fn=t.slice(2)}if(/^r/.test(t)){i.r=t.slice(1)}if(/^fs[\d+-]/.test(t)){i.fs=t.slice(2)}if(/^\d?c&?H?[0-9a-f]+|^\d?c$/i.test(t)){var l=t.match(/^(\d?)c&?H?(\w*)/);var f=l[1];var v=l[2];i["c"+(f||1)]=v&&("000000"+v).slice(-6)}if(/^\da&?H?[0-9a-f]+/i.test(t)){var h=t.match(/^(\d)a&?H?(\w\w)/);var c=h[1];var d=h[2];i["a"+c]=d}if(/^alpha&?H?[0-9a-f]+/i.test(t)){var p;p=t.match(/^alpha&?H?(\w\w)/),i.alpha=p[1]}if(/^(?:pos|org|move|fad|fade)\(/.test(t)){var u=t.match(/^(\w+)\((.*?)\)/);var g=u[1];var m=u[2];i[g]=m.trim().split(/\s*,\s*/).map(Number)}if(/^i?clip/.test(t)){var y=t.match(/^i?clip\((.*)\)/)[1].trim().split(/\s*,\s*/);i.clip={inverse:/iclip/.test(t),scale:1,drawing:null,dots:null};if(y.length===1){i.clip.drawing=e(y[0])}if(y.length===2){i.clip.scale=y[0]*1;i.clip.drawing=e(y[1])}if(y.length===4){i.clip.dots=y.map(Number)}}if(/^t\(/.test(t)){var x=t.match(/^t\((.*)\)/)[1].trim().replace(/\\.*/,function(t){return t.replace(/,/g,"\n")}).split(/\s*,\s*/);if(!x[0]){return i}i.t={t1:0,t2:0,accel:1,tags:x[x.length-1].replace(/\n/g,",").split("\\").slice(1).map(r)};if(x.length===2){i.t.accel=x[0]*1}if(x.length===3){i.t.t1=x[0]*1;i.t.t2=x[1]*1}if(x.length===4){i.t.t1=x[0]*1;i.t.t2=x[1]*1;i.t.accel=x[2]*1}}return i}function i(t){return t.replace(/\((?:[^()]+|\([^()]*\))*\)/g,function(t){return t.replace(/\\/g,"\n")}).split(/\\/).slice(1).map(function(t){return t.replace(/\n/g,"\\")}).map(r)}function n(t){var a=t.split(/{([^{}]*?)}/);var r=[];if(a[0].length){r.push({tags:[],text:a[0],drawing:[]})}for(var n=1;n<a.length;n+=2){var s=i(a[n]);var o=s.reduce(function(t,e){return e.p===undefined?t:!!e.p},false);r.push({tags:s,text:o?"":a[n+1],drawing:o?e(a[n+1]):[]})}return{raw:t,combined:r.map(function(t){return t.text}).join(""),parsed:r}}function s(t){var e=t.split(":");return e[0]*3600+e[1]*60+e[2]*1}function o(e,a){var r=e.split(",");if(r.length>a.length){var i=r.slice(a.length-1).join();r=r.slice(0,a.length-1);r.push(i)}var o={};for(var l=0;l<r.length;l++){var f=a[l];var v=r[l].trim();switch(f){case"Layer":case"MarginL":case"MarginR":case"MarginV":o[f]=v*1;break;case"Start":case"End":o[f]=s(v);break;case"Effect":o[f]=t(v);break;case"Text":o[f]=n(v);break;default:o[f]=v}}return o}function l(t){return t.match(/Format\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function f(t){return t.match(/Style\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function v(t){var e={info:{},styles:{format:[],style:[]},events:{format:[],comment:[],dialogue:[]}};var a=t.split(/\r?\n/);var r=0;for(var i=0;i<a.length;i++){var n=a[i].trim();if(/^;/.test(n)){continue}if(/^\[Script Info\]/i.test(n)){r=1}else if(/^\[V4\+? Styles\]/i.test(n)){r=2}else if(/^\[Events\]/i.test(n)){r=3}else if(/^\[.*\]/.test(n)){r=0}if(r===0){continue}if(r===1){if(/:/.test(n)){var s=n.match(/(.*?)\s*:\s*(.*)/);var v=s[1];var h=s[2];e.info[v]=h}}if(r===2){if(/^Format\s*:/i.test(n)){e.styles.format=l(n)}if(/^Style\s*:/i.test(n)){e.styles.style.push(f(n))}}if(r===3){if(/^Format\s*:/i.test(n)){e.events.format=l(n)}if(/^(?:Comment|Dialogue)\s*:/i.test(n)){var c=n.match(/^(\w+?)\s*:\s*(.*)/i);var d=c[1];var p=c[2];e.events[d.toLowerCase()].push(o(p,e.events.format))}}}return e}function h(t){var e=[],a=arguments.length-1;while(a-- >0)e[a]=arguments[a+1];if(Object.assign){return Object.assign.apply(Object,[t].concat(e))}for(var r=0;r<e.length;r++){if(!e[r]){continue}var i=Object.keys(e[r]);for(var n=0;n<i.length;n++){t[i[n]]=e[r][i[n]]}}return t}function c(t){var e={type:null,prev:null,next:null,points:[]};if(/[mnlbs]/.test(t[0])){e.type=t[0].toUpperCase().replace("N","L").replace("B","C")}for(var a=t.length-!(t.length&1),r=1;r<a;r+=2){e.points.push({x:t[r]*1,y:t[r+1]*1})}return e}function d(t){if(!t.points.length||!t.type){return false}if(/C|S/.test(t.type)&&t.points.length<3){return false}return true}function p(t){var e=Infinity;var a=Infinity;var r=-Infinity;var i=-Infinity;(n=[]).concat.apply(n,t.map(function(t){var e=t.points;return e})).forEach(function(t){var n=t.x;var s=t.y;e=Math.min(e,n);a=Math.min(a,s);r=Math.max(r,n);i=Math.max(i,s)});return{minX:e,minY:a,width:r-e,height:i-a};var n}function u(t,e,a){var r=[];var i=[0,2/3,1/3,0];var n=[0,1/3,2/3,0];var s=[0,1/6,2/3,1/6];var o=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]};var l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x];var f=[t[t.length-1].y,t[0].y,t[1].y,t[2].y];r.push({type:e==="M"?"M":"L",points:[{x:o(s,l),y:o(s,f)}]});for(var v=3;v<t.length;v++){l=[t[v-3].x,t[v-2].x,t[v-1].x,t[v].x];f=[t[v-3].y,t[v-2].y,t[v-1].y,t[v].y];r.push({type:"C",points:[{x:o(i,l),y:o(i,f)},{x:o(n,l),y:o(n,f)},{x:o(s,l),y:o(s,f)}]})}if(a==="L"||a==="C"){var h=t[t.length-1];r.push({type:"L",points:[{x:h.x,y:h.y}]})}return r}function g(t){return t.map(function(t){var e=t.type;var a=t.points;return e+a.map(function(t){var e=t.x;var a=t.y;return e+","+a}).join(",")}).join("")}function m(t){var e=[];var a=0;while(a<t.length){var r=t[a];var i=c(r);if(i.type){if(i.type==="S"){var n=e[a-1].points.slice(-1)[0];var s=n.x;var o=n.y;i.points.unshift({x:s,y:o})}if(d(i)){if(a){i.prev=e[a-1].type;e[a-1].next=i.type}e.push(i)}a++}else{if(e[a-1].type==="S"){var l={p:i.points,c:e[a-1].points.slice(0,3)};e[a-1].points=e[a-1].points.concat((l[r[0]]||[]).map(function(t){var e=t.x;var a=t.y;return{x:e,y:a}}))}t.splice(a,1)}}var f=(v=[]).concat.apply(v,e.map(function(t){var e=t.type;var a=t.points;var r=t.prev;var i=t.next;return e==="S"?u(a,r,i):{type:e,points:a}}));return h({instructions:f,d:g(f)},p(e));var v}var y=["fs","clip","c1","c2","c3","c4","a1","a2","a3","a4","alpha","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function x(t,e,a){if(a===void 0)a={};var r=t[e];if(r===undefined){return null}if(e==="pos"||e==="org"){return r.length===2?(i={},i[e]={x:r[0],y:r[1]},i):null;var i}if(e==="move"){var n=r[0];var s=r[1];var o=r[2];var l=r[3];var f=r[4];if(f===void 0)f=0;var v=r[5];if(v===void 0)v=0;return r.length===4||r.length===6?{move:{x1:n,y1:s,x2:o,y2:l,t1:f,t2:v}}:null}if(e==="fad"||e==="fade"){if(r.length===2){var c=r[0];var d=r[1];return{fade:{type:"fad",t1:c,t2:d}}}if(r.length===7){var p=r[0];var u=r[1];var g=r[2];var w=r[3];var b=r[4];var S=r[5];var _=r[6];return{fade:{type:"fade",a1:p,a2:u,a3:g,t1:w,t2:b,t3:S,t4:_}}}return null}if(e==="clip"){var C=r.inverse;var $=r.scale;var A=r.drawing;var M=r.dots;if(A){return{clip:{inverse:C,scale:$,drawing:m(A),dots:M}}}if(M){var k=M[0];var T=M[1];var j=M[2];var E=M[3];return{clip:{inverse:C,scale:$,drawing:A,dots:{x1:k,y1:T,x2:j,y2:E}}}}return null}if(/^[xy]?(bord|shad)$/.test(e)){r=Math.max(r,0)}if(e==="bord"){return{xbord:r,ybord:r}}if(e==="shad"){return{xshad:r,yshad:r}}if(/^c\d$/.test(e)){return N={},N[e]=r||a[e],N;var N}if(e==="alpha"){return{a1:r,a2:r,a3:r,a4:r}}if(e==="fr"){return{frz:r}}if(e==="fs"){return{fs:/^\+|-/.test(r)?(r*1>-10?1+r/10:1)*a.fs:r*1}}if(e==="t"){var L=r.t1;var O=r.accel;var B=r.tags;var F=r.t2||(a.end-a.start)*1e3;var z={};B.forEach(function(t){var e=Object.keys(t)[0];if(~y.indexOf(e)&&!(e==="clip"&&!t[e].dots)){h(z,x(t,e,a))}});return{t:{t1:L,t2:F,accel:O,tag:z}}}return R={},R[e]=r,R;var R}var w=[null,1,2,3,null,7,8,9,null,4,5,6];var b=["r","a","an","pos","org","move","fade","fad","clip"];function S(t,e){return{name:t,borderStyle:e[t].style.BorderStyle,tag:e[t].tag,fragments:[]}}function _(t){var e=t.styles;var a=t.name;var r=t.parsed;var i=t.start;var n=t.end;var s;var o;var l;var f;var v;var c;var d=[];var p=S(a,e);var u={};for(var g=0;g<r.length;g++){var y=r[g];var _=y.tags;var C=y.text;var $=y.drawing;var A=void 0;for(var M=0;M<_.length;M++){var k=_[M];A=k.r===undefined?A:k.r}var T={tag:A===undefined?JSON.parse(JSON.stringify(u)):{},text:C,drawing:$.length?m($):null};for(var j=0;j<_.length;j++){var E=_[j];s=s||w[E.a||0]||E.an;o=o||x(E,"pos");l=l||x(E,"org");f=f||x(E,"move");v=v||x(E,"fade")||x(E,"fad");c=x(E,"clip")||c;var N=Object.keys(E)[0];if(N&&!~b.indexOf(N)){var L=p.tag;var O=L.c1;var B=L.c2;var F=L.c3;var z=L.c4;var R=u.fs||p.tag.fs;var I=x(E,N,{start:i,end:n,c1:O,c2:B,c3:F,c4:z,fs:R});if(N==="t"){T.tag.t=T.tag.t||[];T.tag.t.push(I.t)}else{h(T.tag,I)}}}u=T.tag;if(A!==undefined){d.push(p);p=S(A||a,e)}if(T.text||T.drawing){var P=p.fragments[p.fragments.length-1]||{};if(P.text&&T.text&&!Object.keys(T.tag).length){P.text+=T.text}else{p.fragments.push(T)}}}d.push(p);return h({alignment:s,slices:d},o,l,f,v,c)}function C(t){var e=t.info;var a=t.styles;var r=t.dialogues;var i=Infinity;var n=[];for(var s=0;s<r.length;s++){var o=r[s];if(o.Start>=o.End){continue}var l=a[o.Style].style;var f=e.Timer/100||1;var v=_({styles:a,name:o.Style,parsed:o.Text.parsed,start:o.Start,end:o.End});var c=v.alignment||l.Alignment;i=Math.min(i,o.Layer);n.push(h({layer:o.Layer,start:o.Start/f,end:o.End/f,margin:{left:o.MarginL||l.MarginL,right:o.MarginR||l.MarginR,vertical:o.MarginV||l.MarginV},effect:o.Effect},v,{alignment:c}))}for(var d=0;d<n.length;d++){n[d].layer-=i}return n.sort(function(t,e){return t.start-e.start||t.end-e.end})}function $(t){var e=t.match(/&H(\w\w)?(\w{6})&?/);var a=e[1];var r=e[2];return[a||"00",r]}function A(t){var e=t.info;var a=t.style;var r=t.format;var i={};for(var n=0;n<a.length;n++){var s=a[n];var o={};for(var l=0;l<r.length;l++){var f=r[l];o[f]=f==="Name"||f==="Fontname"||/Colour/.test(f)?s[l]:s[l]*1}var v=$(o.PrimaryColour);var h=v[0];var c=v[1];var d=$(o.SecondaryColour);var p=d[0];var u=d[1];var g=$(o.OutlineColour);var m=g[0];var y=g[1];var x=$(o.BackColour);var w=x[0];var b=x[1];var S={fn:o.Fontname,fs:o.Fontsize,c1:c,a1:h,c2:u,a2:p,c3:y,a3:m,c4:b,a4:w,b:Math.abs(o.Bold),i:Math.abs(o.Italic),u:Math.abs(o.Underline),s:Math.abs(o.StrikeOut),fscx:o.ScaleX,fscy:o.ScaleY,fsp:o.Spacing,frz:o.Angle,xbord:o.Outline,ybord:o.Outline,xshad:o.Shadow,yshad:o.Shadow,q:/^[0-3]$/.test(e.WrapStyle)?e.WrapStyle*1:2};i[o.Name]={style:o,tag:S}}return i}function M(t){var e=v(t);var a=A({info:e.info,style:e.styles.style,format:e.styles.format});return{info:e.info,width:e.info.PlayResX*1||null,height:e.info.PlayResY*1||null,collisions:e.info.Collisions||"Normal",styles:a,dialogues:C({info:e.info,styles:a,dialogues:e.events.dialogue})}}var k=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)};var T=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function j(t){var e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/);var a=1-("0x"+e[1])/255;var r=+("0x"+e[2]);var i=+("0x"+e[3]);var n=+("0x"+e[4]);return"rgba("+n+","+i+","+r+","+a+")"}function E(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0;var a=t==="x"?e:e&3|8;return a.toString(16)})}function N(t,e){if(e===void 0)e=[];var a=document.createElementNS("http://www.w3.org/2000/svg",t);for(var r=0;r<e.length;r++){var i=e[r];a.setAttributeNS(i[0]==="xlink:href"?"http://www.w3.org/1999/xlink":null,i[0],i[1])}return a}function L(t){var e=document.body;var a=e.style;var r=t.replace(/^\w/,function(t){return t.toUpperCase()});if(t in a){return""}if("webkit"+r in a){return"-webkit-"}if("moz"+r in a){return"-moz-"}return""}var O={transform:L("transform"),animation:L("animation"),clipPath:L("clipPath")};var B=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur","be"];var F=["fscx","fscy","frx","fry","frz","fax","fay"];function z(t){var e=this._.scriptRes.width;var a=this._.scriptRes.height;var r="";if(t.dots!==null){var i=t.dots;var n=i.x1;var s=i.y1;var o=i.x2;var l=i.y2;n/=e;s/=a;o/=e;l/=a;r="M"+n+","+s+"L"+n+","+l+","+o+","+l+","+o+","+s+"Z"}if(t.drawing!==null){r=t.drawing.instructions.map(function(t){var r=t.type;var i=t.points;return r+i.map(function(t){var r=t.x;var i=t.y;return r/e+","+i/a}).join(",")}).join("")}var f=1/(1<<t.scale-1);if(t.inverse){r+="M0,0L0,"+f+","+f+","+f+","+f+",0,0,0Z"}var v="ASS-"+E();var h=N("clipPath",[["id",v],["clipPathUnits","objectBoundingBox"]]);h.appendChild(N("path",[["d",r],["transform","scale("+f+")"],["clip-rule","evenodd"]]));this._.$defs.appendChild(h);return{$clipPath:h,cssText:O.clipPath+"clip-path:url(#"+v+");"}}function R(t){if(!t.clip){return}var e=document.createElement("div");this._.$stage.insertBefore(e,t.$div);e.appendChild(t.$div);e.className="ASS-fix-objectBoundingBox";var a=z.call(this,t.clip);var r=a.cssText;var i=a.$clipPath;this._.$defs.appendChild(i);e.style.cssText=r;h(t,{$div:e,$clipPath:i})}var I=document.createElement("div");I.className="ASS-fix-font-size";I.textContent="M";var P=Object.create(null);function q(t,e){var a=t+"-"+e;if(!P[a]){I.style.cssText="font-size:"+e+'px;font-family:"'+t+'",Arial;';P[a]=e*e/I.clientHeight}return P[a]}function H(t,e,a){var r=t.xbord||t.ybord;var i=t.xshad||t.yshad;var n=t.a1!=="FF";var s=t.blur||t.be||0;var o=N("filter",[["id",e]]);o.appendChild(N("feGaussianBlur",[["stdDeviation",r?0:s],["in","SourceGraphic"],["result","sg_b"]]));o.appendChild(N("feFlood",[["flood-color",j(t.a1+t.c1)],["result","c1"]]));o.appendChild(N("feComposite",[["operator","in"],["in","c1"],["in2","sg_b"],["result","main"]]));if(r){o.appendChild(N("feMorphology",[["radius",t.xbord*a+" "+t.ybord*a],["operator","dilate"],["in","SourceGraphic"],["result","dil"]]));o.appendChild(N("feGaussianBlur",[["stdDeviation",s],["in","dil"],["result","dil_b"]]));o.appendChild(N("feComposite",[["operator","out"],["in","dil_b"],["in2","SourceGraphic"],["result","dil_b_o"]]));o.appendChild(N("feFlood",[["flood-color",j(t.a3+t.c3)],["result","c3"]]));o.appendChild(N("feComposite",[["operator","in"],["in","c3"],["in2","dil_b_o"],["result","border"]]))}if(i&&(r||n)){o.appendChild(N("feOffset",[["dx",t.xshad*a],["dy",t.yshad*a],["in",r?"dil":"SourceGraphic"],["result","off"]]));o.appendChild(N("feGaussianBlur",[["stdDeviation",s],["in","off"],["result","off_b"]]));if(!n){o.appendChild(N("feOffset",[["dx",t.xshad*a],["dy",t.yshad*a],["in","SourceGraphic"],["result","sg_off"]]));o.appendChild(N("feComposite",[["operator","out"],["in","off_b"],["in2","sg_off"],["result","off_b_o"]]))}o.appendChild(N("feFlood",[["flood-color",j(t.a4+t.c4)],["result","c4"]]));o.appendChild(N("feComposite",[["operator","in"],["in","c4"],["in2",n?"off_b":"off_b_o"],["result","shadow"]]))}var l=N("feMerge",[]);if(i&&(r||n)){l.appendChild(N("feMergeNode",[["in","shadow"]]))}if(r){l.appendChild(N("feMergeNode",[["in","border"]]))}l.appendChild(N("feMergeNode",[["in","main"]]));o.appendChild(l);return o}function U(t,e){var a=[];var r=j(t.a3+t.c3);var i=t.xbord*e;var n=t.ybord*e;var s=j(t.a4+t.c4);var o=t.xshad*e;var l=t.yshad*e;var f=t.blur||t.be||0;if(!(i+n+o+l)){return"none"}if(i||n){for(var v=-1;v<=1;v++){for(var h=-1;h<=1;h++){for(var c=1;c<i;c++){for(var d=1;d<n;d++){if(v||h){a.push(r+" "+v*c+"px "+h*d+"px "+f+"px")}}}a.push(r+" "+v*i+"px "+h*n+"px "+f+"px")}}}if(o||l){var p=o>0?1:-1;var u=l>0?1:-1;o=Math.abs(o);l=Math.abs(l);for(var g=Math.max(i,o-i);g<o+i;g++){for(var m=Math.max(n,l-n);m<l+n;m++){a.push(s+" "+g*p+"px "+m*u+"px "+f+"px")}}a.push(s+" "+(o+i)*p+"px "+(l+n)*u+"px "+f+"px")}return a.join()}function Y(t){return["perspective(314px)","rotateY("+(t.fry||0)+"deg)","rotateX("+(t.frx||0)+"deg)","rotateZ("+(-t.frz||0)+"deg)","scale("+(t.p?1:(t.fscx||100)/100)+","+(t.p?1:(t.fscy||100)/100)+")","skew("+(t.fax||0)+"rad,"+(t.fay||0)+"rad)"].join(" ")}function G(t){var e=t.alignment;var a=t.width;var r=t.height;var i=t.x;var n=t.y;var s=t.$div;var o=t.org;if(!o){o={x:0,y:0};if(e%3===1){o.x=i}if(e%3===2){o.x=i+a/2}if(e%3===0){o.x=i+a}if(e<=3){o.y=n+r}if(e>=4&&e<=6){o.y=n+r/2}if(e>=7){o.y=n}}for(var l=s.childNodes.length-1;l>=0;l--){var f=s.childNodes[l];if(f.dataset.hasRotate==="true"){var v=o.x-i-f.offsetLeft;var h=o.y-n-f.offsetTop;f.style.cssText+=O.transform+"transform-origin:"+v+"px "+h+"px;"}}}var X=Object.create(null);function D(t){var e=Object.keys(X);for(var a=0;a<e.length;a++){if(X[e[a]]===t){return e[a]}}var r="ASS-"+E();X[r]=t;return r}function W(t,e){return"@"+O.animation+"keyframes "+t+" {"+e+"}\n"}var V=function t(){this.obj={}};V.prototype.set=function t(e,a,r){if(!this.obj[e]){this.obj[e]={}}this.obj[e][a]=r};V.prototype.setT=function t(e){var a=e.t1;var r=e.t2;var i=e.duration;var n=e.prop;var s=e.from;var o=e.to;this.set("0.000%",n,s);if(a<i){this.set((a/i*100).toFixed(3)+"%",n,s)}if(r<i){this.set((r/i*100).toFixed(3)+"%",n,o)}this.set("100.000%",n,o)};V.prototype.toString=function t(){var e=this;return Object.keys(this.obj).map(function(t){return t+"{"+Object.keys(e.obj[t]).map(function(a){return""+(O[a]||"")+a+":"+e.obj[t][a]+";"}).join("")+"}"}).join("")};function J(t){return t.reduceRight(function(t,e){var a=false;return t.map(function(t){a=e.t1===t.t1&&e.t2===t.t2&&e.accel===t.accel;return h({},t,a?{tag:h({},t.tag,e.tag)}:{})}).concat(a?[]:e)},[])}function Z(){var t=this;var e="";this.dialogues.forEach(function(a){var r=a.start;var i=a.end;var n=a.effect;var s=a.move;var o=a.fade;var l=a.slices;var f=(i-r)*1e3;var v=new V;if(n&&!s){var c=n.name;var d=n.delay;var p=n.lefttoright;var u=n.y1;var g=n.y2||t._.resampledRes.height;if(c==="banner"){var m=t.scale*(f/d)*(p?1:-1);v.set("0.000%","transform","translateX(0)");v.set("100.000%","transform","translateX("+m+"px)")}if(/^scroll/.test(c)){var y=/up/.test(c)?-1:1;var x="translateY("+t.scale*u*y+"px)";var w="translateY("+t.scale*g*y+"px)";var b=(g-u)/(f/d)*100;v.set("0.000%","transform",x);if(b<100){v.set(b.toFixed(3)+"%","transform",w)}v.set("100.000%","transform",w)}}if(s){var S=s.x1;var _=s.y1;var C=s.x2;var $=s.y2;var A=s.t1;var M=s.t2||f;var k=a.pos||{x:0,y:0};var T=[{x:S,y:_},{x:C,y:$}].map(function(e){var a=e.x;var r=e.y;return"translate("+t.scale*(a-k.x)+"px, "+t.scale*(r-k.y)+"px)"});v.setT({t1:A,t2:M,duration:f,prop:"transform",from:T[0],to:T[1]})}if(o){if(o.type==="fad"){var E=o.t1;var N=o.t2;v.set("0.000%","opacity",0);if(E<f){v.set((E/f*100).toFixed(3)+"%","opacity",1);if(E+N<f){v.set(((f-N)/f*100).toFixed(3)+"%","opacity",1)}v.set("100.000%","opacity",0)}else{v.set("100.000%","opacity",f/E)}}else{var L=o.a1;var O=o.a2;var z=o.a3;var R=o.t1;var I=o.t2;var P=o.t3;var H=o.t4;var G=[R,I,P,H].map(function(t){return(t/f*100).toFixed(3)+"%"});var X=[L,O,z].map(function(t){return 1-t/255});v.set("0.000%","opacity",X[0]);if(R<f){v.set(G[0],"opacity",X[0])}if(I<f){v.set(G[1],"opacity",X[1])}if(P<f){v.set(G[2],"opacity",X[1])}if(H<f){v.set(G[3],"opacity",X[2])}v.set("100.000%","opacity",X[2])}}var Z=v.toString();if(Z){h(a,{animationName:D(Z)});e+=W(a.animationName,Z)}l.forEach(function(a){a.fragments.forEach(function(r){if(!r.tag.t||!r.tag.t.length){return}var i=new V;var n=h({},a.tag,r.tag);J(r.tag.t).forEach(function(e){var s=e.t1;var o=e.t2;var l=e.tag;if(l.fs){var v=t.scale*q(n.fn,n.fs)+"px";var c=t.scale*q(l.fn,n.fs)+"px";i.setT({t1:s,t2:o,duration:f,prop:"font-size",from:v,to:c})}if(l.fsp){var d=t.scale*n.fsp+"px";var p=t.scale*l.fsp+"px";i.setT({t1:s,t2:o,duration:f,prop:"letter-spacing",from:d,to:p})}var u=l.a1!==undefined&&l.a1===l.a2&&l.a2===l.a3&&l.a3===l.a4;if(l.c1||l.a1&&!u){var g=j(n.a1+n.c1);var m=j((l.a1||n.a1)+(l.c1||n.c1));i.setT({t1:s,t2:o,duration:f,prop:"color",from:g,to:m})}if(u){var y=1-parseInt(n.a1,16)/255;var x=1-parseInt(l.a1,16)/255;i.setT({t1:s,t2:o,duration:f,prop:"opacity",from:y,to:x})}var w=B.some(function(t){return l[t]!==undefined&&l[t]!==(r.tag[t]||a.tag[t])});if(w){var b=/Yes/i.test(t.info.ScaledBorderAndShadow)?t.scale:1;var S=U(n,b);var _=U(h({},n,l),b);i.setT({t1:s,t2:o,duration:f,prop:"text-shadow",from:S,to:_})}var C=F.some(function(t){return l[t]!==undefined&&l[t]!==(r.tag[t]||a.tag[t])});if(C){var $=h({},n,l);if(r.drawing){h($,{p:0,fscx:(l.fscx||n.fscx)/n.fscx*100,fscy:(l.fscy||n.fscy)/n.fscy*100});h(n,{fscx:100,fscy:100})}var A=Y(n);var M=Y($);i.setT({t1:s,t2:o,duration:f,prop:"transform",from:A,to:M})}});var s=i.toString();h(r,{animationName:D(s)});e+=W(r.animationName,s)})})});return e}function K(t,e,a){var r=O.animation;return r+"animation-name:"+t+";"+r+"animation-duration:"+e+"s;"+r+"animation-delay:"+a+"s;"+r+"animation-timing-function:linear;"+r+"animation-iteration-count:1;"+r+"animation-fill-mode:forwards;"}function Q(t,e){var a=h({},e,t.tag);var r=t.drawing;var i=r.minX;var n=r.minY;var s=r.width;var o=r.height;var l=this.scale/(1<<a.p-1);var f=(a.fscx?a.fscx/100:1)*l;var v=(a.fscy?a.fscy/100:1)*l;var c=a.blur||a.be||0;var d=a.xbord+(a.xshad<0?-a.xshad:0)+c;var p=a.ybord+(a.yshad<0?-a.yshad:0)+c;var u=s*f+2*a.xbord+Math.abs(a.xshad)+2*c;var g=o*v+2*a.ybord+Math.abs(a.yshad)+2*c;var m=N("svg",[["width",u],["height",g],["viewBox",-d+" "+-p+" "+u+" "+g]]);var y=/Yes/i.test(this.info.ScaledBorderAndShadow)?this.scale:1;var x="ASS-"+E();var w=N("defs");w.appendChild(H(a,x,y));m.appendChild(w);var b="ASS-"+E();var S=N("symbol",[["id",b],["viewBox",i+" "+n+" "+s+" "+o]]);S.appendChild(N("path",[["d",t.drawing.d]]));m.appendChild(S);m.appendChild(N("use",[["width",s*f],["height",o*v],["xlink:href","#"+b],["filter","url(#"+x+")"]]));m.style.cssText="position:absolute;"+"left:"+(i*f-d)+"px;"+"top:"+(n*v-p)+"px;";return{$svg:m,cssText:"position:relative;width:"+s*f+"px;height:"+o*v+"px;"}}function tt(t,e){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\s/g,"&nbsp;").replace(/\\h/g,"&nbsp;").replace(/\\N/g,"<br>").replace(/\\n/g,e===2?"<br>":"&nbsp;")}function et(t){var e=this;var a=document.createElement("div");a.className="ASS-dialogue";var r=document.createDocumentFragment();var i=t.slices;var n=t.start;var s=t.end;i.forEach(function(t){var a=t.borderStyle;t.fragments.forEach(function(i){var o=i.text;var l=i.drawing;var f=i.animationName;var v=h({},t.tag,i.tag);var c="display:inline-block;";var d=e.video.currentTime;if(!l){c+='font-family:"'+v.fn+'",Arial;';c+="font-size:"+e.scale*q(v.fn,v.fs)+"px;";c+="color:"+j(v.a1+v.c1)+";";var p=/Yes/i.test(e.info.ScaledBorderAndShadow)?e.scale:1;if(a===1){c+="text-shadow:"+U(v,p)+";"}if(a===3){c+="background-color:"+j(v.a3+v.c3)+";"+"box-shadow:"+U(v,p)+";"}c+=v.b?"font-weight:"+(v.b===1?"bold":v.b)+";":"";c+=v.i?"font-style:italic;":"";c+=v.u||v.s?"text-decoration:"+(v.u?"underline":"")+" "+(v.s?"line-through":"")+";":"";c+=v.fsp?"letter-spacing:"+v.fsp+"px;":"";if(v.q===1||v.q===0||v.q===3){c+="word-break:break-all;white-space:normal;"}if(v.q===2){c+="word-break:normal;white-space:nowrap;"}}var u=F.some(function(t){return/^fsc[xy]$/.test(t)?v[t]!==100:!!v[t]});if(u){c+=O.transform+"transform:"+Y(v)+";";if(!l){c+="transform-style:preserve-3d;word-break:normal;white-space:nowrap;"}}if(f){c+=K(f,s-n,Math.min(0,n-d))}if(l&&v.pbo){var g=e.scale*-v.pbo*(v.fscy||100)/100;c+="vertical-align:"+g+"px;"}var m=/"fr[xyz]":[^0]/.test(JSON.stringify(v));tt(o,v.q).split("<br>").forEach(function(a,n){var s=document.createElement("span");s.dataset.hasRotate=m;if(l){var o=Q.call(e,i,t.tag);s.style.cssText=o.cssText;s.appendChild(o.$svg)}else{if(n){r.appendChild(document.createElement("br"))}if(!a){return}s.innerHTML=a}s.style.cssText+=c;r.appendChild(s)})})});a.appendChild(r);return a}function at(t){var e=t.layer;var a=t.margin;var r=t.width;var i=t.height;var n=t.alignment;var s=t.end;var o=this.width-(this.scale*(a.left+a.right)|0);var l=this.height;var f=this.scale*a.vertical|0;var v=this.video.currentTime*100;this._.space[e]=this._.space[e]||{left:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)},center:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)},right:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)}};var h=this._.space[e];var c=["right","left","center"][n%3];var d=function(t){var e=h.left.width[t];var a=h.center.width[t];var i=h.right.width[t];var n=h.left.end[t];var s=h.center.end[t];var l=h.right.end[t];return c==="left"&&(n>v&&e||s>v&&a&&2*r+a>o||l>v&&i&&r+i>o)||c==="center"&&(n>v&&e&&2*e+r>o||s>v&&a||l>v&&i&&2*i+r>o)||c==="right"&&(n>v&&e&&e+r>o||s>v&&a&&2*r+a>o||l>v&&i)};var p=0;var u=0;var g=function(t){p=d(t)?0:p+1;if(p>=i){u=t;return true}return false};if(n<=3){for(var m=l-f-1;m>f;m--){if(g(m)){break}}}else if(n>=7){for(var y=f+1;y<l-f;y++){if(g(y)){break}}}else{for(var x=l-i>>1;x<l-f;x++){if(g(x)){break}}}if(n>3){u-=i-1}for(var w=u;w<u+i;w++){h[c].width[w]=r;h[c].end[w]=s*100}return u}function rt(t){var e=t.effect;var a=t.move;var r=t.alignment;var i=t.width;var n=t.height;var s=t.margin;var o=t.slices;var l=0;var f=0;if(e){if(e.name==="banner"){if(r<=3){f=this.height-n-s.vertical}if(r>=4&&r<=6){f=(this.height-n)/2}if(r>=7){f=s.vertical}l=e.lefttoright?-i:this.width}}else if(t.pos||a){var v=t.pos||{x:0,y:0};if(r%3===1){l=this.scale*v.x}if(r%3===2){l=this.scale*v.x-i/2}if(r%3===0){l=this.scale*v.x-i}if(r<=3){f=this.scale*v.y-n}if(r>=4&&r<=6){f=this.scale*v.y-n/2}if(r>=7){f=this.scale*v.y}}else{if(r%3===1){l=0}if(r%3===2){l=(this.width-i)/2}if(r%3===0){l=this.width-i-this.scale*s.right}var h=o.some(function(t){return t.fragments.some(function(t){var e=t.animationName;return e})});if(h){if(r<=3){f=this.height-n-s.vertical}if(r>=4&&r<=6){f=(this.height-n)/2}if(r>=7){f=s.vertical}}else{f=at.call(this,t)}}return{x:l,y:f}}function it(t){var e=t.layer;var a=t.start;var r=t.end;var i=t.alignment;var n=t.effect;var s=t.pos;var o=t.margin;var l=t.animationName;var f=t.width;var v=t.height;var h=t.x;var c=t.y;var d=this.video.currentTime;var p="";if(e){p+="z-index:"+e+";"}if(l){p+=K(l,r-a,Math.min(0,a-d))}p+="text-align:"+["right","left","center"][i%3]+";";if(!n){var u=this.width-this.scale*(o.left+o.right);p+="max-width:"+u+"px;";if(!s){if(i%3===1){p+="margin-left:"+this.scale*o.left+"px;"}if(i%3===0){p+="margin-right:"+this.scale*o.right+"px;"}if(f>this.width-this.scale*(o.left+o.right)){p+="margin-left:"+this.scale*o.left+"px;";p+="margin-right:"+this.scale*o.right+"px;"}}}p+="width:"+f+"px;height:"+v+"px;left:"+h+"px;top:"+c+"px;";return p}function nt(t){var e=et.call(this,t);h(t,{$div:e});this._.$stage.appendChild(e);var a=e.getBoundingClientRect();var r=a.width;var i=a.height;h(t,{width:r,height:i});h(t,rt.call(this,t));e.style.cssText=it.call(this,t);G(t);R.call(this,t);return t}function st(){var t=this;var e=this.video.currentTime;for(var a=this._.stagings.length-1;a>=0;a--){var r=t._.stagings[a];var i=r.end;if(r.effect&&/scroll/.test(r.effect.name)){var n=r.effect;var s=n.y1;var o=n.y2;var l=n.delay;var f=((o||t._.resampledRes.height)-s)/(1e3/l);i=Math.min(i,r.start+f)}if(i<e){t._.$stage.removeChild(r.$div);if(r.$clipPath){t._.$defs.removeChild(r.$clipPath)}t._.stagings.splice(a,1)}}var v=this.dialogues;while(this._.index<v.length&&e>=v[this._.index].start){if(e<v[t._.index].end){var h=nt.call(t,v[t._.index]);t._.stagings.push(h)}++t._.index}}function ot(){var t=this;var e=function(){st.call(t);t._.requestId=k(e)};this._.requestId=k(e);this._.$stage.classList.remove("ASS-animation-paused");return this}function lt(){T(this._.requestId);this._.requestId=0;this._.$stage.classList.add("ASS-animation-paused");return this}function ft(){var t=this;while(this._.$stage.lastChild){t._.$stage.removeChild(t._.$stage.lastChild)}while(this._.$defs.lastChild){t._.$defs.removeChild(t._.$defs.lastChild)}this._.stagings=[];this._.space=[]}function vt(){var t=this.video.currentTime;var e=this.dialogues;ft.call(this);this._.index=function(){var a=0;var r=e.length-1;while(a+1<r&&t>e[r+a>>1].end){a=r+a>>1}if(!a){return 0}for(var i=a;i<r;i++){if(e[i].end>t&&t>=e[i].start||i&&e[i-1].end<t&&t<e[i].start){return i}}return r}();st.call(this)}function ht(){var t=this._.listener;t.play=ot.bind(this);t.pause=lt.bind(this);t.seeking=vt.bind(this);this.video.addEventListener("play",t.play);this.video.addEventListener("pause",t.pause);this.video.addEventListener("seeking",t.seeking)}function ct(){var t=this._.listener;this.video.removeEventListener("play",t.play);this.video.removeEventListener("pause",t.pause);this.video.removeEventListener("seeking",t.seeking);t.play=null;t.pause=null;t.seeking=null}function dt(){var t=this.video.clientWidth;var e=this.video.clientHeight;var a=this.video.videoWidth;var r=this.video.videoHeight;var i=this._.scriptRes.width;var n=this._.scriptRes.height;var s=i;var o=n;var l=Math.min(t/a,e/r);if(this.resampling==="video_width"){o=i/a*r}if(this.resampling==="video_height"){s=n/r*a}this.scale=Math.min(t/s,e/o);if(this.resampling==="script_width"){this.scale=l*(a/s)}if(this.resampling==="script_height"){this.scale=l*(r/o)}this.width=this.scale*s;this.height=this.scale*o;this._.resampledRes={width:s,height:o};this.container.style.cssText="width:"+t+"px;height:"+e+"px;";var f="width:"+this.width+"px;"+"height:"+this.height+"px;"+"top:"+(e-this.height)/2+"px;"+"left:"+(t-this.width)/2+"px;";this._.$stage.style.cssText=f;this._.$svg.style.cssText=f;this._.$svg.setAttributeNS(null,"viewBox","0 0 "+i+" "+n);this._.$animation.innerHTML=Z.call(this);vt.call(this);return this}var pt=".ASS-container,.ASS-stage{position:relative;overflow:hidden}.ASS-container video{position:absolute;top:0;left:0}.ASS-stage{pointer-events:none;position:absolute}.ASS-dialogue{font-size:0;position:absolute}.ASS-fix-font-size{position:absolute;visibility:hidden}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}";function ut(t,e,a){if(a===void 0)a={};this.scale=1;this._={index:0,stagings:[],space:[],listener:{},$svg:N("svg"),$defs:N("defs"),$stage:document.createElement("div"),$animation:document.createElement("style")};this._.$svg.appendChild(this._.$defs);this._.$stage.className="ASS-stage ASS-animation-paused";this._.$animation.type="text/css";this._.$animation.className="ASS-animation";document.head.appendChild(this._.$animation);this._.resampling=a.resampling||"video_height";this.container=a.container||document.createElement("div");this.container.classList.add("ASS-container");this.container.appendChild(I);this.container.appendChild(this._.$svg);this._.hasInitContainer=!!a.container;this.video=e;ht.call(this);if(!this._.hasInitContainer){var r=!e.paused;e.parentNode.insertBefore(this.container,e);this.container.appendChild(e);if(r&&e.paused){e.play()}}this.container.appendChild(this._.$stage);var i=M(t);var n=i.info;var s=i.width;var o=i.height;var l=i.dialogues;this.info=n;this._.scriptRes={width:s||e.videoWidth,height:o||e.videoHeight};this.dialogues=l;var f=document.getElementById("ASS-global-style");if(!f){f=document.createElement("style");f.type="text/css";f.id="ASS-global-style";f.appendChild(document.createTextNode(pt));document.head.appendChild(f)}dt.call(this);if(!this.video.paused){vt.call(this);ot.call(this)}return this}function gt(){this._.$stage.style.visibility="visible";return this}function mt(){this._.$stage.style.visibility="hidden";return this}function yt(){var t=this;lt.call(this);ft.call(this);ct.call(this,this._.listener);if(!this._.hasInitContainer){var e=!this.video.paused;this.container.parentNode.insertBefore(this.video,this.container);this.container.parentNode.removeChild(this.container);if(e&&this.video.paused){this.video.play()}}document.head.removeChild(this._.$animation);for(var a in t){if(Object.prototype.hasOwnProperty.call(t,a)){t[a]=null}}return this}var xt=/^(video|script)_(width|height)$/;function wt(){return xt.test(this._.resampling)?this._.resampling:"video_height"}function bt(t){if(t===this._.resampling){return t}if(xt.test(t)){this._.resampling=t;this.resize()}return this._.resampling}var St=function t(e,a,r){if(typeof e!=="string"||!a||a.nodeName!=="VIDEO"){return this}return ut.call(this,e,a,r)};var _t={resampling:{configurable:true}};St.prototype.resize=function t(){return dt.call(this)};St.prototype.show=function t(){return gt.call(this)};St.prototype.hide=function t(){return mt.call(this)};St.prototype.destroy=function t(){return yt.call(this)};_t.resampling.get=function(){return wt.call(this)};_t.resampling.set=function(t){return bt.call(this,t)};Object.defineProperties(St.prototype,_t);return St});